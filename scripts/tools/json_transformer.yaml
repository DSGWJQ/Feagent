# JSON è½¬æ¢å·¥å…·é…ç½®
# ä½¿ç”¨ JavaScript ä»£ç å¤„ç† JSON æ•°æ®

name: json_transformer
description: |
  ä½¿ç”¨ JavaScript ä»£ç è½¬æ¢ JSON æ•°æ®ã€‚
  æ”¯æŒ JSONPath æŸ¥è¯¢ã€æ•°æ®æ˜ å°„ã€è¿‡æ»¤ç­‰æ“ä½œã€‚
  é€‚åˆæ•°æ®é¢„å¤„ç†å’Œæ ¼å¼è½¬æ¢åœºæ™¯ã€‚
category: custom
version: "1.0.0"
author: community
tags:
  - json
  - transform
  - javascript
  - data
icon: "ğŸ”„"
shareable_scope: public

entry:
  type: javascript
  code: |
    /**
     * JSON æ•°æ®è½¬æ¢å‡½æ•°
     * @param {Object} input - è¾“å…¥å¯¹è±¡
     * @param {Object} input.data - è¦è½¬æ¢çš„ JSON æ•°æ®
     * @param {string} input.path - JSONPath è¡¨è¾¾å¼ï¼ˆå¯é€‰ï¼‰
     * @param {Object} input.mapping - å­—æ®µæ˜ å°„è§„åˆ™ï¼ˆå¯é€‰ï¼‰
     * @returns {Object} è½¬æ¢åçš„æ•°æ®
     */
    function execute(input) {
      const { data, path, mapping } = input;
      let result = data;

      // å¦‚æœæŒ‡å®šäº†è·¯å¾„ï¼Œæå–å­æ•°æ®
      if (path) {
        result = extractByPath(result, path);
      }

      // å¦‚æœæŒ‡å®šäº†æ˜ å°„è§„åˆ™ï¼Œæ‰§è¡Œæ˜ å°„
      if (mapping && typeof mapping === 'object') {
        result = applyMapping(result, mapping);
      }

      return { result, success: true };
    }

    function extractByPath(obj, path) {
      const keys = path.replace(/^\$\.?/, '').split('.');
      return keys.reduce((acc, key) => {
        if (acc && key) {
          // æ”¯æŒæ•°ç»„ç´¢å¼• [0]
          const match = key.match(/^(\w+)\[(\d+)\]$/);
          if (match) {
            return acc[match[1]]?.[parseInt(match[2])];
          }
          return acc[key];
        }
        return acc;
      }, obj);
    }

    function applyMapping(data, mapping) {
      if (Array.isArray(data)) {
        return data.map(item => applyMapping(item, mapping));
      }
      const result = {};
      for (const [newKey, sourcePath] of Object.entries(mapping)) {
        result[newKey] = extractByPath(data, sourcePath);
      }
      return result;
    }

parameters:
  - name: data
    type: object
    description: è¦è½¬æ¢çš„ JSON æ•°æ®
    required: true

  - name: path
    type: string
    description: |
      JSONPath è¡¨è¾¾å¼ï¼Œç”¨äºæå–å­æ•°æ®ã€‚
      ç¤ºä¾‹: "$.users[0].name" æˆ– "items"
    required: false

  - name: mapping
    type: object
    description: |
      å­—æ®µæ˜ å°„è§„åˆ™ï¼Œé”®ä¸ºæ–°å­—æ®µåï¼Œå€¼ä¸ºæºè·¯å¾„ã€‚
      ç¤ºä¾‹: {"userName": "name", "userAge": "profile.age"}
    required: false

returns:
  result:
    type: any
    description: è½¬æ¢åçš„æ•°æ®
  success:
    type: boolean
    description: æ˜¯å¦è½¬æ¢æˆåŠŸ
