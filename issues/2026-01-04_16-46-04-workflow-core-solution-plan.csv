id,priority,phase,area,title,description,acceptance_criteria,test_mcp,review_initial_requirements,review_regression_requirements,dev_state,review_initial_state,review_regression_state,git_state,owner,refs,notes
WFCORE-010,P0,1,both,冻结合同与入口治理（创建/修改/执行边界合同）,治理 workflow 创建入口与对外契约：产品流量仅 chat-create；修改保持双链路；执行强制 run_id；并明确 DDD 守门规则。,A1/A2：除 `POST /api/workflows/chat-create/stream` 外，对产品流量不可达的创建入口默认返回 403/410（feature flag OFF + 权限校验 + 审计日志）；chat-create 的 ≤1 条 SSE 事件内包含 `metadata.workflow_id`，创建失败必须清理残留 workflow；B1：PATCH 与 chat 修改落库前都调用同一 `WorkflowSaveValidator` 且 fail-closed；J2：监督/策略链不在 Interface 层重复实现（仅 Application policy chain）。,AUTOSERVER,保持 API 契约兼容（状态码/字段）；feature flag 默认 fail-closed；所有拒绝路径写审计日志（含 source/user_id/workflow_id）；路由层仅做 DTO/协议输出（不做业务编排）。,回归：chat-create/drag-save/chat-save/chat-stream/execute-stream 全链路基本用例；确认内部创建入口不可被前端产品路径调用；检查 403/410 错误结构一致且不泄露内部细节。,已完成,已完成,已完成,已提交,,plan/2026-01-04_11-54-26-workflow-core-solution-plan.md:27;plan/2026-01-04_11-54-26-workflow-core-solution-plan.md:79;src/interfaces/api/routes/workflows.py:530;src/interfaces/api/routes/workflows.py:1006;src/interfaces/api/routes/workflows.py:1056;src/interfaces/api/routes/workflows.py:354;src/domain/services/workflow_save_validator.py:59;.import-linter.toml:1;docs/reports/workflow_core_audit_2026-01-04.md:1,picked_reason:P0 基础契约与入口治理先行，能为后续 run/执行链路收敛解阻塞;done_at:2026-01-04;evidence:pytest tests/integration/api/workflows/test_route_guardrails.py;pytest tests/integration/api/workflow_chat/test_chat_create_stream_api.py;risk:low 接口层仅移除重复 CoordinatorPolicyChain；审计日志补齐 workflow_id=None
WFCORE-020,P0,2,both,Run 事实源一致性闭环（幂等/gate/终态唯一/回放）,收敛 run 的创建、执行门禁、终态落库与回放顺序，保证“点击 Run 的结论可回放且终态可靠”。,2.1：Run create 支持幂等（Idempotency-Key 或等价机制），重复请求不产生重复 Run；2.2：execute/stream 缺 run_id 返回 400；run_id 不存在/不归属/状态不可执行返回 409 且结构化错误；2.3：RunEvent 终态事件唯一（不重复/不乱序），回放不出现重复 terminal；2.4：断连/取消/超时不会导致 Run 长期停留 RUNNING；2.5/G3：`GET /api/runs/{run_id}/events` 顺序稳定（cursor 分页），事件不重复、不乱序；刷新后前端可复原同一结论。,AUTOE2E,并发与幂等：重复点击/网络重试不会产生多次执行；事件录制路径只能有一个权威写入点；错误返回需结构化且可追踪 trace_id/run_id。,回归：断网/断连/取消等故障注入；RunEvent 回放分页与顺序稳定性；前端 Replay Stop/Replay 行为与后端事件一致；确保无外网依赖（mock LLM）。,已完成,已完成,已完成,已提交,,plan/2026-01-04_11-54-26-workflow-core-solution-plan.md:36;plan/2026-01-04_11-54-26-workflow-core-solution-plan.md:104;src/interfaces/api/routes/runs.py:238;src/interfaces/api/routes/workflows.py:412;src/application/services/workflow_run_execution_entry.py:316;src/application/services/workflow_run_execution_entry.py:356;src/application/services/async_run_event_recorder.py:256;docs/reports/workflow_core_audit_2026-01-04.md:1,picked_reason:P0 跑通 Run 事实源与回放契约，能直接支撑 execute/stream 与前端 replay;done_at:2026-01-04;evidence:pytest tests/integration/api/runs/test_run_events_replay_api.py;pytest tests/integration/api/workflows/test_run_event_persistence.py;risk:medium 终态事件跨类型去重为 best-effort（无 DB 唯一约束）；execute/stream 409 改为结构化错误
WFCORE-030,P0,3,backend,执行链路唯一化并与 WorkflowAgent 同源（含调度旁路收敛）,把 REST execute/stream 与 WorkflowAgent execute_workflow 收敛到同一权威执行入口（run 门禁/状态机/事件/成功判定一致），并消除调度器绕过路径。,C1：REST execute/stream 与 WorkflowAgent 执行必须复用同一权威入口（`WorkflowRunExecutionEntry` 或等价）；C2：相同 workflow_id+run_id+input_data 两入口产出事件类型集合一致（node_*、workflow_*），终态一致且 Run.status 一致；调度/后台执行不得绕过 run gate 与 Coordinator gate（不存在直通 `WorkflowExecutionFacade` 的可执行旁路）。,AUTOSERVER,保持 SSE 事件结构与字段（run_id/workflow_id/executor_id）稳定；所有执行触发点都必须在写入任何副作用前完成 gate；对旁路执行加审计/开关。,回归：REST 与 WorkflowAgent 执行对比（事件序列、终态、run 状态）；调度触发与点击 Run 的一致性；并发执行与取消路径不引入重复终态。,已完成,已完成,已完成,已提交,,plan/2026-01-04_11-54-26-workflow-core-solution-plan.md:43;plan/2026-01-04_11-54-26-workflow-core-solution-plan.md:87;src/interfaces/api/routes/workflows.py:412;src/application/services/workflow_run_execution_entry.py:27;src/domain/agents/workflow_agent.py:2390;src/interfaces/api/services/workflow_executor_adapter.py:27;docs/reports/workflow_core_audit_2026-01-04.md:1,picked_reason:P0 执行同源是后续审计/回放/调度一致性的根基;done_at:2026-01-04;evidence:pytest tests/integration/api/workflows/test_workflow_agent_execution_kernel_unification.py;pytest tests/integration/api/workflow_chat/test_workflow_execution_integration.py;risk:medium 调度执行在 run_persistence=true 下要求 workflow.project_id 存在；rollback 模式仍可走 legacy facade
WFCORE-040,P0,4,backend,workflow 默认 LangGraph 执行 + 回滚同构（事件契约一致）,默认执行引擎强制走 LangGraph；保留紧急回滚开关并记录审计；确保 LangGraph 与回滚路径对外事件契约同构。,H1：默认配置下 workflow 执行必须走 LangGraph adapter；关闭开关仅紧急使用且记录 actor/scope/reason 审计；H2：LangGraph 与回滚路径对外事件契约完全一致（至少包含 node_* 与 workflow_*；并携带 run_id/workflow_id/executor_id）；4.2：事件字段对齐 SSE/回放（前端解析不需要分支）。,AUTOSERVER,feature flag 语义清晰且 fail-closed；回滚审计只记录一次且可追踪；不要引入外网依赖到默认执行路径。,回归：开关 ON/OFF 两路径输出事件契约一致；正常/异常/节点失败均能产生终态；性能与事件量不过载（有上限或分页）。,未开始,未开始,未开始,未提交,,plan/2026-01-04_11-54-26-workflow-core-solution-plan.md:48;plan/2026-01-04_11-54-26-workflow-core-solution-plan.md:109;src/config.py:141;src/application/services/workflow_execution_facade.py:57;src/infrastructure/lc_adapters/workflow/langgraph_workflow_executor.py:1;docs/reports/workflow_core_audit_2026-01-04.md:1,
WFCORE-050,P0,5,both,Tool/Node 统一可执行 + chat 工具识别稳定（tool_id 权威）,确保 tool 节点可保存、可执行、可被 chat 修改正确引用：tool_id 为唯一引用；tool executor 注册到 NodeExecutorRegistry；chat 修改只输出 tool_id（禁 name-based）。,D1：tool 节点落库必须包含 config.tool_id（兼容 toolId 输入但持久化归一化）；D2：chat 修改生成工具引用必须是 tool_id（禁止 name-based），工具重命名不影响引用；D3：包含 tool 节点的 workflow 在 LangGraph 执行路径可跑通；5.1：NodeExecutorRegistry 注册 tool executor；5.2：chat 修改提示词/候选列表机制保证稳定输出 tool_id；（补充）chat 修改新增 tool 节点时，前端能识别并展示 tool_id，保存后再加载不丢失引用。,AUTOE2E,工具候选列表只包含 id/name/category/description（不泄露实现配置）；保存校验对非法 tool_id/tool deprecated fail-closed；前后端字段归一化（toolId→tool_id）无兼容回归。,回归：tool 节点保存/加载/执行；tool 被废弃后保存与执行均拒绝；对话修改链路产出 tool_id 且保存通过；无外网依赖（mock 工具实现）。,未开始,未开始,未开始,未提交,,plan/2026-01-04_11-54-26-workflow-core-solution-plan.md:53;plan/2026-01-04_11-54-26-workflow-core-solution-plan.md:91;src/domain/services/workflow_save_validator.py:44;src/domain/services/workflow_save_validator.py:194;src/infrastructure/executors/__init__.py:114;web/src/features/workflows/components/NodeConfigPanel.tsx:325;src/domain/services/workflow_chat_service_enhanced.py:260;docs/reports/workflow_core_audit_2026-01-04.md:1,
WFCORE-060,P0,6,both,Coordinator 核心监督闭环（不可绕过，workflow_edit/tool_call/execute/turn）,将监督点统一下沉到 Application policy chain：对话 turn、workflow 修改、workflow 执行、tool_call 都必须产生可审计的 DecisionValidated/Rejected；被拒绝 fail-closed 且无副作用。,E1：对话入口/修改入口/执行入口均产出可审计的 DecisionValidated/DecisionRejected 事件；E2：tool_call 在执行前可被 Coordinator 拦截（fail-closed），拒绝返回结构化 403 且不落库/不改状态；6.3：禁止 Interface 层临时 new CoordinatorPolicyChain 形成重复语义（统一 Application 层）；（补充）workflow chat 修改的监督 decision_type 必须稳定可枚举（例如 workflow_edit），不得由 LLM 自由字符串决定。,AUTOE2E,拒绝路径必须无副作用（数据库事务回滚、run 状态不变、无终态事件写入）；decision payload 避免敏感信息泄露（不传 message 明文/输入体）；source/correlation_id/original_decision_id 可追踪。,回归：coordinator/event_bus 缺失时关键入口 fail-closed；tool_call/execute/modify 的拒绝不产生 run events/状态变化；审计日志与事件一致；无接口层重复 gate。,未开始,未开始,未开始,未提交,,plan/2026-01-04_11-54-26-workflow-core-solution-plan.md:58;plan/2026-01-04_11-54-26-workflow-core-solution-plan.md:96;src/application/services/coordinator_policy_chain.py:48;src/interfaces/api/routes/workflows.py:733;src/interfaces/api/routes/workflows.py:822;src/application/services/conversation_turn_orchestrator.py:262;src/application/services/workflow_execution_orchestrator.py:260;docs/reports/workflow_core_audit_2026-01-04.md:1,
WFCORE-070,P1,7,both,严格 ReAct + 计划互验（Observation 真实且可回放，执行失败触发 replan）,为 ConversationAgent 注入真实 tool_call_executor 并把 observation 与 run 关联；WorkflowAgent 在执行前验证计划可达性，失败触发 replanning 并记录原因。,F1：每个 Action 都有对应 Observation（tool_result 或 error），且 observation 来自真实执行；F2：tool_call/tool_result 可与 run 关联并可回放复现；I1：WorkflowAgent 执行前验证计划可达性（tool_id/executor/run 门禁/资源约束）；I2：验证失败触发 replanning 且可审计（错误码+原因）；（补充）对话侧能消费该反馈进入下一轮规划，避免“自说自话”。,AUTOE2E,tool_call_executor 需离线可跑（默认内置或 mock）；run/planning/execution 事件 channel 清晰；replan 反馈结构化且不泄露敏感输入。,回归：工具执行失败、门禁拒绝、缺 tool_id/executor 时的 replan 流程；ReAct 循环不会无限迭代（max_iterations/timeout）；事件回放能复现同一结论。,已完成,已完成,已完成,已提交,,plan/2026-01-04_11-54-26-workflow-core-solution-plan.md:63;plan/2026-01-04_11-54-26-workflow-core-solution-plan.md:113;src/domain/agents/conversation_agent_react_core.py:436;src/application/services/tool_call_executor.py:57;src/domain/agents/workflow_agent.py:2390;docs/reports/workflow_core_audit_2026-01-04.md:1,picked_reason:P1 保障 ReAct/工具执行可追溯与可回放，降低“幻觉执行”风险;done_at:2026-01-04;evidence:pytest tests/integration/api/test_conversation_stream_api.py (pass);pytest tests/integration/api/conversation/test_stream_uses_orchestrator.py (pass)
WFCORE-080,P1,8,both,DDD 合规与离线验收测试集（持续验证10条不变式）,修复关键链路越界并用 import-linter 在 CI 阻断回归；补齐离线可跑的自动化测试，覆盖 run/执行同源/langgraph/tool/coordinator。,8.1/J1：CI 启用 import-linter 并阻断新增越界（至少包含 Domain→Interfaces/Infrastructure，且补充禁止 Domain→Application 的合同）；J2：监督/策略链统一在 Application；8.2：新增/补齐离线可跑测试：Run 幂等+gate+终态唯一+断连收敛+回放顺序；REST vs WorkflowAgent 事件/成功判定一致；LangGraph 正常/异常覆盖且回滚不改契约；Tool 节点保存/执行与 chat tool_id 输出；Coordinator 拦截无副作用。,AUTOSERVER,测试必须不依赖外网（mock LLM/工具）；为关键契约加断言（状态码、错误结构、事件字段、顺序）；import-linter 合同变更需解释与文档同步。,全量回归：pytest+关键集成测试；前端最小回归（run 创建失败不触发 execute/stream、SSE 解析）；必要时增加 AUTOE2E 跑一次联调链路。,未开始,未开始,未开始,未提交,,plan/2026-01-04_11-54-26-workflow-core-solution-plan.md:68;plan/2026-01-04_11-54-26-workflow-core-solution-plan.md:117;.import-linter.toml:1;tests/integration/api/workflows/test_run_event_persistence.py:1;web/src/features/workflows/pages/__tests__/WorkflowRunFailClosed.test.tsx:1;docs/reports/workflow_core_audit_2026-01-04.md:1,
