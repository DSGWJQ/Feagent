"id","priority","phase","area","title","description","acceptance_criteria","test_mcp","review_initial_requirements","review_regression_requirements","dev_state","review_initial_state","review_regression_state","git_state","owner","refs","notes"
"WF-000","P0","0","backend","止血：Conversation SSE 接线 Coordinator middleware","修复 ConversationAgent 工厂依赖注入并把 Coordinator middleware 接入同一 EventBus，确保 /api/conversation/stream 主链路可跑且可观测。","本地启动后调用 /api/conversation/stream（SSE）不崩溃；SSE/日志中可观察到 Decision 事件经过 coordinator middleware 的 allow/deny（含可追踪 ID）；当 coordinator 拒绝时，客户端收到明确的拒绝/纠偏事件或错误响应（与现有契约一致）。","AUTOSERVER","确认 composition root 只在一处注册 middleware（避免重复挂载）；依赖注入缺失时给出明确错误与降级路径；新增日志不泄露敏感信息且包含 correlation id。","回归验证：对话 SSE 在允许/拒绝两种策略下事件序列稳定；无重复事件；启动/关闭流程无资源泄漏；相关集成测试可离线跑（LLM 调用需 mock）。","已完成","已完成","已完成","已提交","","plan/2026-01-02_21-54-47-report-md-plan.md:17; src/application/services/conversation_agent_factory.py:16; src/domain/agents/coordinator_agent.py:2152; src/domain/services/agent_orchestrator.py:133; src/interfaces/api/main.py:227; src/interfaces/api/services/event_bus_sse_bridge.py:13; src/application/services/conversation_turn_orchestrator.py:120; src/domain/agents/conversation_agent_react_core.py:414; src/domain/agents/coordinator_agent.py:2184; src/application/services/conversation_agent_factory.py:27","picked_reason:P0 phase0 unblock conversation SSE;done_at:2026-01-02;evidence:in-process SSE test produced coordinator allow (hello) and COORDINATOR_REJECTED (deny);manual_test: start server and POST /conversation/stream message=hello -> expect observation allow;manual_test: POST /conversation/stream message=deny -> expect error COORDINATOR_REJECTED;blocked:git add/commit failed Permission denied creating .git/index.lock (repo ACL denies write);evidence:git still cannot create .git/index.lock;evidence:cannot write .git/objects (ACL deny);blocked:need admin remove Deny ACL for SID S-1-5-21-3196897760-2208572329-2500827249-2462804196 under .git;evidence:icacls shows DENY still present on .git/.git\index/.git\objects for SID S-1-5-21-3196897760-2208572329-2500827249-2462804196;unblocked_at:2026-01-02;blocked:git commit failed pre-commit (pyright/type);unblocked:pre-commit(pyright) fixed"
"WF-010","P0","1","backend","收敛：Workflow 执行内核唯一化并产出 ADR","明确并落地唯一权威的 workflow 执行路径，冻结/删除分叉调用点，确保同一 workflow_id 的执行状态与事件语义只有一个来源。","仓库中新增/更新 ADR 明确选择方案 A 或 B，并列出被删除/冻结的调用点清单；同一 workflow_id 执行时日志/事件中只出现一个执行器标识；不存在“双内核并行执行”导致的重复事件/状态分叉。","AUTOSERVER","优先 KISS：先做“唯一入口”再做性能/重构；所有分叉调用点处理要可追溯（ADR/refs）；保持 API 契约不破坏，必要时用 feature flag 保护切换。","回归验证：拖拽修改/对话修改后的 workflow 均可执行；事件字段/顺序与前端解析兼容；并发执行同一 workflow_id 时无竞态导致的双写/重复发布。","已完成","已完成","已完成","已提交","","plan/2026-01-02_21-54-47-report-md-plan.md:22; Report.md:1; src/interfaces/api/routes/workflows.py:332; docs/architecture/workflow_execution_kernel_adr.md:1; src/application/use_cases/execute_workflow.py:23; src/domain/agents/workflow_agent.py:2288","picked_reason:P0 unify workflow execution single source of truth;done_at:2026-01-02;evidence:python inline test shows executor_id=workflow_engine_v1 + ruff/pyright passed;manual_test: POST /api/workflows/{workflow_id}/execute (sync) and /execute/stream (SSE) -> expect executor_id=workflow_engine_v1;risk:low additive field + froze WorkflowAgent execute_workflow decision path"
"WF-020","P0","2","both","Run 一致性：前端 Run 与后端事实同真源","对齐“用户点击 Run”与“执行成功”的真源：补齐 runs 落库链路或移除 run 概念，杜绝前端展示与后端事实脱钩。","在 ADR/设计说明中明确选择方案 A 或 B；若 A：实现 POST /api/projects/{project_id}/workflows/{workflow_id}/runs 且 execute/stream 关联并持久化 run_id（含幂等）；前端展示 run_id 可通过后端查询一致验证。若 B：前端不再创建/展示 run_id，执行状态仅以 SSE 事件为准，且不会出现“前端显示成功但后端无记录”的误导。","AUTOE2E","先确认产品口径与数据模型边界（run 的生命周期/幂等键/回放）；前后端契约变更要同步更新类型与 SSE 解析；失败路径需可诊断（错误码/日志）。","回归验证：多次点击 Run 的幂等/重复执行行为符合口径；断线重连后 run/事件可恢复；旧 run 查询接口（GET runs）行为不被破坏或有明确 deprecation。","已完成","已完成","已完成","已提交","","plan/2026-01-02_21-54-47-report-md-plan.md:30; src/interfaces/api/routes/runs.py:71; web/src/features/workflows/pages/WorkflowEditorPageWithMutex.tsx:884; docs/architecture/run_consistency_adr.md:1; src/interfaces/api/routes/runs.py:121; src/interfaces/api/routes/workflows.py:319; src/interfaces/api/routes/workflows.py:399; src/application/use_cases/append_run_event.py:140; src/domain/entities/run.py:83; src/infrastructure/database/repositories/run_event_repository.py:18; src/infrastructure/database/transaction_manager.py:10","picked_reason:P0 run_id is user-visible but not source-of-truth; align FE+BE;done_at:2026-01-03;evidence:python DB test created run+events and status transitioned to completed;validation_limited:web npm test fails (vitest/vite config load) spawn EPERM;manual_test: POST /api/projects/{project_id}/workflows/{workflow_id}/runs (Idempotency-Key) -> get run_id; then POST /api/workflows/{workflow_id}/execute/stream body {initial_input, run_id}; then GET /api/runs/{run_id} expect status completed/failed;risk:medium new endpoints + async event persistence; best-effort recording"
"WF-030","P0","3","backend","Tool/Node 统一：保存前强校验可执行性","建立单一 ToolRegistry/CapabilityRegistry 与 node→executor/tool_id 映射，并在 workflow 修改落库前做强校验，避免“保存成功但必然执行失败”。","workflow 保存/更新时强制校验：executor 存在、tool_id 可用、图无环、边引用正确；对不合法 workflow 返回明确的 4xx 与可定位错误信息；缺失 executor 的策略明确（实现/禁用/降级）且不会在运行时走到隐式 NotImplemented。","AUTOSERVER","校验逻辑单一职责（复用同一 validator，避免两条修改链路各写一套）；错误信息对前端友好且不泄露内部细节；为新增 registry/validator 补充单测。","回归验证：拖拽修改与对话修改两条链路的保存结果一致；历史存量 workflow 的兼容策略明确（迁移/宽松校验/feature flag）；执行路径不因新增校验产生性能退化（至少记录校验耗时）。","已完成","已完成","已完成","已提交","","plan/2026-01-02_21-54-47-report-md-plan.md:38; src/interfaces/api/routes/workflows.py:281; src/interfaces/api/routes/chat_workflows.py:25; src/domain/services/workflow_save_validator.py:54; src/application/use_cases/update_workflow_by_drag.py:116; src/application/use_cases/update_workflow_by_chat.py:132; src/interfaces/api/routes/workflows.py:313","picked_reason:P0 prevent save-success execute-fail by strong validation;done_at:2026-01-03;evidence:added WorkflowSaveValidator + DomainValidationError to enforce save-time executability checks;evidence:pytest -o addopts= ran targeted unit tests for validator + drag/chat use cases;validation_limited:default pytest addopts uses --cov and cannot delete .coverage (Permission denied); used -o addopts= workaround;manual_test: PATCH /api/workflows/{workflow_id} with cyclic edges -> 400 detail.code=workflow_invalid (cycle_detected);manual_test: PATCH /api/workflows/{workflow_id} with node.type=tool and missing tool_id -> 400 detail.code=workflow_invalid (missing_tool_id);risk:medium save-time validation may reject previously accepted invalid workflows"
"WF-040","P1","4","both","ReAct 严格化：Thought→Action→Observation 闭环可监督","统一 Action/Decision schema 并打通工具调用反馈，确保 SSE 中的 tool_call 与 tool_result 可配对且可审计，并由 Coordinator 监督危险决策。","SSE 事件中可观察到成对的 tool_call 与对应 tool_result（含可审计 ID）；/workflows/{id}/chat-stream-react 的事件字段映射正确且前端可稳定解析；当 coordinator 判定危险时可拒绝并产生纠偏事件，且不会导致 SSE 崩溃/卡死。","AUTOE2E","Action/Decision 使用 Pydantic 严格校验并保持向后兼容（字段新增优先 optional）；工具系统选型后避免双栈并存；对失败/超时/取消等状态有明确事件语义。","回归验证：常见工具调用（成功/失败/超时）均能产生 Observation；断线重连后事件序列可恢复；Coordinator 拒绝策略不会误伤正常路径（含白名单/阈值可配置）。","已完成","已完成","已完成","已提交","","plan/2026-01-02_21-54-47-report-md-plan.md:47; src/domain/agents/coordinator_agent.py:2152; src/interfaces/api/routes/workflows.py:332; src/interfaces/api/routes/workflows.py:726; src/interfaces/api/routes/workflows.py:71; src/application/use_cases/update_workflow_by_chat.py:204; tests/integration/api/workflow_chat/test_chat_stream_react_api.py:291","picked_reason:P1 fix chat-stream-react schema mismatch + pair tool_call/tool_result;done_at:2026-01-03;evidence:chat-stream-react now maps react_step -> (thinking/tool_call/tool_result) with stable tool_id pairing + pydantic validation;evidence:UpdateWorkflowByChatUseCase.execute_streaming now emits tool_id for each react_step;evidence:pytest -o addopts= ran integration test for chat-stream-react event types + pairing;validation_limited:AUTOE2E not run here; web tests previously blocked by spawn EPERM;manual_test: POST /api/workflows/{id}/chat-stream-react -> verify tool_call.metadata.tool_id pairs with tool_result.metadata.tool_id;manual_test: if action.type in {create_node,file_operation,api_request,human_interaction} and coordinator rejects -> SSE emits COORDINATOR_REJECTED and completes;risk:medium SSE event payload semantics changed (bugfix); ensure frontend parses StepKind events"
"WF-050","P1","5","backend","LangGraph 对齐：明确用/不用并清除 NotImplemented 路径","消除“宣称注入 LangGraph 但运行时 NotImplemented”的架构漂移：要么实现 workflow 的 LangGraph executor，要么禁用/删除注入。","在 ADR/配置中明确选择方案 A 或 B；运行时不存在可达的 NotImplemented 路径（包括 adapter 注入/调用）；执行行为与文档一致，且切换（如有）受 feature flag 保护并可回滚。","AUTOSERVER","避免两套 executor 长期并存：定义清晰边界与生命周期；所有注入点可追踪；对错误提示做降级（例如未启用时返回明确 501/feature-disabled）。","回归验证：workflow 执行在启用/禁用 LangGraph 两种配置下都可预期；日志可区分执行器；关键路径单测/集成测试覆盖到“未启用时不可达”。","已完成","已完成","已完成","已提交","","plan/2026-01-02_21-54-47-report-md-plan.md:55; src/infrastructure/lc_adapters/workflow/langgraph_workflow_executor_adapter.py:33; Report.md:1; docs/architecture/langgraph_workflow_execution_adr.md:1; src/interfaces/api/services/workflow_executor_adapter.py:27; src/infrastructure/lc_adapters/workflow/langgraph_workflow_executor_adapter.py:31; src/application/services/workflow_execution_facade.py:20; tests/unit/lc/workflow/test_langgraph_workflow_executor_adapter.py:14","picked_reason:P1 remove reachable NotImplemented and clarify LangGraph usage;done_at:2026-01-03;decision:OptionB disable workflow LangGraph execution; keep WorkflowEngine v1 as single kernel;evidence:removed LangGraphWorkflowExecutorAdapter injection from WorkflowExecutorAdapter; placeholder adapter now raises DomainError feature_disabled (no NotImplemented);evidence:pytest -o addopts= ran unit test for feature_disabled adapter path;validation_limited:default pytest addopts uses --cov and cannot delete .coverage (Permission denied); used -o addopts= workaround;manual_test: call LangGraphWorkflowExecutorAdapter.execute -> raises DomainError feature_disabled (no NotImplemented);risk:low removal of unused injection + clearer error path"
"WF-060","P2","6","backend","DDD 边界修复：依赖方向收敛并通过 import-linter","用 Domain Ports + Infrastructure Adapters 替换越界 import，收敛依赖方向，控制重构爆炸半径。","`.import-linter.toml` 约束下的违规 import 数量降为 0（或按 ADR 明确允许清单）；关键模块可独立运行单测；接口层/应用层/领域层依赖方向符合 DDD_BOUNDARY_REVIEW_CHECKLIST。","AUTOSERVER","分批小步：每次只处理一个 bounded context/模块；避免大规模移动文件导致无意义 diff；为每个 port 定义清晰接口并补单测。","回归验证：import-linter/等价检查在 CI 可复现；核心 API 路由仍可跑通；对外行为不变（或有变更说明与迁移策略）。","未开始","未开始","未开始","未提交","","plan/2026-01-02_21-54-47-report-md-plan.md:62; .import-linter.toml:1; docs/architecture/DDD_BOUNDARY_REVIEW_CHECKLIST.md:1",""
"WF-070","P1","7","both","测试与回归：核心链路用例级保障","为 chat-create/chat-stream/execute/stream/Coordinator 拦截与前端 Run 行为建立可离线复现的自动化测试，形成长期回归护栏。","新增/补齐的测试覆盖：chat-create 早期返回 workflow_id、两条修改链路的保存校验、execute/stream 的事件序列、Coordinator allow/deny；前端对 SSE 解析与 Run 契约有 e2e/单测；CI 可离线运行（LLM/外部依赖均 mock）。","AUTOE2E","测试命名与边界清晰（不把实现细节写死）；mock 策略统一且可复用；失败时错误信息可定位到具体链路/事件。","回归验证：同一套测试在 feature flag 开/关下行为可预期；覆盖断线重连/并发/非法输入等边界；避免引入对外网/真实密钥依赖。","未开始","未开始","未开始","未提交","","plan/2026-01-02_21-54-47-report-md-plan.md:69; src/interfaces/api/routes/workflows.py:405; src/interfaces/api/routes/workflows.py:332; web/src/features/workflows/pages/WorkflowEditorPageWithMutex.tsx:884",""
"WF-080","P2","8","both","灰度与回滚：新链路 feature flag 与监控口径","为关键切换点（如 LangGraph executor、Run 落库）增加 feature flag 与可回滚路径，并明确监控指标口径。","关键新链路均可通过 feature flag 一键切回 legacy；legacy endpoint 有兼容期与观测日志（含 deprecation header/日志）；监控指标口径明确且可在日志/指标中观测（至少错误率、P95、拒绝率）。","AUTOE2E","feature flag 默认关闭且不影响现有行为；回滚路径需覆盖数据层（run 记录/事件语义）与 API 层；日志字段稳定便于 dashboard。","回归验证：开关切换不会导致状态污染/双写；在高并发/异常注入下可快速回滚；前端对不同开关状态下的 SSE/Run 行为无崩溃。","未开始","未开始","未开始","未提交","","plan/2026-01-02_21-54-47-report-md-plan.md:76; Report.md:1",""
