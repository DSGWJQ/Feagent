"id","priority","phase","area","title","description","acceptance_criteria","test_mcp","review_initial_requirements","review_regression_requirements","dev_state","review_initial_state","review_regression_state","git_state","owner","refs","notes"
"WFCTRL-010","P0","1","both","基线审计与完整测试口径固化","确认三项能力现状与边界，固化“完整真实测试”命令集与通过标准，并记录当前基线结果。","输出一份可执行的必跑命令清单（后端/前端/校验脚本）；在本机实际跑通：`python scripts/validate_node_definitions.py --strict`、`pnpm -C web type-check`、`pnpm -C web test`（退出码均为 0）；若 `pytest -q` 存在既有收集失败，必须在 notes 中列出阻塞项与与本需求的关系判定。","AUTOE2E","Review：测试口径不允许含糊（必须是命令+退出码）；识别并隔离既有不相关失败，避免把回归误归因到本需求。","回归：重复执行必跑命令清单；确认不会引入新的测试收集失败/超时。","未开始","未开始","未开始","未提交","","plan/2026-01-08_20-42-32-controlflow-chatpatch-templating.md:1;src/domain/services/workflow_engine.py:191;web/vitest.config.ts:1",""
"WFCTRL-020","P0","2","backend","条件分支语义规范化（edge.condition gating）","定义 edge.condition 的求值规则、fail-closed 行为、以及多入边 join 的默认语义，形成可测试的规范。","形成并落盘可验收的语义说明：空条件/None=无条件通过；表达式求值失败=视为 false；支持 `true/false` 与 conditional 输出 `{branch/result}` 的兼容；多入边默认 OR join（任一满足即执行）。文档必须能直接映射到至少 3 条单测用例。","AUTOSERVER","Review：语义必须明确到 truth table；不得引入“隐式 goto/跳转”或破坏 DAG 无环约束。","回归：新增/更新单测覆盖上述 truth table，且与历史行为兼容（无条件边仍能触发执行）。","未开始","未开始","未开始","未提交","","plan/2026-01-08_20-42-32-controlflow-chatpatch-templating.md:43;src/domain/services/workflow_engine.py:191",""
"WFCTRL-030","P0","3","backend","引擎落地：按 edge.condition 跳过节点/过滤 inputs 并打点","在 WorkflowEngine 执行期实现 gating：不满足条件则 node_skipped，且 inputs 只注入满足条件的入边输出。","新增/更新测试验证：1) 分支场景只执行命中的分支节点（未命中分支输出 node_skipped）；2) 条件表达式异常不会误执行（fail-closed）；3) inputs 仅包含满足条件的来源输出；4) `condition==""true""/""false""` 能按 `{branch/result}` 正确路由。所有相关后端测试通过（`pytest -q tests/unit/...` + 对应 integration 用例）。","AUTOSERVER","Review：必须保持无环拓扑排序；条件求值失败必须 fail-closed；事件字段需包含 node_id/node_type/reason 便于排障。","回归：跑一遍带 conditional/loop 的真实 workflow fixture，确认执行日志与预期一致且无性能退化（拓扑排序仍为 O(V+E)）。","已完成","已完成","已完成","已提交","","plan/2026-01-08_20-42-32-controlflow-chatpatch-templating.md:55;src/domain/services/workflow_engine.py:68;src/domain/services/workflow_engine.py:191","picked_reason:P0 核心执行语义（condition gating/inputs 过滤）先落地以解锁后续 templating 与 E2E; started_at:2026-01-08T21:03:52+08:00 | done_at:2026-01-08T21:20:01+08:00; evidence:pytest -q tests/unit/domain/services/test_workflow_executor.py tests/integration/test_workflow_condition_gating.py (pass) | blocked:git commit hook(ruf/format) at:2026-01-08T21:23:25+08:00; action:fix lint+restage+retry | git_committed_at:2026-01-08T21:24:53+08:00"
"WFCTRL-040","P0","4","backend","对话增量编辑：支持 nodes_to_update / edges_to_update（config_patch 优先）","让对话 agent 能用 update/patch 修改节点 config 与边 condition，避免必须 delete+add 才能改配置。","后端单测验证：1) nodes_to_update.config_patch 只覆盖指定字段且保留未提及字段；2) nodes_to_update.config 可整体替换（仅在明确需要时）；3) edges_to_update.condition 可更新/清空；4) 仍强制仅允许操作 start->end 主子图（越界返回结构化拒绝）。","AUTOSERVER","Review：限制可更新字段（name/position/config/condition），禁止通过 update 改 type；所有拒绝必须返回可机器解析的 errors 列表。","回归：用真实 chat 修改一次 http.url + edge.condition，并确保保存校验与执行均生效。","已完成","已完成","已完成","已提交","","plan/2026-01-08_20-42-32-controlflow-chatpatch-templating.md:66;src/domain/services/workflow_chat_service_enhanced.py:910","picked_reason:P0 对话增量编辑 update/patch 解除删旧加新限制; started_at:2026-01-08T21:26:05+08:00 | done_at:2026-01-08T21:28:54+08:00; evidence:pytest -q tests/unit/domain/services/test_workflow_chat_service_enhanced_modifications.py (pass); blocked:git commit 未完成（pre-commit ruff UP038 已修复，待补回归测试后提交）; evidence:pytest -q tests/unit/domain/services/test_workflow_chat_service_enhanced_modifications.py tests/integration/test_workflow_chat_incremental_update.py (pass); done_at:2026-01-08T21:55:00+08:00"
"WFCTRL-050","P0","5","backend","通用配置模板化：执行前渲染 node.config 字符串占位符","支持在 http/file/db 等节点 config 中引用上游输出与 initial_input/context，稳定实现“动态拼 URL 再请求”。","实现并测试：1) 对 dict/list 递归渲染；2) string 占位符支持 `{input1.xxx}`、`{initial_input.xxx}`、`{context.xxx}`、数组下标（如 `{input1.items[0].id}`）；3) 路径不存在时保持原样（fail-soft）；4) 不执行表达式，仅做替换。集成用例验证：python/transform 产出 userId，httpRequest.url 使用占位符后真实发起请求（用 stub httpx）且 URL 被正确渲染。","AUTOSERVER","Review：模板渲染必须发生在 executor 之前；不允许引入任意代码执行；日志需可定位未解析占位符（至少 debug/warn）。","回归：覆盖 http headers/body、file.path/content、db.sql/params 的渲染场景，并确认不会破坏已有节点默认行为。","未开始","未开始","未开始","未提交","","plan/2026-01-08_20-42-32-controlflow-chatpatch-templating.md:78;src/domain/services/workflow_engine.py:331;src/infrastructure/executors/http_executor.py:1;src/infrastructure/executors/file_executor.py:1;src/infrastructure/executors/database_executor.py:1",""
"WFCTRL-060","P1","6","both","定义并实现三类真实端到端场景（A/B/C）","把“动态 URL→HTTP”“条件分支只跑一边”“对话 update 改配置”三类场景做成可重复的集成用例与演示路径。","新增/更新 integration 测试：A) 变量渲染后 HTTP 请求命中预期 URL；B) true/false 分支仅执行一边且另一边 node_skipped；C) chat update 修改 config/condition 后执行结果发生变化且保存校验通过。测试需可在 CI/本机稳定复跑（无网络依赖，均用 stub）。","AUTOE2E","Review：用例必须“可复现+无外部依赖”；断言要覆盖执行日志、跳过语义、以及渲染后的关键字段。","回归：同一套用例在重跑时输出一致（确定性）；异常分支（表达式错误、占位符缺失）也有覆盖。","未开始","未开始","未开始","未提交","","plan/2026-01-08_20-42-32-controlflow-chatpatch-templating.md:89;src/domain/services/workflow_engine.py:191;src/domain/services/workflow_chat_service_enhanced.py:910",""
"WFCTRL-070","P0","8","both","完整真实测试回归与失败分流","按口径跑通后端/前端/校验脚本；若发现既有不相关失败，必须分流并形成阻塞清单。","执行并记录：`python scripts/validate_node_definitions.py --strict`、`pnpm -C web type-check`、`pnpm -C web test` 均为退出码 0；后端至少完成与本需求相关的 unit+integration 全通过。若 `pytest -q` 不能全量通过，必须输出“既有失败列表 + 与本需求无关的证据”，并给出是否需要单独修复的建议。","AUTOE2E","Review：测试失败必须归因；只修复本次改动引入的回归；不得顺手重构引入额外风险。","回归：重复跑一遍口径清单；关键场景 A/B/C 需再次执行确认无漂移。","未开始","未开始","未开始","未提交","","plan/2026-01-08_20-42-32-controlflow-chatpatch-templating.md:115;scripts/validate_node_definitions.py:1;web/package.json:1",""
"WFCTRL-080","P1","9","both","红队复审与文档同步（受保护文档不漂移）","从安全/可维护性角度复审条件表达式与模板渲染的边界，并同步更新相关受保护文档。","完成复审清单：1) 条件表达式必须 safe evaluator + fail-closed；2) 模板渲染仅替换不执行；3) chat update 不可越界主子图；4) 如涉及运行语义/协作链路变化，更新 `docs/技术方案/` 下对应文档并确保与实现一致。","AUTOE2E","Review：检查潜在注入点（SQL/headers/url）；必要时增加保存期校验/提示，降低运行期故障。","回归：在 release 流程中至少进行一次“坏输入”注入测试（表达式非法、占位符缺失），确认系统 fail-safe。","未开始","未开始","未开始","未提交","","plan/2026-01-08_20-42-32-controlflow-chatpatch-templating.md:123;src/domain/services/expression_evaluator.py:1;docs/技术方案/YAML_INTERNAL_UNIFICATION_NODEDTO_RAG_PLAN.md:1",""
