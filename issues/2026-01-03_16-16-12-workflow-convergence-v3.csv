id,priority,phase,area,title,description,acceptance_criteria,test_mcp,review_initial_requirements,review_regression_requirements,dev_state,review_initial_state,review_regression_state,git_state,owner,refs,notes
WFCONV3-000,P0,M0,backend,M0 基线锁定：路由/契约测试护栏,固化允许/禁止路由集合与关键 SSE 契约测试，作为后续删链路与收敛的防回归合同。,新增 T-ROUTE-1：OpenAPI 中 Create/Execute 入口的 deprecated 标记符合不变式（非 deprecated 仅 I-1/I-3；legacy create/execute 若存在必须 deprecated）；并验证 /ws/workflows/{id} websocket 不可达（ws 连接 404/不存在）。新增/补齐 T-SSE-1：chat-create/stream 首事件含 metadata.workflow_id；新增 T-SSE-CHAT-1：chat-stream-react 事件 type 仅允许 thinking/tool_call/tool_result/final/error。,AUTOSERVER,Review 路由护栏测试：断言可证伪且不依赖实现细节（基于 OpenAPI/WS 可达性）；deprecated 标记用于区分 legacy 与目标入口；不新增业务端点/不改变现有行为。Review SSE 护栏：事件 type 白名单与 workflow_id 契约断言清晰。,全量回归时再次运行 T-ROUTE-1/T-SSE-1/T-SSE-CHAT-1；验证 OpenAPI 输出与路由表一致；确认没有“非 deprecated 的新增 Create/Execute 入口”。,已完成,已完成,已完成,已提交,,src/interfaces/api/main.py:332;src/interfaces/api/routes/workflows.py:279;src/interfaces/api/routes/workflows.py:437;tests/integration/api/workflows/test_route_guardrails.py:39;tests/integration/api/workflow_chat/test_chat_create_stream_api.py:96;tests/integration/api/workflow_chat/test_chat_stream_react_api.py:257,picked_reason:M0 作为后续删链路/收敛前置护栏，先锁定路由与关键 SSE 契约以降低回归风险 | done_at:2026-01-03 | evidence:pytest -q tests/integration/api/workflows/test_route_guardrails.py tests/integration/api/workflow_chat/test_chat_create_stream_api.py::TestChatCreateStreamAPI::test_success_includes_workflow_id_in_first_event tests/integration/api/workflow_chat/test_chat_stream_react_api.py::TestChatStreamReactAPI::test_stream_event_types_are_whitelisted (4 passed)
WFCONV3-010,P0,M1,frontend,M1 删除前端 WebSocket 画布同步链路,删除任何 workflow canvas sync 的 WebSocket 客户端代码与入口，防止出现隐式重连/回退到 WS 的逻辑。,"全局检索 `ws/workflows` 为 0；前端不再实例化 WebSocket(""/ws/workflows/"")；补充/更新单测（T-FE-WS-1）证明未创建 WebSocket；构建/测试可运行（或 notes 记录受限验收）。",AUTOFRONTEND,Review 删除范围：仅 canvas sync 链路；不影响拖拽保存与对话修改主路径；确保无隐式重连/兜底逻辑残留。,回归：编辑器页面正常加载；拖拽保存与对话修改仍可用；全局检索 ws/workflows 为 0。,已完成,已完成,已完成,已提交,,web/src:1;web/src/features/workflows/hooks/useCanvasSync.ts:127;web/src/features/workflows/pages/WorkflowEditorPageWithMutex.tsx:42;web/src/features/workflows/pages/__tests__/WorkflowEditorCanvasSync.test.tsx:150;web/src/features/workflows/hooks/__tests__/useCanvasSync.test.ts:109;web/src/features/workflows/e2e/canvas-sync-websocket.test.tsx:15,"picked_reason:后端已移除 canvas sync websocket 路由，优先删前端 WS 链路以消除误用与隐式回退风险 | done_at:2026-01-03 | evidence:rg -n ""ws/workflows|useCanvasSync"" -S web/src (no matches) | evidence:cd web; npm test -- src/features/workflows/pages/__tests__/WorkflowEditorNoWebSocket.test.tsx (1 passed) | manual_test:cd web; npm run dev -> 打开编辑器页，验证拖拽保存与对话修改仍可用 | risk:low 删除已不可达 WS 画布同步链路"
WFCONV3-020,P0,M1,backend,M1 删除后端 WebSocket 路由实现/引用,删除/隔离 canvas sync WebSocket 服务端路由与相关引用，确保不可达且无误用风险。,仓库中不再含 canvas sync websocket 路由文件或其被任何 app.include_router 挂载；静态检索 `/ws/workflows/` 为 0（或仅剩文档/测试明确说明）；相关测试更新。,AUTOSERVER,Review 删除范围与可达性：确保 websocket 端点不可达；删除后不影响其它 websocket（如 /ws/agent）。,回归：OpenAPI 不包含 websocket；关键 API（drag PATCH/chat-stream-react/execute stream）无回归。,已完成,已完成,已完成,已提交,,src/interfaces/api/routes/websocket.py:1;src/interfaces/api/main.py:332;tests/integration/websocket/test_canvas_sync_websocket.py:1;src/infrastructure/websocket/canvas_sync.py:1,picked_reason:后端先移除不可达 websocket 路由与测试，降低误用风险并为前端删链路提供干净基线 | done_at:2026-01-03 | evidence:deleted src/interfaces/api/routes/websocket.py and tests/integration/websocket/test_canvas_sync_websocket.py; pytest -q tests/integration/api/workflows/test_route_guardrails.py::test_t_route_1_canvas_websocket_route_is_unavailable (passed)
WFCONV3-030,P0,M2,backend,M2 DDD 越界清理：ConversationAgent 相关 Domain→Infra,移除 Domain 层对 Infrastructure/Interface 的直接 import（ConversationAgent 相关），通过 Port 注入替代。,src/domain 目录中不存在对 src.infrastructure/src.interfaces 的直接 import（至少覆盖 ConversationAgent 相关模块）；新增/更新静态检查或测试证明边界；保持行为兼容。,AUTOSERVER,Review 只做越界修复（KISS），避免引入新架构；依赖注入位置保持在 Application/Infrastructure。,回归：对话相关用例与 SSE 仍可运行；无循环依赖/导入错误。,已完成,已完成,已完成,已提交,,src/domain/agents/conversation_agent_react_core.py:1;src/domain/agents/conversation_agent_helpers.py:212;src/domain/agents/conversation_agent.py:289;src/domain/ports/model_metadata.py:31,"picked_reason:P0 DDD 越界会放大后续收敛成本，先移除 ConversationAgent 相关 Domain→Infra import | done_at:2026-01-03 | evidence:removed Domain->Infrastructure import in ConversationAgent helpers (fallback uses constant, no infra import) | evidence:pytest -q tests/unit/architecture/test_domain_conversation_agent_no_infra_imports.py (passed) | risk:low 行为保持兼容；未注入 ModelMetadataPort 时仅影响 context_limit 默认值"
WFCONV3-040,P0,M2,backend,M2 DDD 越界清理：WorkflowAgent 相关 Domain→Infra,移除 WorkflowAgent Domain 层对 Infrastructure/Interface 的直接 import，通过 Port 注入替代。,src/domain 目录中不存在对 src.infrastructure/src.interfaces 的直接 import（至少覆盖 WorkflowAgent 相关模块）；静态检查/测试可证明边界；保持执行/规划行为兼容。,AUTOSERVER,Review 变更边界：仅修复越界依赖；避免扩大重构面。,回归：workflow execute/chat 等主链路仍可用；无导入错误。,已完成,已完成,已完成,已提交,,src/domain/agents/workflow_agent.py:1;src/domain/agents/workflow_agent.py:61;tests/unit/domain/agents/test_gap_h03_container_executor_injection.py:1;src/domain/services/sandbox_executor.py:641;tests/unit/architecture/test_domain_workflow_agent_no_infra_imports.py:1;src/infrastructure/executors/__init__.py:1,"picked_reason:P0 移除 WorkflowAgent 内 Domain→Infra import，避免执行/规划路径被基础设施绑定;done_at:2026-01-03;evidence:pytest -q tests/unit/architecture/test_domain_workflow_agent_no_infra_imports.py tests/unit/domain/agents/test_gap_h03_container_executor_injection.py (14 passed);risk:low boundary-only change;preserves lazy-load + container executor interface;evidence_rg:rg -n ""\b(from|import)\s+src\.(infrastructure|interfaces)"" -S src/domain => no matches"
WFCONV3-050,P0,M3,backend,M3 监督统一：Coordinator policy chain + tool_call 纳入监督,将监督收敛为统一入口（policy chain），确保所有副作用 action（尤其 tool_call）先被 Coordinator allow 再执行（fail-closed）。,新增/更新测试 T-SUP-1：coordinator deny -> 事务回滚 + SSE 返回 COORDINATOR_REJECTED 并终止；移除路由层碎片化 validate 分支；行为可观测（日志/事件含 correlation_id）。,AUTOSERVER,Review fail-closed 与事务边界：拒绝不产生副作用；事件命名/错误码统一。,回归：对话修改与执行路径均经过监督；允许路径不变。,已完成,已完成,已完成,已提交,,src/domain/agents/coordinator_agent.py:1;src/interfaces/api/main.py:220;src/application/services/coordinator_policy_chain.py:1;src/interfaces/api/routes/workflows.py:900;tests/integration/api/workflow_chat/test_chat_stream_react_api.py:469,picked_reason:P0 fail-closed 监督统一，确保 tool_call 等副作用动作先被 allow 再执行;done_at:2026-01-03;evidence:pytest -q tests/integration/api/workflow_chat/test_chat_stream_react_api.py::TestChatStreamReactAPI::test_coordinator_rejection_emits_error_rollback_and_completes (passed);risk:low fail-closed supervision extracted; route keeps same rollback/terminate semantics
WFCONV3-060,P0,M4,both,M4 对话修改收敛：仅保留 /chat-stream + 统一 SSE 协议,合并 chat-stream-react 能力到 chat-stream，统一 SSE 协议与监督策略，只保留一个对话修改入口。,OpenAPI 中仅存在 POST /api/workflows/{id}/chat-stream；chat-stream-react 不存在/404；SSE 事件仅 thinking/tool_call/tool_result/final/error；前端不再调用 react 端点。,AUTOE2E,Review 兼容性：保持前端行为与错误处理一致；监督策略不被绕过；避免在路由层堆分支。,回归：对话修改保存校验/事务回滚/监督拒绝可复现；前端调用点为 0。,已完成,已完成,已完成,已提交,,src/interfaces/api/routes/workflows.py:844;web/src:1;src/interfaces/api/main.py:332;tests/integration/api/workflows/test_route_guardrails.py:40;tests/integration/api/workflow_chat/test_chat_stream_react_api.py:146;tests/integration/api/test_sse_disconnect_reconnect.py:407;web/src/features/workflows/api/workflowsApi.ts:91;web/src/features/workflows/e2e/workflow-execution.test.tsx:49,picked_reason:P0 收敛为单一 chat-stream 入口，减少双端点分叉与监督绕过风险;done_at:2026-01-03;evidence:pytest -q tests/integration/api/workflows/test_route_guardrails.py tests/integration/api/workflow_chat/test_chat_stream_react_api.py tests/integration/api/test_sse_disconnect_reconnect.py::TestChatStreamWithEmitter::test_chat_stream_uses_emitter_events (15 passed);evidence_frontend:cd web; npm test -- src/features/workflows/e2e/workflow-execution.test.tsx (3 passed);risk:low endpoint rename/removal; keeps SSE payload schema and supervision behavior
WFCONV3-070,P0,M5,both,M5 创建收敛：删除 legacy create（后端+前端）,删除 POST /api/workflows legacy create 与前端 legacy create 分支，仅保留 chat-create/stream；创建失败需 fail-closed。,OpenAPI 中仅存在 POST /api/workflows/chat-create/stream；不存在 POST /api/workflows；前端无 legacy create 分支；T-SSE-1 保持首事件 workflow_id 契约；失败无半成品数据。,AUTOE2E,Review 删除范围与兼容策略（如需迁移窗口）；fail-closed + 事务回滚证据。,回归：创建->跳转编辑->拖拽保存->执行关键链路仍可跑；旧 workflow 不受影响。,已完成,已完成,已完成,已提交,,src/interfaces/api/routes/workflows.py:240;src/interfaces/api/routes/workflows.py:572;web/src/features/workflows/api/workflowsApi.ts:164;web/src/features/workflows/pages/WorkflowEditorPage.tsx:42;tests/integration/api/workflow_chat/test_chat_create_stream_api.py:180,picked_reason:P0 删除 legacy create，阻断旧入口导致协议分叉与半成品数据风险;done_at:2026-01-03;evidence:pytest chat_create_stream_api + route_guardrails + legacy_create + logging_metrics + oauth(3) + workflows(test_workflows);evidence:vitest WorkflowEditorPage.test.tsx;risk:low removed legacy create entry + added fail-closed cleanup
WFCONV3-080,P0,M6,backend,M6 Run 强一致：执行入口唯一化 + 强制 run_id（后端）,删除非流式 execute；保留 execute/stream 作为唯一执行入口；强制 run_id；关键事件强一致落库。,POST /api/workflows/{id}/execute 不存在/404；execute/stream 缺 run_id 直接拒绝（400/409）；关键事件 start/complete/error 可查询验证不丢；新增 T-RUN-1 覆盖。,AUTOSERVER,Review 关键事件集合有限且明确（KISS）；拒绝路径 fail-closed；不引入无界重试/性能退化。,回归：执行流式事件序列与前端解析兼容；run_id 与 executor_id 可追踪。,已完成,已完成,已完成,已提交,,src/interfaces/api/routes/workflows.py:353;tests/integration/api/workflows/test_run_event_persistence.py:43;tests/integration/api/workflows/test_route_guardrails.py:44;tests/integration/api/workflows/test_workflows.py:356,picked_reason:P0 后端先收敛 execute 入口与 run_id 强制，前端/回归依赖此契约;done_at:2026-01-03;evidence:pytest route_guardrails + execute_uses_orchestrator + run_event_persistence(T-RUN-1) + workflows(test_workflows);risk:medium API breaking remove /execute + require run_id + enforce run ownership
WFCONV3-090,P0,M6,frontend,M6 Run 强一致：Run 创建失败则不执行（前端）,前端 Run UX 与语义一致：Run 创建失败则不调用 execute/stream；禁止“无 run_id 执行”的静默降级。,新增 T-FE-RUN-1：Run 创建失败 -> execute API 不被调用；前端网络行为可验证；必要时给出可操作错误提示。,AUTOFRONTEND,Review 不改变核心交互，仅收敛调用链路；错误提示可操作；避免隐藏失败。,回归：Run 正常路径仍可执行；失败注入下不触发 execute 请求。,已完成,已完成,已完成,已提交,,web/src/features/workflows/pages/WorkflowEditorPageWithMutex.tsx:849;web/src/features/workflows/pages/__tests__/WorkflowRunFailClosed.test.tsx:50;web/src/features/workflows/api/workflowsApi.ts:242,picked_reason:P0 前端执行必须遵守后端 run_id 强制契约，避免无 run_id 的静默降级/脏数据;done_at:2026-01-03;evidence:vitest WorkflowRunFailClosed(T-FE-RUN-1) + WorkflowEditorNoWebSocket + workflow-execution(e2e);risk:low prevent silent execute without run_id
WFCONV3-100,P1,M7,backend,M7 执行内核单一权威：Kernel Port + LangGraph（后端）,定义并落地 WorkflowExecutionKernelPort；API 与 WorkflowAgent 执行路径只依赖该 port；LangGraph 作为实现并补齐 streaming 事件粒度。,仓库中不存在两套可达的 workflow 执行语义；API 与 WorkflowAgent 事件序列语义一致（node_start/node_complete/node_error/workflow_complete/workflow_error）；kernel_id/executor_id 可追踪。,AUTOSERVER,Review 先收敛到单一 port 再谈替换实现（KISS）；事件语义有测试护栏。,回归：执行与对话修改链路无回归；事件粒度不退化。,已完成,已完成,已完成,已提交,,src/interfaces/api/routes/workflows.py:535;src/domain/agents/workflow_agent.py:1;src/domain/ports/workflow_execution_kernel.py:1;src/application/use_cases/execute_workflow.py:23;src/domain/services/workflow_engine.py:68;src/interfaces/api/routes/workflows.py:353,picked_reason:P1 现存 execute 分支与 WorkflowAgent frozen 文案已不一致，需要先澄清并收敛单一执行内核;blocked_resolved:统一通过 WorkflowExecutionKernelPort 执行（API/WorkflowAgent），并补齐 node_error/workflow_error 事件语义;done_at:2026-01-03;evidence:pytest -q tests/unit/application/use_cases/test_execute_workflow.py;pytest -q tests/integration/api/workflows/test_execute_uses_orchestrator.py tests/integration/api/workflows/test_run_event_persistence.py;risk:low API 仅收敛为单一 kernel port + 测试覆盖
WFCONV3-110,P1,M8,backend,M8 计划验证闭环：validate→commit→execute（后端）,将计划验证变成硬门：generate_plan → validate → commit → execute；纳入 Coordinator 监督（fail-closed）并可观测。,对话生成的计划在执行前一定经过 validate；失败必阻断且错误可观测；覆盖关键失败模式（缺 tool、DAG 不可达、执行器不可用、监督拒绝）。,AUTOSERVER,Review 验证输入/输出可证伪；失败路径不产生副作用；与现有监督链路一致。,回归：正常路径不受影响；失败注入可复现且无副作用。,已完成,已完成,已完成,已提交,,src/domain/services/workflow_save_validator.py:54;src/domain/agents/coordinator_agent.py:1;src/interfaces/api/routes/workflows.py:353;src/domain/services/workflow_save_validator.py:65;src/application/services/coordinator_policy_chain.py:33;tests/integration/api/workflows/test_execute_stream_validation_gate.py:1,picked_reason:P1 validate→commit→execute 涉及多链路编排，需先锁定“计划/执行”的唯一入口与可观测事件模型;blocked_resolved:execute/stream 先 validate 再 commit(run_start) 再 execute，并纳入 CoordinatorPolicyChain 监督（fail-closed）;done_at:2026-01-03;evidence:pytest -q tests/integration/api/workflows/test_execute_uses_orchestrator.py tests/integration/api/workflows/test_run_event_persistence.py tests/integration/api/workflows/test_execute_stream_validation_gate.py;risk:low 仅增加执行前硬门校验与监督，已有回归/契约测试覆盖
WFCONV3-120,P1,M2,backend,M2 DDD 护栏：引入 import-linter 或替代静态检查,强化静态边界检查，确保 Domain 不依赖 Infrastructure/Interface，避免越界回潮。,提供可在开发环境运行的静态检查命令（python -m importlinter 或替代脚本）并可失败时给出明确报表；至少覆盖 src/domain -> src.infrastructure/src.interfaces 的禁止依赖。,AUTOSERVER,Review 护栏可执行且不引入大量噪音；失败信息可定位到具体 import。,回归：新增/改动模块未引入越界依赖。,已完成,已完成,已完成,已提交,,.import-linter.toml:1;scripts/ddd_boundary_checks.py:110,"picked_reason:P1 DDD 越界历史多发，补齐静态护栏覆盖 src.domain->src.infrastructure;done_at:2026-01-03;evidence:python scripts/ddd_boundary_checks.py (direct import scan);evidence:lint-imports --config .import-linter.toml (transitive graph, currently flags domain->app->infra chain);risk:low adds guardrail command + clearer failure report"
WFCONV3-130,P2,M0,both,M0 验收记录：补齐 workflow_convergence_v3_acceptance.md,为 V3 收敛建立可追踪的验收记录文件，逐条记录 AC 证据链接（测试命令输出/日志/截图）。,新增 docs/architecture/workflow_convergence_v3_acceptance.md（或等价文件）；包含至少 M0 相关 AC 的证据记录入口；后续里程碑可持续追加。,AUTOE2E,Review 文档只记录可验证证据，不写推测；路径与命令可复制执行。,回归：文档与代码/测试保持一致更新。,已完成,已完成,已完成,已提交,,docs/architecture/workflow_convergence_v3_acceptance.md:1;issues/2026-01-03_16-16-12-workflow-convergence-v3.csv:1,picked_reason:P2 补齐可追踪验收记录，便于后续里程碑持续追加证据;done_at:2026-01-03;evidence:docs/architecture/workflow_convergence_v3_acceptance.md created and includes M0 entry;risk:low documentation-only
