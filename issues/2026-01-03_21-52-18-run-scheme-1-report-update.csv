id,priority,phase,area,title,description,acceptance_criteria,test_mcp,review_initial_requirements,review_regression_requirements,dev_state,review_initial_state,review_regression_state,git_state,owner,refs,notes
WF-010,P0,1,backend,修订Report.md（结论与证据一致）,校准不变式验收矩阵，修正与当前实现不一致的条目，并补齐可点击证据引用，作为后续收敛的边界合同。,Report.md 的每条“当前验收”都能被代码/测试佐证；每条不变式包含入口/契约/实现位置/错误码/测试点；不存在已实现却标为缺失的条目。,AUTOSERVER,Review时逐条核对引用行号与真实行为；禁止“推测性结论”；对每条不变式声明唯一真源与fail-closed策略。,回归时抽查关键链路：chat-create、workflow modify、execute/stream、runs create；确保报告与接口/事件契约一致。,已完成,已完成,已完成,已提交,,plan/2026-01-03_21-37-09-run-scheme-1-report-update.md:1;Report.md:1;src/interfaces/api/routes/workflows.py:359;Report.md:37;Report.md:54,picked_reason:P0 phase1 先校准报告作为后续收敛边界合同;done_at:2026-01-04;evidence:pytest -q tests/integration/api/workflows/test_legacy_create_workflow_api.py | pytest -q tests/integration/api/workflows/test_workflow_validation_contract.py | pytest -q tests/integration/api/workflows/test_workflows.py | pytest -q tests/integration/api/workflow_chat/test_chat_create_stream_api.py;risk:low doc-only alignment with tested contracts;summary:Report.md compliance matrix & invariant contract aligned to code/tests;blocked:git commit failed (pre-commit trailing-whitespace auto-fix modified Report.md); next:re-stage and retry commit;git_retry:re-staged after pre-commit auto-fix
WF-020,P0,2,both,Run回放闭环（API+前端useRunReplay）,补齐RunEvent回放接口并让前端真实消费回放，保证点击Run后的事实可追踪可回放。,提供 GET /api/runs/{run_id}/events（含稳定排序与分页）；useRunReplay 不再是placeholder且能Stop/Replay；回放事件字段与SSE同构；刷新页面后仍可复原同一成功/失败结论。,AUTOE2E,Review时确认回放接口返回字段固定且兼容；确认事件顺序与终态不丢失；前端错误处理结构化展示。,回归：并发执行、断线重连后回放一致；无run_id或无权限时返回符合约定错误码/结构；Excel/中文不乱码（BOM）。,已完成,已完成,已完成,已提交,,plan/2026-01-03_21-37-09-run-scheme-1-report-update.md:1;src/interfaces/api/routes/runs.py:153;src/interfaces/api/routes/workflows.py:359;web/src/hooks/useRunReplay.ts:1;src/interfaces/api/routes/runs.py:95;src/interfaces/api/routes/workflows.py:508;web/src/hooks/useRunReplay.ts:19;web/src/hooks/__tests__/useRunReplay.test.ts:1;tests/integration/api/runs/test_run_events_replay_api.py:1,picked_reason:P0 优先补齐 run 回放闭环，作为点击 Run 的可追踪可回放事实源;done_at:2026-01-04;evidence:pytest -q tests/integration/api/runs/test_run_events_replay_api.py | npm -C web test -- --run src/hooks/__tests__/useRunReplay.test.ts;summary:added run events replay API + real useRunReplay with abort/pagination + persisted lastRunId;risk:low-medium (new endpoint; compatibility maintained);blocked:git commit failed (pre-commit auto-formatted files: ruff/ruff-format/end-of-file-fixer); next:re-stage and retry commit;git_retry:re-staged after pre-commit auto-format
WF-030,P0,3,backend,执行链路唯一化并与WorkflowAgent同源,确认并收敛REST执行与WorkflowAgent执行走同一Kernel/语义/成功判定，杜绝两套执行真源。,REST execute/stream 与 WorkflowAgent 执行调用同一 kernel；事件类型集合与字段一致；成功判定=终态事件+RunStatus；对外不出现两套executor语义。,AUTOSERVER,Review时检查依赖方向（DDD）与注入点；禁止WorkflowAgent保留独立DAG执行；接口层不得编排Domain执行细节。,回归：同一workflow同一input在两入口输出事件序列一致（允许trace id不同但语义一致）；失败路径终态一致且RunStatus准确。,已完成,已完成,已完成,已提交,,plan/2026-01-03_21-37-09-run-scheme-1-report-update.md:1;src/interfaces/api/routes/workflows.py:359;src/application/services/workflow_execution_orchestrator.py:31;src/domain/agents/workflow_agent.py:30;src/domain/agents/workflow_agent.py:2346;src/domain/agents/workflow_agent.py:2358;src/domain/agents/workflow_agent.py:2383;tests/integration/api/workflows/test_workflow_agent_execution_kernel_unification.py:1,picked_reason:P0 统一执行真源，避免 REST/Agent 双语义导致不可证明一致性;done_at:2026-01-04;evidence:pytest -q tests/integration/api/workflows/test_workflow_agent_execution_kernel_unification.py;summary:WorkflowAgent execute_workflow now shares kernel surface and aligns status with REST run status;risk:low (agent path requires run_id/workflow_id; matches REST fail-closed contract);blocked:git commit failed pre-commit(pyright) src/domain/agents/workflow_agent.py strip-on-None;next:fix workflow_id narrowing then retry commit;git_retry:2026-01-04;evidence:pytest -q tests/integration/api/workflows/test_workflow_agent_execution_kernel_unification.py (rerun);unblocked:pyright narrowing fixed;blocked:git commit failed pre-commit(ruff-format) modified src/domain/agents/workflow_agent.py;next:re-add formatted file then retry commit;git_retry2:2026-01-04;note:pre-commit ruff-format applied
WF-040,P0,4,backend,workflow执行强制使用LangGraph（adapter落地）,将workflow执行引擎迁移为LangGraph驱动，保证不是仅Run用例使用LangGraph。,workflow执行路径实际由LangGraph adapter驱动且不抛NotImplemented；事件语义与现有契约一致；提供紧急回滚开关且不改变外部契约。,AUTOSERVER,Review时确认LangGraph引入不破坏事件顺序/异常语义；确保无网络环境可跑mock测试；开关默认策略明确。,回归：覆盖正常/异常/取消/超时；事件落库与回放一致；切换开关前后外部字段不变。,已完成,已完成,已完成,已提交,,plan/2026-01-03_21-37-09-run-scheme-1-report-update.md:1;src/interfaces/api/routes/workflows.py:359;src/application/services/workflow_execution_orchestrator.py:31;src/application/services/workflow_execution_facade.py:35;src/infrastructure/lc_adapters/workflow/langgraph_workflow_executor_adapter.py:38;src/infrastructure/lc_adapters/workflow/langgraph_workflow_executor.py:141;src/config.py:138,picked_reason:P0 将执行引擎落到LangGraph adapter以避免只有Run用例走LangGraph;done_at:2026-01-04;evidence:pytest -q tests/integration/api/workflows/test_workflows.py::TestExecuteWorkflowAPI::test_execute_workflow_streaming_should_succeed;evidence:pytest -q tests/integration/api/workflows/test_workflow_agent_execution_kernel_unification.py;summary:WorkflowExecutionFacade now routes to LangGraph adapter by default while preserving node/workflow event contract;rollback:set settings.enable_langgraph_workflow_executor=false;risk:medium (default flag flipped; rely on adapter parity + rollback);blocked:git commit failed pre-commit(ruff/ruff-format) modified files;next:re-add formatted files then retry commit;git_retry:2026-01-04;note:pre-commit auto-fixed lint/format
WF-050,P1,5,both,Tool/Node统一与两条修改链路同校验,统一tool引用为稳定tool_id/capability_id；拖拽保存与对话修改在落库前走同一WorkflowSaveValidator并fail-closed。,Tool节点必须持久化tool_id（允许兼容字段但落库归一）；拖拽/对话修改对同一变更给出相同校验结果；missing_executor/missing_tool_id/tool_not_found/tool_deprecated/cycle_detected 阻止保存并返回结构化错误。,AUTOE2E,Review时核对能力注册中心唯一真源；避免字符串匹配；错误码/错误结构可被UI直接渲染。,回归：工具重命名/下线/版本升级不破坏引用；保存失败不污染workflow；并发编辑冲突可预期。,已完成,已完成,已完成,已提交,,plan/2026-01-03_21-37-09-run-scheme-1-report-update.md:1;Report.md:1;src/domain/services/workflow_save_validator.py:44;src/interfaces/api/routes/workflows.py:301;src/interfaces/api/dto/workflow_dto.py:31;src/application/use_cases/update_workflow_by_drag.py:81;src/application/use_cases/update_workflow_by_chat.py:95;web/src/features/workflows/components/NodeConfigPanel.tsx:301;web/src/features/workflows/pages/WorkflowEditorPageWithMutex.tsx:752,"picked_reason:P1 优先修复 tool node 配置/校验契约不一致，避免拖拽保存与对话修改校验分叉并为后续 E2E 验收解阻塞;done_at:2026-01-04;evidence:pytest -q tests/unit/domain/services/test_workflow_save_validator.py | npm -C web test -- --run src/features/workflows/pages/__tests__/WorkflowEditorNoWebSocket.test.tsx | npm -C web test -- --run src/hooks/__tests__/useWorkflowAI.test.ts;validation_limited:AUTOE2E harness not available (web has no e2e script; used unit+vitest instead);manual_test:1) start API+web; 2) in editor add Tool node then Save -> see structured validation errors; 3) in chat-stream trigger invalid change -> see error message includes codes/paths; 4) if tools exist in DB, select tool in Tool node config to populate tool_id;risk:medium UI/tool-node contract changed; tool node execution still gated by missing_executor unless tool executor is implemented;summary:canonicalize tool_id (toolId->tool_id) before validation/persist; tool node UI now selects persisted tool_id; drag-save and chat-stream surface structured validation errors"
WF-060,P1,6,backend,Coordinator监督落到policy chain（fail-closed）,将对话/修改/执行/工具引用的监督点下沉到Application policy chain，保证不可绕过且可审计。,对话入口、workflow修改入口、execute/stream 均产生可拦截决策事件；被拒绝返回403且含结构化reason；依赖缺失时fail-closed而非降级放行；监督事件可观测可追踪。,AUTOSERVER,Review时验证“监督不可绕过”而非仅EventBus挂载；确认拒绝后ConversationAgent会replan或澄清。,回归：模拟越权/偏航/注入；确认拒绝路径无副作用（不落库、不变更run状态）；日志与审计可用。,已完成,已完成,已完成,已提交,,plan/2026-01-03_21-37-09-run-scheme-1-report-update.md:1;src/application/services/workflow_execution_orchestrator.py:31;src/interfaces/api/routes/workflows.py:359;src/application/services/workflow_execution_orchestrator.py:251;src/interfaces/api/routes/workflows.py:469;src/application/services/conversation_turn_orchestrator.py:259;src/interfaces/api/routes/conversation_stream.py:109;src/interfaces/api/main.py:115;tests/integration/api/workflows/test_workflows.py:359,picked_reason:P1 将监督点下沉到policy chain，减少接口层绕过风险并为ReAct闭环提供审计基础;done_at:2026-01-04;evidence:pytest -q tests/integration/api/workflows/test_execute_uses_orchestrator.py::test_execute_stream_endpoint_goes_through_orchestrator_and_policy_chain;evidence:pytest -q tests/integration/api/workflows/test_run_event_persistence.py::test_t_run_1_execute_stream_persists_key_events;evidence:pytest -q tests/integration/api/workflows/test_workflows.py::TestExecuteWorkflowAPI::test_execute_workflow_streaming_coordinator_reject_should_return_403_and_no_side_effects;summary:Coordinator supervision moved into WorkflowExecutionOrchestrator/ConversationTurnOrchestrator policy chains with fail-closed 403 mapping and side-effect-free rejection;risk:medium (workflow orchestrator policy protocol expanded; covered by targeted integration tests);blocked:git commit failed pre-commit(pyright) main.py coordinator typing + kernel port missing gate/stream_after_gate;next:fix types then retry commit;git_retry:2026-01-04;note:pyright types fixed + kernel port extended
WF-070,P1,6,backend,严格ReAct闭环（Action→真实执行→Observation）,ConversationAgent 的Action必须触发真实tool/node执行并产生Observation（可持久化审计），禁止只emit tool_call。,每个Action都有对应Observation（成功/失败）；Observation来自真实执行结果；关键Observation可通过RunEvent或等价审计记录回放；存在自动化测试证明不是“伪ReAct”。,AUTOSERVER,Review时检查工具执行入口、超时/取消、错误结构化；避免把执行逻辑塞进Interface层。,回归：多轮对话连续工具调用不丢Observation；异常/超时/取消能被记录并触发replan；无网络下mock稳定。,已完成,已完成,已完成,已提交,,plan/2026-01-03_21-37-09-run-scheme-1-report-update.md:1;Report.md:1;src/domain/agents/conversation_agent_react_core.py:340;src/interfaces/api/routes/conversation_stream.py:56;src/application/services/conversation_turn_orchestrator.py:112;src/application/services/conversation_agent_factory.py:6;tests/unit/domain/agents/test_conversation_agent_react_core.py:214;tests/unit/domain/agents/test_conversation_agent_emitter_integration.py:267,picked_reason:P1 对话流式端点依赖 ReAct 工具调用闭环，先补齐 tool_call→真实执行→tool_result/observation 以解阻塞审计与回放能力;process_note:refs 缺失导致先定位调用链，已补齐并回写状态;done_at:2026-01-04;evidence:pytest -q tests/unit/domain/agents/test_conversation_agent_react_core.py tests/unit/domain/agents/test_conversation_agent_emitter_integration.py;summary:tool_call now triggers best-effort execution + emits tool_result + records observation into session_context; supports awaitable token_usage/cost getters;risk:medium tool_call execution semantics changed; unknown tools now produce explicit failure observation instead of silent tool_call-only;blocked:git commit failed (pre-commit ruff/ruff-format auto-fix modified files);git_retry:re-staged after pre-commit auto-fix
WF-080,P1,7,backend,DDD边界治理与CI守门（import-linter）,收敛关键链路的跨层依赖并在CI中阻断新增越界，确保入口唯一性可被结构性强制。,import-linter在CI中启用并阻断新增越界；对话/执行/修改关键链路不再出现Interface→Domain Agents等违反依赖方向的直接import；新增改动遵循Ports/Adapters。,AUTOSERVER,Review时逐PR检查依赖方向；必要时引入Ports而非硬引Domain实现；保持KISS。,回归：全量测试通过；静态检查通过；无“为了过检查而绕路”的反模式（如大面积放宽规则）。,已完成,已完成,已完成,已提交,,plan/2026-01-03_21-37-09-run-scheme-1-report-update.md:1;.import-linter.toml:1;src/domain/services/workflow_chat_service_enhanced.py:225;src/interfaces/api/routes/workflows.py:185;.pre-commit-config.yaml:1,picked_reason:P1 先修复并启用 import-linter 作为结构性守门，防止边界继续劣化;done_at:2026-01-04;evidence:lint-imports --config .import-linter.toml (all contracts kept);evidence:pre-commit run import-linter --all-files;evidence:pytest -q tests/unit/domain/services/test_workflow_chat_service_enhanced.py::test_chat_service_maintains_history;summary:removed Domain->Application memory adapter import by injecting history adapter from Interface;added pre-commit import-linter hook using python -X utf8;risk:low (behavior preserved; guard now active);blocked:git commit failed pre-commit(ruff --fix) modified files;next:re-add auto-fixed files then retry commit;git_retry:2026-01-04;note:pre-commit applied ruff auto-fix
WF-090,P1,8,both,按不变式做自动化验收与回归测试集,新增/补齐测试用例与手工验收步骤，确保10条不变式可被持续验证。,覆盖：run幂等创建、execute/stream gate、RunEvent落库与回放顺序、Coordinator reject、严格ReAct闭环、LangGraph workflow执行；Report.md列出对应测试与手工验收步骤。,AUTOE2E,Review时确认测试不依赖外网；用mock替代LLM/第三方；失败信息可定位到不变式编号。,回归：Windows/CI环境均可稳定运行；并发与断线场景包含在回归集中；关键路径性能不明显退化。,已完成,已完成,已完成,已提交,,plan/2026-01-03_21-37-09-run-scheme-1-report-update.md:1;Report.md:128;tests/integration/api/runs/test_run_events_replay_api.py:133;tests/unit/application/services/test_workflow_execution_facade_langgraph_toggle.py:14,picked_reason:only_remaining_open_issue;done_at:2026-01-04;evidence:pytest -q tests/unit/application/services/test_workflow_execution_facade_langgraph_toggle.py;pytest -q tests/integration/api/runs/test_run_events_replay_api.py;pytest -q tests/integration/api/workflows/test_execute_stream_validation_gate.py;pytest -q tests/integration/api/workflows/test_run_event_persistence.py;pytest -q tests/integration/api/test_sse_disconnect_reconnect.py;npm -C web test -- --run src/features/workflows/pages/__tests__/WorkflowRunFailClosed.test.tsx;risk:low doc+tests
