id,priority,phase,area,title,description,acceptance_criteria,test_mcp,review_initial_requirements,review_regression_requirements,dev_state,review_initial_state,review_regression_state,git_state,owner,refs,notes
WFPLAN-010,P0,1,both,冻结事件语义与链路契约（planning/tool_call/execution）,定义并落地 workflow 主链路的事件语义边界，区分规划/真实工具调用/执行事件；为各入口输出集合建立“边界合同”。,(1) 明确文档/常量列出 planning/tool_call/execution 三类事件及字段含义；(2) execute/stream 流中仅允许 node_* 与 workflow_*（含 executor_id/run_id），不得出现 planning/tool_call；(3) 任意 tool_call/tool_result 事件必须可追溯到真实执行器（ConversationAgent tool_call_executor 或 tool engine），不得由 LLM 文本回放生成；(4) 以上规则有自动化检查（至少 1 条后端集成测试或契约测试覆盖）。,AUTOSERVER,Review 事件分类是否互斥；字段命名是否稳定；是否避免泄露敏感内容（message/input_data 不明文透传到 coordinator）；新增契约是否向后兼容。,回归验证 chat-create/chat-stream/execute-stream 三条主链路事件序列；对比 Run events 回放与 UI 展示一致；检查日志/审计字段齐全。,已完成,已完成,已完成,已提交,,plan/2026-01-04_19-59-00-workflow-report-plan.md:1;Report.md:1;src/interfaces/api/routes/workflows.py:427;src/application/services/workflow_run_execution_entry.py:316;src/domain/agents/conversation_agent_react_core.py:436;src/application/services/workflow_event_contract.py:1;src/application/services/workflow_run_execution_entry.py:182;tests/integration/api/workflows/test_run_event_persistence.py:304,picked_reason:P0 基础契约，先锁定事件语义以解阻塞后续适配/测试;done_at:2026-01-04;contract:execute/stream only node_* + workflow_*;evidence:pytest -q tests/integration/api/workflows/test_run_event_persistence.py (pass);risk:low fail-closed contract guard
WFPLAN-020,P0,2,both,修复 workflow chat 的“伪 ReAct”事件语义并前端适配,将 workflow chat 的 react_steps 输出改为 planning_step（或 react_step+simulated=true），禁止映射为 tool_call/tool_result；前端将规划步骤与真实工具调用分区展示。,(1) 后端 POST /api/workflows/{id}/chat-stream 的 SSE 不再输出 tool_call/tool_result（除非链路引入真实执行并可审计证明）；(2) 规划步骤事件必须标注 simulated=true 且 source=workflow_chat_llm（或等价字段）；(3) 前端可视化区分“AI规划/解释步骤”与“真实工具调用”，规划步骤不计入执行成功/失败统计；(4) workflow_updated 仍可正常落库（增删节点/边）且 UI 无破坏性回归。,AUTOE2E,Review 事件兼容策略（是否需要兼容期）；Review 前端解析容错（未知事件类型不崩溃）；Review 不新增跨层依赖（DDD）。,回归：chat-create/stream 与 chat-stream SSE 解析；回归：旧前端版本是否需要降级；故障注入：模拟断流/乱序/重复事件。,已完成,已完成,已完成,已提交,,plan/2026-01-04_19-59-00-workflow-report-plan.md:1;Report.md:1;src/application/use_cases/update_workflow_by_chat.py:264;src/interfaces/api/routes/workflows.py:777;web/src/features/workflows/api/workflowsApi.ts:78;src/interfaces/api/routes/workflows.py:777;src/interfaces/api/routes/workflows.py:852;src/domain/services/conversation_flow_emitter.py:267;web/src/hooks/useWorkflowAI.ts:81;tests/integration/api/workflow_chat/test_chat_stream_react_api.py:260,picked_reason:P0 修正伪 tool_call 语义，避免误导审计/统计并为前端分区展示打基础;done_at:2026-01-04;contract:chat-stream emits planning_step (simulated) not tool_call/tool_result;evidence:pytest -q tests/integration/api/workflow_chat/test_chat_stream_react_api.py tests/integration/api/workflow_chat/test_chat_create_stream_api.py (pass);evidence:web npx vitest run src/hooks/__tests__/useWorkflowAI.test.ts src/features/workflows/pages/__tests__/WorkflowEditorPage.test.tsx src/features/workflows/e2e/workflow-execution.test.tsx (pass);validation_limited:web npm test has 2 timeouts (WorkflowEditorNoWebSocket.test.tsx; WorkflowRunFailClosed.test.tsx);manual_test:cd web && npm test;risk:medium full web suite not green in this env
WFPLAN-030,P1,3,backend,chat-create 前置 Coordinator gate（可选：拒绝=0副作用）,在 chat-create 创建并 commit workflow 前执行 coordinator preflight gate；若拒绝则直接返回错误且不落库，确保副作用边界可控。,(1) Coordinator 拒绝 chat-create 时数据库无 workflow 记录（或事务回滚）；(2) gate 仅透传最小信息（message_len/project_id/run_id），不传 message 明文；(3) gate 通过后仍满足“首个 SSE 事件包含 workflow_id”的合同；(4) 断连场景无长期残留半成品 workflow（有明确定义：无副作用或可回收可观测）。,AUTOSERVER,Review gate 放置点是否在任何副作用之前；Review SSE 合同是否保持；Review 日志审计字段（actor/scope/reason）是否齐全。,回归：正常创建、拒绝创建、客户端断开三场景；回归：feature flag/rollback 路径不破坏生产流量。,已完成,已完成,已完成,已提交,,plan/2026-01-04_19-59-00-workflow-report-plan.md:1;Report.md:1;src/interfaces/api/routes/workflows.py:563;src/application/use_cases/update_workflow_by_chat.py:70;src/domain/services/coordinator_policy_chain.py:44;tests/integration/api/workflow_chat/test_chat_create_stream_api.py:1;src/domain/services/coordinator_policy_chain.py:33,picked_reason:P1 以最小副作用边界补齐 chat-create 的 coordinator preflight gate，降低错误创建/断连残留风险;done_at:2026-01-04;evidence:pytest -q tests/integration/api/workflow_chat/test_chat_create_stream_api.py (OK);validation_limited:SSE client disconnect is hard to simulate reliably with TestClient; relied on code-path review (_cleanup_failed_creation on is_disconnected);manual_test:run backend then call POST /api/workflows/chat-create/stream (Accept:text/event-stream) and abort connection mid-stream; verify workflow_id from 1st event is not persisted;risk:low preflight gate runs before db commit; reject path has zero DB side effects
WFPLAN-040,P0,4,backend,固化 RunEntry 为唯一执行编排事实源并统一成功判定,清点并封堵 run persistence 开启时的执行旁路；对外 success 判定统一为“终态事件 workflow_complete + RunStatus=COMPLETED”。,(1) run persistence 开启时，业务可达路径不存在无需 run_id 的 workflow 执行入口；(2) REST execute/stream、调度器执行、WorkflowAgent execute_workflow 均通过 WorkflowRunExecutionEntryPort；(3) 返回体 success/status/terminal event 与 Run events 回放一致；(4) 若 feature flag 回滚允许 bypass，必须记录审计日志并明确 scope。,AUTOSERVER,Review 旁路清点范围（API/调度器/agent）；Review 兼容回滚开关；Review 并发/幂等（RunStatus CAS）是否保持。,回归：创建 run→execute/stream→events 回放；并发：重复终态事件不导致状态回退；失败：workflow_error 正确落库并终态固定。,已完成,已完成,已完成,已提交,,plan/2026-01-04_19-59-00-workflow-report-plan.md:1;Report.md:1;src/application/services/workflow_run_execution_entry.py:1;src/application/services/workflow_run_execution_entry.py:316;src/interfaces/api/routes/workflows.py:427;src/application/use_cases/append_run_event.py:1;src/interfaces/api/services/workflow_executor_adapter.py:80;tests/unit/interfaces/api/test_workflow_executor_adapter.py:1,picked_reason:P0 收敛执行旁路与回滚审计，确保 run 语义/成功判定单一事实源;done_at:2026-01-04;audit:disable_run_persistence bypass logs scope;evidence:pytest -q tests/unit/interfaces/api/test_workflow_executor_adapter.py (pass);risk:low additive audit + guardrail test
WFPLAN-050,P1,5,both,多智能体闭环：接线执行桥 or 明确不作为 workflow 主链路（二选一）,在会议层面落盘选择：A) 将 validated decision 接入 WorkflowAgent 执行（只消费 coordinator 通过的事件且使用 RunEntry）；或 B) 明确 workflow 主链路为 UseCase+gate+validator+RunEntry，并限制/下线未挂载入口。,选项A：(1) app 启动时注册执行桥，validated decision 能触发同一 run_id 的执行事件流与 RunStatus；(2) WorkflowAgent plan validation feedback 可触发 ConversationAgent recovery 监听。选项B：(1) 文档/README/运行手册不再将三 Agent 闭环描述为 workflow 主链路；(2) 未完成入口对外不可用或明确 disabled/404；(3) 指标/日志能区分 workflow 主链路与实验入口。,AUTOE2E,Review 选择口径是否与产品一致；Review 接线后是否引入双中心（UseCase vs Agent）；Review DDD 边界（Domain 不依赖 Application/Infra）。,回归：workflow 主链路（chat/execute）不受实验入口影响；回归：event bus/sse bridge 行为可解释；故障注入：coordinator reject 时无副作用且无执行发生。,已完成,已完成,已完成,已提交,,plan/2026-01-04_19-59-00-workflow-report-plan.md:1;Report.md:1;src/interfaces/api/services/event_bus_sse_bridge.py:13;src/domain/services/decision_execution_bridge.py:1;src/domain/agents/conversation_agent_recovery.py:117;src/domain/agents/workflow_agent.py:2407;README.md:102;docs/architecture/current_agents.md:1;src/interfaces/api/main.py:396;src/interfaces/api/routes/conversation_stream.py:1,picked_reason:P1 选择 OptionB 收敛主链路到 UseCase+gate+validator+RunEntry，降低双中心与未接线入口风险;decision:OptionB;done_at:2026-01-04;evidence:docs updated (README.md + docs/architecture/current_agents.md) | pytest -q tests/integration/api/workflow_chat/test_chat_create_stream_api.py tests/integration/api/workflow_chat/test_chat_stream_react_api.py (OK);risk:low OptionB is documentation/entrypoint scoping; no workflow main chain behavior change
WFPLAN-060,P0,6,both,补齐自动化测试与架构边界守门（pytest/import-linter/前端）,为事件语义、SaveValidator、RunEntry 成功判定与关键回归链路补齐测试；import-linter 必须通过。,(1) 后端 pytest 覆盖：chat-stream 事件语义不产生 tool_call/tool_result；SaveValidator 支持 toolId→tool_id 且 tool 不存在 fail-closed；RunEntry success 判定；(2) 前端 vitest/e2e 覆盖：Run 创建失败不触发 execute/stream（保持现有用例通过）；(3) import-linter 通过且不新增越界；(4) CI/本地一键命令可复现。,AUTOSERVER,Review 测试命名与分层（unit/integration/e2e）；Review 不依赖外网；Review 可重复性（固定时间/随机数）。,全量回归：pytest + import-linter + 前端测试；重点回归 SSE 解析容错与 Run 回放一致性。,已完成,已完成,已完成,已提交,,plan/2026-01-04_19-59-00-workflow-report-plan.md:1;Report.md:1;src/domain/services/workflow_save_validator.py:44;src/domain/services/workflow_save_validator.py:140;src/application/services/workflow_run_execution_entry.py:316;web/src/features/workflows/pages/__tests__/WorkflowRunFailClosed.test.tsx:1;.import-linter.toml:1;scripts/workflow_core_checks.ps1:1;pyproject.toml:118;tests/unit/lc/conftest.py:1;.github/workflows/ci.yml:1;tests/unit/domain/services/test_workflow_save_validator.py:1;web/src/features/workflows/pages/__tests__/WorkflowEditorNoWebSocket.test.tsx:1,picked_reason:P0 统一用例/回归测试收敛，保证事件语义与 fail-closed 不变式长期可回归;done_at:2026-01-04;evidence:lint-imports --config .import-linter.toml (OK) | python scripts/ddd_boundary_checks.py (OK) | pytest -q tests/unit/domain/services/test_workflow_save_validator.py (OK) | pytest -q tests/integration/api/workflow_chat/test_chat_stream_react_api.py (OK) | cd web && npm test (OK) | powershell -ExecutionPolicy Bypass -File scripts/workflow_core_checks.ps1 (OK);validation_limited:pytest -q tests/unit currently reports many pre-existing failures (example: RunEvent.create signature mismatch); full unit suite not green in this repo snapshot;manual_test:powershell -ExecutionPolicy Bypass -File scripts/workflow_core_checks.ps1;risk:medium regression relies on CI (py311/py312) until unit suite is restored
WFPLAN-070,P2,7,both,更新 Report/Runbook：事件语义表、拒绝语义、主链路定位,将修复状态、验收链接与运维回放路径落盘到文档；更新 Runbook 以防止团队认知漏洞复发。,(1) Report.md 标注每项问题已修复/未修复，并提供对应测试用例/日志关键字；(2) Runbook 明确三类事件语义与追责方式（如何从 run events 回放）；(3) 明确 Coordinator 覆盖范围与拒绝语义（是否 0 副作用）；(4) 明确多智能体闭环在 workflow 主链路中的定位（A 接线/B 非主链路）。,AUTOSERVER,Review 文档与代码事实一致；Review 引用均为 file:line 可跳转；Review 运行手册可操作（命令/接口齐全）。,回归演练：按 Runbook 复现一次创建→修改→执行→回放；确保文档可指导新人定位问题。,未开始,未开始,未开始,未提交,,plan/2026-01-04_19-59-00-workflow-report-plan.md:1;Report.md:1;docs/architecture/current_agents.md:1;src/interfaces/api/routes/runs.py:238,
