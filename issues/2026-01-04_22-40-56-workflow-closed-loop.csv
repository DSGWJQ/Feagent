id,priority,phase,area,title,description,acceptance_criteria,test_mcp,review_initial_requirements,review_regression_requirements,dev_state,review_initial_state,review_regression_state,git_state,owner,refs,notes
WFCL-010,P0,1,both,冻结验收口径与系统合同,将 Report/Plan 的硬前提转为可测试合同，统一 run_id/decision/event contract 与 fail-closed 语义，明确 out-of-scope。,形成一份可执行验收清单并绑定到测试/脚本；关键术语与字段定义（validated decision、run_id、终态规则）在文档中冻结且无歧义；所有新增/修改入口在 coordinator 缺失时均定义为拒绝且无副作用。,AUTOSERVER,Review 文档是否可落地到测试与代码门禁；确认 fail-closed 不引入旁路；确认对现有 API 合同的兼容性策略。,回归时核对验收清单逐条有证据（测试/日志/脚本）；运行 workflow_core_checks 与关键 pytest 集合并产出可比对结果。,已完成,已完成,已完成,已提交,,plan/2026-01-04_22-20-30-workflow-closed-loop.md:1;Report.md:1;docs/architecture/workflow_closed_loop_contract.md:1;tests/unit/application/services/test_workflow_event_contract.py:1;scripts/workflow_core_checks.ps1:1,picked_reason:P0 合同冻结可解阻塞并驱动后续实现;done_at:2026-01-04;evidence:python -m pytest -q tests/unit/application/services/test_workflow_event_contract.py (6 passed); powershell -ExecutionPolicy Bypass -File scripts/workflow_core_checks.ps1 (import-linter kept; targeted pytest pass; npm test pass);risk:low doc+tests+script only;blocked:git commit failed (pre-commit auto-fix: ruff-format/trailing-whitespace/end-of-file-fixer);next:git add updated files then retry commit;resolved_by:pre-commit auto-fixed + re-stage then re-commit
WFCL-020,P0,2.1,backend,启动并纳管 DecisionExecutionBridge,把 validated decision 的 allow 结果桥接到执行链路，确保 bridge 只消费 coordinator 已允许的 decision，并有明确启动/停机与错误隔离。,bridge 在应用启动后处于启用状态且可观测（日志/指标/审计）；仅 allow decision 触发下游；deny/无法验证/缺字段一律 fail-closed 且无副作用；bridge 异常不会产生假成功。,AUTOSERVER,Review 事件消费范围与来源校验；确认安全默认拒绝；确认异常隔离与重启行为不会导致重复执行。,回归：故障注入（bridge handler 异常、重复投递、重启）后执行链路仍 fail-closed；RunEvents 不被污染且可回放。,已完成,已完成,已完成,已提交,,src/domain/services/decision_execution_bridge.py:1;src/interfaces/api/main.py:285;plan/2026-01-04_22-20-30-workflow-closed-loop.md:47;src/interfaces/api/main.py:354,picked_reason:P0 启动 validated decision → 执行硬接线;done_at:2026-01-04;evidence:python -m pytest -q tests/unit/domain/services/test_decision_execution_bridge.py (13 passed); python -m pytest -q tests/integration/test_decision_to_execution_e2e.py::TestEndToEndDecisionExecution::test_full_pipeline_from_user_input_to_execution (1 passed);risk:medium bridge executes workflow decisions in-process (execute_workflow only);blocked:git commit failed (pre-commit pyright + auto-format);next:fix pyright errors then retry commit;resolved_by:fix pyright typing + re-stage then re-commit
WFCL-030,P0,2.2,backend,WorkflowAgent 注入统一执行入口并统一 run_id,为 WorkflowAgent 接入 WorkflowRunExecutionEntryPort（或等价 port），强制所有执行以同一 run_id 作为事实源落 RunEvents 与回放。,WorkflowAgent 执行路径使用统一执行门面（Entry/Port）；执行时必须携带既定 run_id（禁止隐式生成）；execute/stream 与 runs replay 对同一 run_id 的事件类型/终态一致。,AUTOSERVER,Review 依赖方向不破坏分层；确认 run_id 贯穿所有事件与审计；确认对现有 API 调用方的兼容策略。,回归：跑 RunEvents 持久化与回放相关集成测试；验证同一 run_id 的 SSE 流与 replay 一致（含失败终态）。,已完成,已完成,已完成,已提交,,src/domain/agents/workflow_agent.py:2361;src/application/services/workflow_run_execution_entry.py:1;src/interfaces/api/routes/workflows.py:427;tests/integration/api/workflows/test_run_event_persistence.py:1;tests/integration/api/runs/test_run_events_replay_api.py:1,picked_reason:P0 run_id 事实源与回放一致性;done_at:2026-01-04;evidence:python -m pytest -q tests/integration/api/workflows/test_run_event_persistence.py (3 passed); python -m pytest -q tests/integration/api/runs/test_run_events_replay_api.py (3 passed);risk:low (no code change; validated by existing integration tests)
WFCL-040,P0,2.3,backend,幂等与重入防护（decision/run 去重）,为 bridge/入口增加确定性幂等与去重，避免重复投递/重放导致二次执行或重复 RunEvents。,定义并实现幂等键（例如 decision_id+run_id）；同一 decision 重复投递仅执行一次且 RunEvents 不重复；bridge 重启/重放只产生一次可审计的 duplicate dropped 记录。,AUTOSERVER,Review 幂等键选择与存储位置；确认并发下无竞态导致重复执行；确认审计记录不泄漏敏感信息。,回归：并发/重复投递测试通过；RunEvents 序列不出现重复终态；必要时加入针对竞态的压力/重复测试。,已完成,已完成,已完成,已提交,,src/domain/services/decision_execution_bridge.py:1;src/application/services/workflow_run_execution_entry.py:1;plan/2026-01-04_22-20-30-workflow-closed-loop.md:63;src/application/services/workflow_run_execution_entry.py:182;tests/unit/application/services/test_workflow_run_execution_entry_dedup.py:1,picked_reason:P0 防重复执行与 RunEvents 污染;done_at:2026-01-04;evidence:python -m pytest -q tests/unit/application/services/test_workflow_run_execution_entry_dedup.py (1 passed); python -m pytest -q tests/integration/api/workflows/test_run_event_persistence.py (3 passed);risk:medium CAS claim changes duplicate error path (prevents concurrent duplicate execution);blocked:git commit failed (pre-commit ruff-format auto-fix);next:re-stage formatted files then retry commit;resolved_by:re-stage after ruff-format then re-commit
WFCL-050,P0,3,backend,chat-create 监督旁路修复为 fail-closed,将 chat-create/stream 的 coordinator preflight 从 fail-open 改为 fail-closed，并补齐误配置/最小化部署/测试 app 的覆盖。,coordinator 缺失/不可用时 chat-create 返回明确拒绝（状态码与错误体稳定）；无副作用（不创建 workflow/run/events）；新增/更新测试覆盖旁路场景并通过。,AUTOSERVER,Review 失败语义与兼容性（客户端如何处理）；确认拒绝路径不泄漏敏感配置；确认不会影响已有正常配置场景。,回归：运行 workflow_chat_create 与 workflow_core_checks；验证有 coordinator 时行为不变，无 coordinator 时稳定拒绝且无副作用。,已完成,已完成,已完成,已提交,,src/interfaces/api/routes/workflows.py:563;src/application/services/conversation_turn_orchestrator.py:269;Report.md:1;tests/integration/api/workflow_chat/test_chat_create_stream_api.py:1,picked_reason:P0 安全默认拒绝，修复监督旁路;done_at:2026-01-04;evidence:python -m pytest -q tests/integration/api/workflow_chat/test_chat_create_stream_api.py (6 passed); powershell -ExecutionPolicy Bypass -File scripts/workflow_core_checks.ps1 (import-linter kept; targeted pytest pass; npm test pass);risk:medium missing coordinator now 403 (intended fail-closed)
WFCL-060,P1,4.1,backend,内部创建入口合同化（默认不可达 + 审计/回滚语义）,明确内部创建/生成入口的默认不可达合同，以及启用条件、审计、隔离与回滚策略，防止压力下成为旁路。,默认配置下内部创建入口不可达（410/403）且行为由测试锁定；启用时必须产出审计事件并经过 coordinator 门禁（如适用）；回滚后恢复不可达且无残留旁路。,AUTOSERVER,Review feature flag 语义是否与产品前提一致；确认启用路径的审计与权限边界；确认不会绕开保存校验与执行事实源。,回归：默认不可达测试通过；启用/回滚路径在受控环境可复现且有审计；import-linter/门禁检查不被绕过。,未开始,未开始,未开始,未提交,,src/interfaces/api/routes/workflows.py:70;src/config.py:138;Report.md:1,
WFCL-070,P1,4.2,both,CI 静态门禁：入口唯一性 + 分层边界,在 CI 中加入入口唯一性检查（阻止新增未批准 workflow 创建入口），并强化分层边界约束（import-linter/自定义脚本）。,CI 在新增旁路入口时可失败且输出清晰报错；import-linter 与新增规则对目标边界生效；规则有文档说明并可在本地复现。,AUTOSERVER,Review 规则是否误伤合法变更；确认规则可维护且易扩展；确认失败信息可行动（定位到文件/路由）。,回归：在受控用例中验证规则能抓到旁路；workflow_core_checks 通过；不引入不必要复杂度（KISS）。,已完成,已完成,已完成,已提交,,.import-linter.toml:10;plan/2026-01-04_22-20-30-workflow-closed-loop.md:92;scripts/ddd_boundary_checks.py:130;docs/architecture/workflow_closed_loop_contract.md:79;.github/workflows/ci.yml:1,picked_reason:P1 先加 CI 静态门禁，减少后续入口旁路风险;done_at:2026-01-05;evidence:powershell -ExecutionPolicy Bypass -File scripts/workflow_core_checks.ps1 (passed);evidence:simulated bypass by adding temp file with Workflow.create_base; python scripts/ddd_boundary_checks.py -> exit 1 (caught);risk:low static-only change (CI/script/doc)
WFCL-080,P0,5.1,backend,端到端证据链测试：validated decision → RunEvents → replay,新增/强化集成测试覆盖 allow/deny、成功/失败、重复投递、bridge 异常，证明同一 run_id 的 SSE 与 replay 终态一致。,新增/强化的测试在 CI 稳定通过；覆盖至少：allow 执行、deny 不执行、bridge 异常 fail-closed、重复投递去重；对同一 run_id 的 SSE 与 replay 在事件类型集合与终态一致。,AUTOE2E,Review 用例是否覆盖关键风险（旁路、假成功、重复）；确认测试对环境依赖最小且可重复。,回归：运行建议 pytest 集合 + workflow_core_checks；必要时跑前端 npm test 验证协议消费未回归。,已完成,已完成,已完成,已提交,,src/interfaces/api/routes/runs.py:93;src/interfaces/api/routes/workflows.py:427;tests/integration/api/runs/test_run_events_replay_api.py:1;tests/integration/api/workflows/test_validated_decision_run_events_replay_e2e.py:1;src/interfaces/api/main.py:319,picked_reason:P0 端到端证据链补齐（allow/deny/dup/exception）;done_at:2026-01-04;evidence:python -m pytest -q tests/integration/api/workflows/test_validated_decision_run_events_replay_e2e.py (4 passed); powershell -ExecutionPolicy Bypass -File scripts/workflow_core_checks.ps1 (passed: import-linter + boundary + targeted pytest + npm test);risk:medium main DecisionExecutionBridge handler changed to avoid Interface→Domain agents import;blocked:git commit failed (pre-commit ruff unused var);unblocked:pre-commit ruff fixed (remove unused app);evidence:python -m ruff check tests/integration/api/workflows/test_validated_decision_run_events_replay_e2e.py (passed);resolved:git commit succeeded
WFCL-090,P1,5.2,both,可观测性与审计闭环（allow/deny/bridge/duplicate）,补齐 coordinator allow/deny、bridge start/stop、execution correlation、duplicate dropped、错误终态的日志/指标/审计事件。,关键路径产生结构化日志/审计事件且可通过 run_id/decision_id 关联；deny/异常/duplicate 都可被追踪；不泄漏敏感信息；日志量可控。,AUTOSERVER,Review 日志字段与脱敏；确认审计事件的稳定 schema；确认不会影响主链路性能。,回归：通过集成测试与手工触发路径验证审计与指标齐全；对 deny/异常/duplicate 均可定位到具体请求与 run_id。,未开始,未开始,未开始,未提交,,src/application/services/conversation_turn_orchestrator.py:269;src/interfaces/api/main.py:285;plan/2026-01-04_22-20-30-workflow-closed-loop.md:105,
WFCL-100,P1,5.3,both,上线灰度与回滚策略（feature flag + fail-closed 降级）,为闭环桥接链路制定可控灰度开关与回滚预案，确保异常时明确 fail-closed，不出现假成功或旁路回潮。,存在可操作的 feature flag 与文档；灰度开启/关闭可在不改代码条件下切换；bridge 异常时系统拒绝执行并记录审计；回滚后核心验证集合仍通过。,AUTOE2E,Review 开关默认值与变更流程；确认回滚不会破坏 Run 事实源一致性；确认与 disable_run_persistence 等既有 flag 的语义不冲突。,回归：灰度开/关两种模式下分别跑 workflow_core_checks 与关键 pytest；必要时跑前端 npm test 确认 UI/协议未受影响。,未开始,未开始,未开始,未提交,,src/config.py:133;src/config.py:145;plan/2026-01-04_22-20-30-workflow-closed-loop.md:113,
