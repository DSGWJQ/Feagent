id,priority,phase,area,title,description,acceptance_criteria,test_mcp,review_initial_requirements,review_regression_requirements,dev_state,review_initial_state,review_regression_state,git_state,owner,refs,notes
WFCORE-010,P0,1,backend,入口治理：创建链路唯一（internal create 默认不可达）,治理 workflow 创建入口：仅保留 chat-create 作为产品创建链路；import/generate-from-form 保留为内部工具但默认 403/410 且需权限+feature flag+审计。,对产品流量：仅 chat-create 可创建 workflow；/import 与 /generate-from-form 默认返回 403/410；开启内部开关且具备内部权限时才可用；具备审计日志；前端产品路径无调用点。,AUTOSERVER,Review：确认权限/开关默认关闭、失败为 fail-closed；确认审计字段齐全（who/when/workflow_id/source）；确认前端无引用。,回归：chat-create 正常；内部入口在关闭开关时不可达；开启开关时可达且不破坏不变式；日志与错误码一致。,已完成,已完成,已完成,已提交,,plan/2026-01-04_11-54-26-workflow-core-solution-plan.md:1;Report.md:1;src/interfaces/api/routes/workflows.py:614;src/interfaces/api/routes/workflows.py:1090;src/interfaces/api/routes/workflows.py:1123;src/config.py:134;src/interfaces/api/routes/workflows.py:70;src/config.py:138;tests/integration/api/workflows/test_internal_create_endpoints_access.py:91,picked_reason:P0 且 backend-only，优先收敛创建入口风险;done_at:2026-01-04;evidence:pytest -q tests/integration/api/workflows/test_internal_create_endpoints_access.py (4 passed);acceptance:import/generate 默认410；启用开关且admin才可达；审计日志 workflow_internal_create_*;risk:low 仅新增门禁与flag，默认fail-closed
WFCORE-020,P0,2,both,Run 事实源闭环：门禁/终态唯一/断连收敛/回放+前端Replay,加固 Run 方案1：Run 创建幂等、execute/stream 门禁、终态事件唯一、断连不悬挂、回放 API 稳定，并让前端 useRunReplay 消费回放。,POST runs 支持 Idempotency-Key 幂等；execute/stream 缺 run_id=400、run 不存在/归属不符/状态不可执行=409；终态事件不重复；断连/取消/超时会写入终态并收敛 RunStatus；GET runs/{run_id}/events 回放顺序稳定；useRunReplay 真正调用回放接口并支持 Stop/Replay；刷新可复原结论。,AUTOE2E,Review：确认“终态唯一”的实现策略（路由同步 vs 异步录制）不会双写；确认断连收敛无副作用；回放分页 cursor 稳定；前端错误处理结构化。,回归：并发点击 Run（幂等/冲突）与断线重连；回放不丢终态、不乱序；RunStatus 与 UI 结论一致；队列满丢事件不影响终态。,已完成,已完成,已完成,已提交,,plan/2026-01-04_11-54-26-workflow-core-solution-plan.md:1;src/interfaces/api/routes/workflows.py:359;src/interfaces/api/routes/runs.py:238;src/interfaces/api/routes/runs.py:95;src/application/use_cases/append_run_event.py:53;src/application/services/async_run_event_recorder.py:52;web/src/hooks/useRunReplay.ts:1;src/interfaces/api/routes/workflows.py:582;src/infrastructure/database/repositories/run_event_repository.py:20;tests/integration/api/runs/test_run_events_replay_api.py:108;tests/integration/api/workflows/test_run_event_persistence.py:152,picked_reason:P0 且大部分已具备，优先补齐终态唯一/断连收敛并闭环;done_at:2026-01-04;evidence:pytest -q tests/integration/api/runs/test_run_events_replay_api.py tests/integration/api/workflows/test_run_event_persistence.py (5 passed);acceptance:POST runs Idempotency-Key 已支持；execute/stream run门禁400/409；终态事件对 execution channel 去重；异常/断连后不再追加第二终态;risk:low 仅终态去重与异常分支收敛
WFCORE-030,P0,3,backend,执行链路同源：REST 与 WorkflowAgent 共用权威执行编排入口,在 Application 层建立单一“权威执行编排入口”，包含 run 门禁、状态机、事件落库、成功判定；REST 与 WorkflowAgent 均委托该入口执行。,REST execute/stream 与 WorkflowAgent execute_workflow 执行同一入口；两入口对同一 workflow_id/run_id/input 的事件类型集合与终态一致；成功判定=终态事件+RunStatus 一致；WorkflowAgent 不再绕过 run 门禁/落库/状态机。,AUTOSERVER,Review：确认 DDD 边界（监督/落库/判定在 Application，路由仅 DTO）；确认 WorkflowAgent 不保留第二套执行语义；确认错误码与事件契约一致。,回归：对比 REST 与 WorkflowAgent 的事件序列与 RunStatus；异常/超时/断连路径一致；回放可复现两入口相同结论。,已完成,已完成,已完成,已提交,,plan/2026-01-04_11-54-26-workflow-core-solution-plan.md:1;src/application/services/workflow_run_execution_entry.py:27;src/interfaces/api/routes/workflows.py:407;src/interfaces/api/main.py:129;src/interfaces/api/container.py:34;src/domain/agents/workflow_agent.py:2349;src/application/use_cases/append_run_event.py:53;tests/integration/api/workflows/test_workflow_agent_execution_kernel_unification.py:1,picked_reason:P0 且需消除 REST/Agent 执行语义分叉;done_at:2026-01-04;evidence:pytest -q tests/integration/api/workflows/test_workflow_agent_execution_kernel_unification.py tests/integration/api/workflows/test_run_event_persistence.py tests/integration/api/runs/test_run_events_replay_api.py (7 passed);acceptance:REST 与 Agent 共用 WorkflowRunExecutionEntry；Agent 路径不再绕过 run gate/落库/状态机；Gate: completed run 不能二次执行（测试覆盖）;risk:low 仅收敛编排入口，外部事件契约不变
WFCORE-040,P0,4,backend,workflow 默认强制 LangGraph（仅紧急回滚且可审计）,把 workflow 执行默认切到 LangGraphWorkflowExecutorAdapter，legacy engine 仅紧急回滚；保证外部事件契约不变。,默认配置 enable_langgraph_workflow_executor=true；LangGraph adapter 可运行且产生 node_*/workflow_* 事件；紧急回滚开关存在且启用时记录审计（启用人/时间/范围）；LangGraph/回滚路径对外事件字段与类型集合一致。,AUTOSERVER,Review：确认 feature flag 默认值与部署配置一致；确认回滚不改变外部契约；确认无外网环境测试可跑。,回归：正常/异常路径事件语义一致；切换开关前后回放不需分支解析；性能无明显退化。,已完成,已完成,已完成,已提交,,plan/2026-01-04_11-54-26-workflow-core-solution-plan.md:1;src/application/services/workflow_execution_facade.py:25;src/infrastructure/lc_adapters/workflow/langgraph_workflow_executor_adapter.py:1;src/infrastructure/lc_adapters/workflow/langgraph_workflow_executor.py:1;src/config.py:134;src/config.py:149;src/application/services/workflow_execution_facade.py:31;tests/unit/application/services/test_workflow_execution_facade_langgraph_toggle.py:82,picked_reason:P0 且范围较小，先补齐 rollback 审计以满足 INV-8 门禁;done_at:2026-01-04;evidence:pytest -q tests/unit/application/services/test_workflow_execution_facade_langgraph_toggle.py (3 passed);acceptance:enable_langgraph_workflow_executor 默认 true；rollback 时记录审计日志 langgraph_workflow_executor_rollback_active(once);risk:low 仅新增审计字段与一次性warning日志
WFCORE-050,P1,5,backend,Tool/Node 统一可执行：落地 ToolNodeExecutor 并用 tool_id 作为真源,实现并注册 ToolNodeExecutor（NodeExecutorRegistry），通过 tool_id 从 ToolRepository 获取工具并对接 ToolEngine/运行时执行；保持 WorkflowSaveValidator 的 fail-closed 语义。,NodeExecutorRegistry 注册 tool executor；含 tool 节点 workflow 可通过保存校验并在 LangGraph 执行路径跑通；工具废弃/删除时保存/执行均 fail-closed 且返回结构化错误；无 name-based 引用。,AUTOSERVER,Review：确认 tool_id 是唯一引用；执行器对接 ToolEngine 的错误边界清晰（超时/取消/异常）；避免在 Interface 层做执行。,回归：工具下线/废弃/不存在；并发执行与超时；工具执行结果可回放/审计；不影响非工具节点执行。,已完成,已完成,已完成,已提交,,plan/2026-01-04_11-54-26-workflow-core-solution-plan.md:1;src/infrastructure/executors/tool_node_executor.py:35;src/infrastructure/executors/__init__.py:114;src/interfaces/api/main.py:296;src/interfaces/api/services/workflow_executor_adapter.py:46;src/domain/services/workflow_save_validator.py:57;tests/unit/infrastructure/executors/test_tool_node_executor.py:1;tests/unit/infrastructure/lc_adapters/workflow/test_langgraph_tool_node_execution.py:1,picked_reason:P1 但为 tool_id 真源与执行落地前置，先做以解阻塞 WFCORE-060;done_at:2026-01-04;evidence:pytest -q tests/unit/infrastructure/executors/test_tool_node_executor.py tests/unit/infrastructure/lc_adapters/workflow/test_langgraph_tool_node_execution.py (8 passed);acceptance:tool node 使用 tool_id 取 Tool 并用 ToolEngine 执行；missing/deprecated fail-closed;risk:medium ToolEngine 当前仅内置 echo/noop handler，其它 tool 执行器需后续补齐
WFCORE-060,P1,5,both,对话修改工具识别：受控生成 tool_id（禁止 name-based）,在 chat 修改链路引入“允许工具候选列表/约束”，确保 LLM 修改工作流时输出稳定 tool_id；必要时要求澄清/确认，而非猜测映射。,chat 修改生成 tool 节点时必含 config.tool_id 且 ToolRepository.exists=TRUE；无 tool_id 的工具节点保存被拒绝（missing_tool_id）；工具重命名不影响引用；拖拽与对话修改对同一工具节点校验一致。,AUTOE2E,Review：确认候选列表来源权威（ToolRepository）且不会泄露敏感信息；确认错误返回结构化可在UI呈现。,回归：工具数量增多时仍稳定；多轮修改不会把 tool_id 漂移成 name；与拖拽保存校验一致。,已完成,已完成,已完成,已提交,,plan/2026-01-04_11-54-26-workflow-core-solution-plan.md:1;src/interfaces/api/routes/workflows.py:816;src/domain/services/workflow_save_validator.py:57;src/domain/services/workflow_chat_service_enhanced.py:515;src/interfaces/api/routes/workflows.py:275;tests/unit/domain/services/test_workflow_chat_service_enhanced.py:198;tests/unit/application/use_cases/test_update_workflow_by_chat.py:371,picked_reason:P1 且是后续 WFCORE-070/080 的前置（工具引用稳定）;done_at:2026-01-04;evidence:pytest -q tests/unit/domain/services/test_workflow_chat_service_enhanced.py::test_build_system_prompt_includes_tool_id_constraints_and_candidates tests/unit/application/use_cases/test_update_workflow_by_chat.py::test_execute_validation_error_propagates_and_does_not_save;acceptance:chat prompt 支持 tool 节点并要求 config.tool_id 来自 ToolRepository.find_published；缺失/无效 tool_id 仍由 WorkflowSaveValidator fail-closed 并返回结构化 DomainValidationError;risk:low prompt 约束增强（保存校验不变）
WFCORE-070,P1,6,backend,Coordinator 监督补齐：tool_call 前置可拦截 + 去重策略链,补齐 Coordinator 对关键动作的监督：tool_call 在执行前必须进入可拦截决策；同时清理 Interface 层重复 new CoordinatorPolicyChain 的监督逻辑，统一下沉 Application policy chain。,"tool_call 发生前调用 CoordinatorPolicyChain enforce_action_or_raise(decision_type=""tool_call"")，被拒绝=403 且无副作用；对话/修改/执行的监督事件可审计；Interface 路由不再重复实现策略链（单一真源）。",AUTOSERVER,Review：确认 fail-closed；确认拒绝后不落库、不变更 run 状态；确认决策事件（validated/rejected）可观测且字段完整。,回归：模拟越权/偏航/注入；确认 tool_call 被拒绝会触发 replan/澄清；拒绝路径无副作用；日志与事件一致。,已完成,已完成,已完成,已提交,,plan/2026-01-04_11-54-26-workflow-core-solution-plan.md:1;src/application/services/coordinator_policy_chain.py:1;src/domain/agents/coordinator_agent.py:2134;src/domain/agents/conversation_agent_react_core.py:436;src/domain/agents/conversation_agent_react_core.py:457;src/application/services/coordinator_policy_chain.py:71;src/interfaces/api/routes/workflows.py:783;tests/unit/domain/agents/test_conversation_agent_emitter_integration.py:316,"picked_reason:P1 且为 WFCORE-080/090 前置（tool_call 可拦截监督）;done_at:2026-01-04;evidence:pytest -q tests/unit/domain/agents/test_conversation_agent_emitter_integration.py::TestToolCallEmission::test_tool_call_rejected_by_coordinator_emits_error_and_raises tests/integration/api/workflow_chat/test_chat_stream_react_api.py -k coordinator_rejection_emits_error_rollback_and_completes;acceptance:tool_call 执行前通过 CoordinatorPolicyChain(decision_type=""tool_call"") 可拦截；拒绝会 emit COORDINATOR_REJECTED 且不执行工具；CoordinatorPolicyChain 增加同一决策去重；workflow chat-stream 路由不再每步 new policy chain;risk:medium 对启用 coordinator 的 tool_call 增加 fail-closed 拦截（无 coordinator 时保持原行为）"
WFCORE-080,P1,7,backend,严格 ReAct：真实工具执行+Observation 可审计/可回放,为 ConversationAgent 注入真实 tool_call_executor，对接平台工具执行，并把 tool_call/tool_result 与 run 关联形成可回放审计记录。,每次 tool_call 都产生 tool_result（success/error）；Observation 来自真实执行（非内置假工具）；结果以 RunEvent（planning/execution channel）或等价机制可回放；单测/集成测证明非“只 emit 不执行”。,AUTOSERVER,Review：确认执行边界（超时/取消/异常）与数据脱敏；确认与 Coordinator 监督配合（先审后执）；避免网络依赖阻塞测试。,回归：无外网环境 mock 工具执行仍可通过；多轮工具调用不丢 observation；异常路径可回放复现。,已完成,已完成,已完成,已提交,,plan/2026-01-04_11-54-26-workflow-core-solution-plan.md:1;src/domain/agents/conversation_agent_react_core.py:436;src/application/use_cases/append_run_event.py:53;src/application/services/tool_call_executor.py:57;src/domain/services/tool_engine.py:972;src/application/services/conversation_agent_factory.py:44;tests/unit/domain/agents/test_conversation_agent_react_core.py:248,picked_reason:优先补齐严格 ReAct 的真实执行与可回放审计，后续计划互验/测试集依赖此能力;start_at:2026-01-04;done_at:2026-01-04;evidence:pytest -q tests/unit/domain/agents/test_conversation_agent_react_core.py -k tool_call | pytest -q tests/unit/domain/services/test_tool_engine.py -k knowledge_store;replay:ToolEngine knowledge_store records include metadata.tool_call_id for query_call_records replay;review:tool_call pre-exec supervised; CancelledError propagates; tool args not logged;risk:low offline-safe default tools echo/noop; unknown tools return tool_result error;blocked:git commit failed pyright reportAttributeAccessIssue;blocked_at:2026-01-04;unblocked_at:2026-01-04;git_fix:pyright cast Any for tool_call_executor
WFCORE-090,P1,7,backend,计划互验：WorkflowAgent 验证对话计划可达成并反馈 replanning,WorkflowAgent 对 ConversationAgent 产生的计划/执行请求做可达成性验证（tool_id/executor/run 门禁/资源约束），失败则拒绝并要求 replanning，形成可审计闭环。,执行前验证：tool_id 存在、executor 存在、run 存在且归属且状态可执行；失败返回结构化错误并记录审计事件；对话侧能收到反馈并 replanning；最终执行成功率提升可通过测试证明。,AUTOSERVER,Review：确认验证逻辑复用 WorkflowSaveValidator；确认拒绝路径不产生副作用；确认反馈消息不泄露敏感信息。,回归：构造不可达计划（缺 tool_id/工具不存在/缺 executor/非法 run status）必须被阻断；可达计划顺利执行；REST 与 WorkflowAgent 语义一致。,已完成,已完成,已完成,已提交,,plan/2026-01-04_11-54-26-workflow-core-solution-plan.md:1;src/domain/agents/workflow_agent.py:2347;src/domain/services/workflow_save_validator.py:57;src/domain/agents/workflow_agent.py:2325;src/application/services/conversation_agent_factory.py:57;tests/unit/domain/agents/test_workflow_agent_plan_validation_feedback.py:45,picked_reason:P1 backend，直接提升执行可靠性与可审计闭环，且为后续测试集(WFCORE-100)提供门禁与错误契约;start_at:2026-01-04;done_at:2026-01-04;evidence:pytest -q tests/unit/domain/agents/test_workflow_agent_plan_validation_feedback.py;review:execute_workflow failures from WorkflowRunExecutionEntry (uses WorkflowSaveValidator+run gate) return structured error + publish WorkflowAdjustmentRequestedEvent without leaking input;risk:low only affects execute_workflow when workflow_run_execution_entry injected; keeps not_supported path unchanged
WFCORE-100,P1,8,both,DDD 合规与验收测试集（不依赖外网）,启用/强化 import-linter 守门并修复关键链路越界；补齐覆盖10条不变式的自动化测试与回归集合。,CI 阻断新增越界；关键链路无 Interface→Domain Agents 直接依赖；测试覆盖：创建唯一、修改一致、run幂等与门禁、终态唯一与断连收敛、回放顺序、执行同源、LangGraph默认路径、tool executor、Coordinator拦截、严格ReAct、计划互验。,AUTOE2E,Review：确认测试可在无外网/无密钥环境运行（mock LLM/tools）；确认失败信息可定位到不变式编号。,回归：Windows/CI 环境稳定；并发/断连/异常场景纳入回归；性能无明显退化。,未开始,未开始,未开始,未提交,,plan/2026-01-04_11-54-26-workflow-core-solution-plan.md:1;Report.md:1;.import-linter.toml:1,
