{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://feagent.io/schemas/node-definition-v1.0.0.json",
  "title": "Feagent Node Definition Schema",
  "description": "通用节点 YAML 规范 - 自描述节点定义格式",
  "type": "object",
  "required": ["name", "kind", "version", "executor_type"],
  "properties": {
    "name": {
      "type": "string",
      "description": "节点唯一名称",
      "pattern": "^[a-z][a-z0-9_]*$",
      "minLength": 1,
      "maxLength": 64
    },
    "kind": {
      "type": "string",
      "description": "定义类型",
      "enum": ["node", "workflow", "template"]
    },
    "description": {
      "type": "string",
      "description": "节点描述",
      "maxLength": 500
    },
    "version": {
      "type": "string",
      "description": "语义化版本号",
      "pattern": "^[0-9]+\\.[0-9]+\\.[0-9]+(-[a-zA-Z0-9]+)?$"
    },
    "author": {
      "type": "string",
      "description": "作者名称",
      "maxLength": 100
    },
    "tags": {
      "type": "array",
      "description": "标签列表",
      "items": {
        "type": "string",
        "pattern": "^[a-z][a-z0-9-]*$",
        "maxLength": 32
      },
      "maxItems": 10
    },
    "category": {
      "type": "string",
      "description": "分类",
      "enum": ["data", "llm", "api", "code", "control", "container", "custom"]
    },
    "executor_type": {
      "type": "string",
      "description": "执行器类型",
      "enum": ["python", "llm", "http", "database", "container", "condition", "loop", "parallel", "api"]
    },
    "parameters": {
      "type": "array",
      "description": "输入参数列表",
      "items": {
        "$ref": "#/definitions/parameter"
      }
    },
    "returns": {
      "type": "object",
      "description": "返回值 Schema",
      "properties": {
        "type": {
          "type": "string",
          "enum": ["string", "number", "integer", "boolean", "array", "object", "null"]
        },
        "properties": {
          "type": "object",
          "additionalProperties": {
            "$ref": "#/definitions/returnProperty"
          }
        }
      }
    },
    "error_strategy": {
      "type": "object",
      "description": "错误处理策略",
      "properties": {
        "retry": {
          "type": "object",
          "properties": {
            "max_attempts": {
              "type": "integer",
              "minimum": 0,
              "maximum": 10,
              "default": 3
            },
            "delay_seconds": {
              "type": "number",
              "minimum": 0,
              "maximum": 300,
              "default": 1.0
            },
            "backoff_multiplier": {
              "type": "number",
              "minimum": 1.0,
              "maximum": 10.0,
              "default": 2.0
            }
          }
        },
        "on_failure": {
          "type": "string",
          "description": "失败时的处理动作",
          "enum": ["retry", "skip", "abort", "replan", "fallback"]
        },
        "fallback": {
          "type": "object",
          "description": "回退配置",
          "properties": {
            "node_name": {
              "type": "string"
            },
            "default_value": {}
          }
        }
      }
    },
    "nested": {
      "type": "object",
      "description": "嵌套节点声明",
      "properties": {
        "parallel": {
          "type": "boolean",
          "description": "是否并行执行子节点",
          "default": false
        },
        "children": {
          "type": "array",
          "description": "子节点列表",
          "items": {
            "$ref": "#/definitions/nestedChild"
          },
          "maxItems": 20
        },
        "max_depth": {
          "type": "integer",
          "description": "最大嵌套深度",
          "minimum": 1,
          "maximum": 5,
          "default": 5
        }
      }
    },
    "dynamic_code": {
      "type": "object",
      "description": "动态代码段",
      "properties": {
        "pre_execute": {
          "type": "string",
          "description": "执行前代码（Python）"
        },
        "post_execute": {
          "type": "string",
          "description": "执行后代码（Python）"
        },
        "transform": {
          "type": "string",
          "description": "数据转换代码（Python）"
        }
      }
    },
    "execution": {
      "type": "object",
      "description": "执行配置",
      "properties": {
        "timeout_seconds": {
          "type": "integer",
          "description": "执行超时时间（秒）",
          "minimum": 1,
          "maximum": 3600,
          "default": 60
        },
        "sandbox": {
          "type": "boolean",
          "description": "是否在沙箱中执行",
          "default": false
        },
        "memory_limit": {
          "type": "string",
          "description": "内存限制（如 256m, 1g）",
          "pattern": "^[0-9]+[kmg]$"
        },
        "cpu_limit": {
          "type": "string",
          "description": "CPU 限制（如 0.5, 1.0）",
          "pattern": "^[0-9]+(\\.[0-9]+)?$"
        }
      }
    }
  },
  "definitions": {
    "parameter": {
      "type": "object",
      "required": ["name", "type"],
      "properties": {
        "name": {
          "type": "string",
          "description": "参数名称",
          "pattern": "^[a-z][a-z0-9_]*$"
        },
        "type": {
          "type": "string",
          "description": "参数类型",
          "enum": ["string", "number", "integer", "boolean", "array", "object"]
        },
        "description": {
          "type": "string",
          "description": "参数描述"
        },
        "required": {
          "type": "boolean",
          "description": "是否必填",
          "default": false
        },
        "default": {
          "description": "默认值"
        },
        "enum": {
          "type": "array",
          "description": "枚举值列表"
        },
        "constraints": {
          "type": "object",
          "description": "约束条件",
          "properties": {
            "min": {
              "type": "number"
            },
            "max": {
              "type": "number"
            },
            "minLength": {
              "type": "integer"
            },
            "maxLength": {
              "type": "integer"
            },
            "pattern": {
              "type": "string"
            }
          }
        }
      }
    },
    "returnProperty": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "enum": ["string", "number", "integer", "boolean", "array", "object", "null"]
        },
        "description": {
          "type": "string"
        }
      }
    },
    "nestedChild": {
      "type": "object",
      "required": ["name", "executor_type"],
      "properties": {
        "name": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9_]*$"
        },
        "executor_type": {
          "type": "string",
          "enum": ["python", "llm", "http", "database", "container", "condition", "loop", "parallel", "api"]
        },
        "parameters": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/parameter"
          }
        },
        "nested": {
          "$ref": "#/properties/nested"
        }
      }
    }
  }
}
