name: CI

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]
  schedule:
    - cron: '0 2 * * *' # 2am UTC daily (nightly fullreal E2E)

jobs:
  # Backend CI
  backend:
    name: Backend (Python)
    runs-on: ubuntu-latest
    if: github.event_name != 'schedule'
    strategy:
      matrix:
        python-version: ["3.11", "3.12"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: |
          uv venv
          source .venv/bin/activate
          uv pip install -e ".[dev]"

      - name: Run Ruff (Lint)
        run: |
          source .venv/bin/activate
          ruff check src tests

      - name: Run Ruff (Format Check)
        run: |
          source .venv/bin/activate
          ruff format --check src tests

      - name: Run Pyright (Type Check)
        run: |
          source .venv/bin/activate
          pyright src

      - name: Run Import Linter (DDD Boundaries)
        run: |
          source .venv/bin/activate
          lint-imports --config .import-linter.toml

      - name: Run DDD Boundary Checks (Fast)
        run: |
          source .venv/bin/activate
          python scripts/ddd_boundary_checks.py

      - name: Run Pytest (Unit Tests)
        run: |
          source .venv/bin/activate
          pytest tests/unit -v --cov=src --cov-report=xml --cov-report=term

      - name: Run Pytest (Integration Tests)
        run: |
          source .venv/bin/activate
          pytest tests/integration -v

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: backend
          name: backend-coverage

  # Frontend CI
  frontend:
    name: Frontend (React + TypeScript)
    runs-on: ubuntu-latest
    if: github.event_name != 'schedule'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: web/package-lock.json

      - name: Install dependencies
        working-directory: ./web
        run: npm ci

      - name: Run ESLint
        working-directory: ./web
        run: npm run lint

      - name: Run Type Check
        working-directory: ./web
        run: npm run type-check

      - name: Run Tests
        working-directory: ./web
        run: npm run test

      - name: Build
        working-directory: ./web
        run: npm run build

  # Database Migration Check
  database:
    name: Database Migration Check
    runs-on: ubuntu-latest
    if: github.event_name != 'schedule'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: |
          uv venv
          source .venv/bin/activate
          uv pip install -e ".[dev]"

      - name: Check Alembic migrations
        run: |
          source .venv/bin/activate
          alembic check

  # Security Check
  security:
    name: Security Check
    runs-on: ubuntu-latest
    if: github.event_name != 'schedule'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: |
          uv venv
          source .venv/bin/activate
          uv pip install -e ".[dev]"

      - name: Run Bandit (Security Linter)
        run: |
          source .venv/bin/activate
          pip install bandit
          bandit -r src -ll

      - name: Run Safety (Dependency Check)
        run: |
          source .venv/bin/activate
          pip install safety
          safety check --json || true

  e2e-deterministic:
    name: E2E (Deterministic)
    runs-on: ubuntu-latest
    if: github.event_name != 'schedule'
    needs: [backend, frontend]
    env:
      ENV: test
      ENABLE_TEST_SEED_API: "true"
      E2E_TEST_MODE: deterministic
      LLM_ADAPTER: stub
      HTTP_ADAPTER: mock
      PLAYWRIGHT_API_URL: http://127.0.0.1:8000

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install backend dependencies
        run: |
          uv venv
          source .venv/bin/activate
          uv pip install -e ".[dev]"

      - name: Start backend
        run: |
          source .venv/bin/activate
          uvicorn src.interfaces.api.main:app --host 127.0.0.1 --port 8000 &
          echo $! > backend.pid
          sleep 2

      - name: Wait for backend health
        run: |
          curl http://127.0.0.1:8000/health --retry 10 --retry-delay 2 --retry-connrefused

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: web/package-lock.json

      - name: Install frontend dependencies
        working-directory: ./web
        run: npm ci

      - name: Install Playwright browsers
        working-directory: ./web
        run: npx playwright install --with-deps chromium

      - name: Run E2E tests (Deterministic)
        working-directory: ./web
        run: npx playwright test --project=deterministic

      - name: Upload Playwright artifacts (Deterministic)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-deterministic-artifacts
          path: |
            web/playwright-report
            web/test-results
            web/test-results.json
          retention-days: 7

      - name: Stop backend
        if: always()
        run: |
          if [ -f backend.pid ]; then
            kill "$(cat backend.pid)" || true
          fi

  e2e-fullreal:
    name: E2E (Full-real Nightly)
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    env:
      ENV: test
      ENABLE_TEST_SEED_API: "true"
      E2E_TEST_MODE: fullreal
      LLM_ADAPTER: openai
      HTTP_ADAPTER: httpx
      PLAYWRIGHT_API_URL: http://127.0.0.1:8000
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Ensure OpenAI key is configured
        run: |
          test -n "$OPENAI_API_KEY"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install backend dependencies
        run: |
          uv venv
          source .venv/bin/activate
          uv pip install -e ".[dev]"

      - name: Start backend
        run: |
          source .venv/bin/activate
          uvicorn src.interfaces.api.main:app --host 127.0.0.1 --port 8000 &
          echo $! > backend.pid
          sleep 2

      - name: Wait for backend health
        run: |
          curl http://127.0.0.1:8000/health --retry 10 --retry-delay 2 --retry-connrefused

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: web/package-lock.json

      - name: Install frontend dependencies
        working-directory: ./web
        run: npm ci

      - name: Install Playwright browsers
        working-directory: ./web
        run: npx playwright install --with-deps chromium

      - name: Run E2E tests (Full-real)
        working-directory: ./web
        run: npx playwright test --project=fullreal

      - name: Upload Playwright artifacts (Full-real)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-fullreal-artifacts
          path: |
            web/playwright-report
            web/test-results
            web/test-results.json
          retention-days: 14

      - name: Stop backend
        if: always()
        run: |
          if [ -f backend.pid ]; then
            kill "$(cat backend.pid)" || true
          fi
