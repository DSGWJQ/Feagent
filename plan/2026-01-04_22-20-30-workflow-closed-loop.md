---
mode: plan
cwd: D:\My_Project\agent_data
task: åŸºäº Report.md çš„ Workflow æ ¸å¿ƒé“¾è·¯é—­ç¯æ•´æ”¹è®¡åˆ’ï¼ˆCoordinator-centricï¼‰
complexity: complex
planning_method: builtin
created_at: 2026-01-04T22:20:45+08:00
---

# Plan: Workflow æ ¸å¿ƒé“¾è·¯é—­ç¯æ•´æ”¹ï¼ˆåŸºäº Report.mdï¼‰

ğŸ¯ ä»»åŠ¡æ¦‚è¿°

æœ¬è®¡åˆ’ä»¥ `Report.md` çš„å®¡è®¡ç»“è®ºä¸ºåŸºçº¿ï¼Œè¡¥é½ â€œCoordinatorAgent ç›‘ç£é—­ç¯ + WorkflowAgent åŒæºæ‰§è¡Œâ€ çš„å…³é”®ç¼ºå£ï¼Œå¹¶å°†â€œå…¥å£å”¯ä¸€æ€§/æ‰§è¡Œäº‹å®æº/äº‹ä»¶è¯­ä¹‰åˆåŒâ€å›ºåŒ–ä¸ºå¯éªŒè¯çš„å·¥ç¨‹åˆåŒï¼ˆæµ‹è¯• + é™æ€çº¦æŸ + å›æ»šç­–ç•¥ï¼‰ã€‚ç›®æ ‡æ˜¯æŠŠå½“å‰çš„â€œè®¾è®¡æ„å›¾â€è½æˆâ€œç”Ÿäº§ä¸»é“¾è·¯çš„ç¡¬æ¥çº¿â€ï¼Œå¹¶ç”¨ç«¯åˆ°ç«¯è¯æ®é“¾å®ŒæˆéªŒæ”¶ã€‚

åˆåŒå†»ç»“å…¥å£ï¼š`docs/architecture/workflow_closed_loop_contract.md`ã€‚

---

## ğŸ¯ ç›®æ ‡ä¸äº¤ä»˜ç‰©

### ç›®æ ‡ï¼ˆé¢å‘æœ€ç»ˆéªŒæ”¶ï¼‰

1. **æ‰§è¡Œé“¾è·¯ä¸ WorkflowAgent åŒæº**ï¼švalidated decision èƒ½è¢«æ¡¥æ¥åˆ° WorkflowAgentï¼Œå¹¶ä»¥åŒä¸€ `run_id` ä½œä¸ºå”¯ä¸€äº‹å®æºæ‰§è¡Œä¸å›æ”¾ã€‚
2. **Coordinator ç›‘ç£ç»å¯¹ fail-closed**ï¼šæ‰€æœ‰å¯¹è¯å…¥å£ï¼ˆå« `chat-create/stream`ï¼‰åœ¨ coordinator ç¼ºå¤±/æœªé…ç½®æ—¶å¿…é¡»æ‹’ç»ï¼Œè€Œéæ—è·¯æ”¾è¡Œã€‚
3. **å…¥å£å”¯ä¸€æ€§å¯æ‰§è¡ŒåˆåŒåŒ–**ï¼šå†…éƒ¨åˆ›å»ºå…¥å£çš„å¯è¾¾æ€§ã€å¯ç”¨æ¡ä»¶ã€å®¡è®¡ä¸å›æ»šè¯­ä¹‰è¢«æ˜ç¡®å¹¶ç”±æµ‹è¯•/CI çº¦æŸä¿è¯ã€‚

### äº¤ä»˜ç‰©ï¼ˆå¯è¿½è¸ªï¼‰

- å˜æ›´è¯´æ˜ï¼ˆADR/è®¾è®¡è¯´æ˜ï¼‰ï¼š
  - é—­ç¯äº‹ä»¶é“¾è·¯ä¸ run_id å…³è”æ–¹å¼
  - feature flagsï¼ˆå¦‚ `disable_run_persistence`ã€å†…éƒ¨åˆ›å»ºå¼€å…³ï¼‰çš„äº§å“è¯­ä¹‰ä¸è¿ç»´ç­–ç•¥
- è‡ªåŠ¨åŒ–éªŒæ”¶èµ„äº§ï¼š
  - æ–°å¢/å¼ºåŒ–çš„é›†æˆæµ‹è¯•ï¼ˆvalidated decision â†’ RunEvents â†’ replayï¼‰
  - æ–°å¢/å¼ºåŒ–çš„é—¨ç¦æµ‹è¯•ï¼ˆchat-create fail-closedï¼‰
  - CI é™æ€çº¦æŸï¼ˆå…¥å£å”¯ä¸€æ€§/ä¾èµ–è¾¹ç•Œï¼‰
- å¯è§‚æµ‹æ€§ä¸å®¡è®¡ï¼š
  - coordinator allow/denyã€bridge start/stopã€execution correlation çš„æ—¥å¿—/æŒ‡æ ‡/å®¡è®¡äº‹ä»¶

---

## ğŸ“‹ æ‰§è¡Œè®¡åˆ’ï¼ˆ8â€“10 æ­¥ï¼‰

### Phase 1ï¼šå¯¹é½â€œç¡¬å‰æâ€ä¸ç³»ç»ŸåˆåŒï¼ˆå†»ç»“èŒƒå›´ï¼‰

1. **ç¡®è®¤éªŒæ”¶å£å¾„ä¸ç¦åŒºï¼ˆScope / Out of scopeï¼‰**
   - æŠŠ `Report.md` çš„ 10 æ¡é¡¹ç›®å‰æè½¬ä¸ºå¯æµ‹è¯•çš„éªŒæ”¶æ¡ç›®ï¼Œæ˜ç¡®å“ªäº›æ˜¯â€œå¿…é¡» fail-closedâ€çš„ç¡¬å‰æã€‚
   - æ˜ç¡®ä¸åšçš„äº‹ï¼šä¾‹å¦‚æ˜¯å¦è¿›è¡Œå¤§è§„æ¨¡ DDD é‡æ„ã€æ˜¯å¦æ›´æ¢äº‹ä»¶æ€»çº¿å®ç°ç­‰ï¼ˆéµå¾ª KISS/YAGNIï¼‰ã€‚
2. **å†»ç»“å…³é”®åˆåŒä¸æœ¯è¯­ï¼ˆrun_id / decision / event contractï¼‰**
   - ç»Ÿä¸€å¯¹ â€œvalidated decisionâ€ çš„å®šä¹‰ï¼šæ¥æºã€ç­¾åå­—æ®µã€æˆæƒè¾¹ç•Œã€å¹‚ç­‰é”®ã€‚
   - å†»ç»“äº‹ä»¶è¯­ä¹‰ï¼šå…è®¸çš„ event typesã€ç»ˆæ€è§„åˆ™ã€é”™è¯¯è¯­ä¹‰ä¸æŒä¹…åŒ–è¦æ±‚ã€‚

### Phase 2ï¼šè¡¥é½ validated decision â†’ WorkflowAgent çš„â€œç¡¬æ¥çº¿â€

3. **è®¾è®¡å¹¶è½åœ° DecisionExecutionBridge çš„å¯åŠ¨ä¸ç”Ÿå‘½å‘¨æœŸç®¡ç†**
   - æ˜ç¡® bridge çš„å¯åŠ¨ç‚¹ï¼ˆä¾‹å¦‚ API app å¯åŠ¨æ—¶æ³¨å†Œåˆ° EventBusï¼‰ã€åœæœºå¤„ç†ä¸é”™è¯¯éš”ç¦»ç­–ç•¥ã€‚
   - çº¦æŸ bridge åªæ¶ˆè´¹ coordinator â€œå·²éªŒè¯/å·²å…è®¸â€ çš„ decisionï¼ˆå®‰å…¨é»˜è®¤æ‹’ç»ï¼‰ã€‚
4. **WorkflowAgent æ³¨å…¥ç»Ÿä¸€æ‰§è¡Œå…¥å£ï¼ˆWorkflowRunExecutionEntryPortï¼‰**
   - å°† WorkflowAgent çš„æ‰§è¡Œå§”æ‰˜åˆ° `WorkflowRunExecutionEntry`ï¼ˆæˆ–å…¶ portï¼‰ï¼Œç¡®ä¿æ‰§è¡Œäº‹å®æºæ”¶æ•›ã€‚
   - ç»Ÿä¸€ run_idï¼šdecision å¿…é¡»æºå¸¦/æ˜ å°„åˆ°å”¯ä¸€ run_idï¼›ç¦æ­¢ bridge éšå¼ç”Ÿæˆä¸å¯è¿½è¸ª run_idã€‚
5. **å¹‚ç­‰ä¸é‡å…¥é˜²æŠ¤ï¼ˆé˜²æ­¢é‡å¤æ‰§è¡Œ/é‡å¤è½äº‹ä»¶ï¼‰**
   - å®šä¹‰å¹‚ç­‰é”®ï¼ˆä¾‹å¦‚ decision_id + run_idï¼‰å¹¶åœ¨å…¥å£å¤„ fail-closed å»é‡ã€‚
   - æ˜ç¡®å¹¶éªŒè¯ï¼šåŒä¸€ decision çš„é‡å¤æŠ•é€’ä¸ä¼šäº§ç”Ÿç¬¬äºŒæ¡æ‰§è¡Œæˆ–é‡å¤ RunEventsã€‚

### Phase 3ï¼šä¿®å¤ chat-create çš„ç›‘ç£æ—è·¯ï¼ˆfail-open â†’ fail-closedï¼‰

6. **å°† chat-create preflight gate è°ƒæ•´ä¸º fail-closedï¼Œå¹¶è¡¥é½æµ‹è¯•**
   - æ˜ç¡®ç¼ºå¤± coordinator æ—¶çš„ HTTP è¡Œä¸ºï¼ˆçŠ¶æ€ç /é”™è¯¯ä½“/ä¸äº§ç”Ÿå‰¯ä½œç”¨ï¼‰ã€‚
   - æ›´æ–°/æ–°å¢æµ‹è¯•è¦†ç›–â€œè¯¯é…ç½®/æœ€å°åŒ–éƒ¨ç½²/æµ‹è¯• appâ€çš„æ—è·¯åœºæ™¯ã€‚

### Phase 4ï¼šå…¥å£å”¯ä¸€æ€§åˆåŒåŒ–ï¼ˆé˜²æ—è·¯ã€å¯å›æ»šï¼‰

7. **å†…éƒ¨åˆ›å»ºå…¥å£çš„äº§å“è¯­ä¹‰ä¸å·¥ç¨‹é—¨ç¦**
   - æ˜ç¡®å†…éƒ¨åˆ›å»ºå…¥å£é»˜è®¤ä¸å¯è¾¾çš„åˆåŒï¼ˆä¾‹å¦‚ 410/403 ä¸å®¡è®¡è¦æ±‚ï¼‰ã€‚
   - è‹¥å…è®¸å¯ç”¨ï¼šå¿…é¡»å…·å¤‡å®¡è®¡äº‹ä»¶ã€éš”ç¦»ç­–ç•¥ã€å›æ»šé¢„æ¡ˆï¼ˆé¿å…å‹åŠ›ä¸‹æˆä¸ºæ—è·¯ï¼‰ã€‚
8. **é™æ€çº¦æŸä¸ CI æ£€æŸ¥**
   - åœ¨ CI ä¸­åŠ å…¥â€œå…¥å£å”¯ä¸€æ€§â€æ£€æµ‹ï¼ˆä¾‹å¦‚ç¦æ­¢æ–°å¢æœªç»æ‰¹å‡†çš„ `/api/workflows*` åˆ›å»ºå…¥å£ï¼‰ã€‚
   - å¼ºåŒ– import-linter æˆ–å¢åŠ è‡ªå®šä¹‰è„šæœ¬ä»¥å®ˆä½åˆ†å±‚è¾¹ç•Œä¸å…¥å£åˆåŒã€‚

### Phase 5ï¼šç«¯åˆ°ç«¯è¯æ®é“¾éªŒæ”¶ + å¯è§‚æµ‹æ€§

9. **æ–°å¢/å¼ºåŒ–ç«¯åˆ°ç«¯é›†æˆæµ‹è¯•ï¼švalidated decision â†’ RunEvents â†’ replay ä¸€è‡´**
   - è¦†ç›–æˆåŠŸ/å¤±è´¥/æ‹’ç»/é‡å¤æŠ•é€’/bridge å¼‚å¸¸ç­‰è·¯å¾„ã€‚
   - ç”¨åŒä¸€ run_id éªŒè¯ï¼šSSE æµä¸ replay API çš„äº‹ä»¶åºåˆ—ä¸€è‡´ã€ç»ˆæ€ä¸€è‡´ã€‚
10. **ä¸Šçº¿ç­–ç•¥ä¸å›æ»šï¼ˆç°åº¦/å¼€å…³/é™çº§ï¼‰**
   - å°†æ–°æ¡¥æ¥é“¾è·¯ç½®äº feature flag ä¸‹ç°åº¦ï¼ˆé»˜è®¤ off æˆ–å¯æ§ onï¼Œå–å†³äºä½ çš„â€œå‰æå¿…é¡»æˆç«‹â€çš„å¼ºåº¦ï¼‰ã€‚
   - æ˜ç¡®å½“ bridge å¼‚å¸¸æ—¶ç³»ç»Ÿåº”å¦‚ä½• fail-closedï¼ˆæ‹’ç»æ‰§è¡Œã€è®°å½•å®¡è®¡ã€ä¸ç»™â€œå‡æˆåŠŸâ€ï¼‰ã€‚

---

## âœ… å…¨é¢éªŒæ”¶æ ‡å‡†ï¼ˆå¯è‡ªåŠ¨åŒ–éªŒè¯ï¼‰

> æ¯æ¡æ ‡å‡†éƒ½åº”è‡³å°‘å¯¹åº”ï¼š1) è‡ªåŠ¨åŒ–æµ‹è¯•ï¼›2) è¿è¡Œæ—¶æ—¥å¿—/æŒ‡æ ‡å¯è§‚æµ‹ï¼›3) æ˜ç¡®çš„å¤±è´¥è¯­ä¹‰ï¼ˆfail-closedï¼‰ã€‚

### A. æ‰§è¡Œé“¾è·¯ = WorkflowAgentï¼ˆåŒæºæ‰§è¡Œï¼‰

- validated decision è¢«å…è®¸åï¼Œç³»ç»Ÿä¼šè§¦å‘ WorkflowAgent æ‰§è¡Œï¼ˆä¸æ˜¯ä»… API kernel è·¯å¾„ï¼‰ï¼Œä¸”æ‰§è¡Œå…¥å£ç»Ÿä¸€è½åœ¨ `WorkflowRunExecutionEntry`ï¼ˆæˆ–å…¶ portï¼‰ã€‚
- ä»»ä¸€æ‰§è¡Œéƒ½å¿…é¡»ç»‘å®šå”¯ä¸€ `run_id`ï¼Œä¸”ï¼š
  - `execute/stream` çš„é¦–ä¸ªå…³é”®äº‹ä»¶åŒ…å«è¯¥ `run_id`ï¼ˆæˆ– metadata ä¸­å¯è¿½è¸ªï¼‰ã€‚
  - `GET /api/runs/{run_id}/events` å›æ”¾äº‹ä»¶ä¸ SSE æµåœ¨**äº‹ä»¶ç±»å‹é›†åˆã€é¡ºåºçº¦æŸã€ç»ˆæ€**ä¸Šä¿æŒä¸€è‡´ã€‚
- æ‰§è¡ŒæˆåŠŸåˆ¤å®šä»¥ Run + RunEvents ä¸ºå”¯ä¸€äº‹å®æºï¼šä¸å¾—å‡ºç°â€œç”¨æˆ·çœ‹åˆ°æˆåŠŸä½† RunEvents ç¼ºå¤±/ä¸ä¸€è‡´â€ã€‚

### B. Coordinator ç›‘ç£ç»å¯¹æ€§ï¼ˆfail-closedï¼‰

- ä»»ä¸€å¯¹è¯å…¥å£åœ¨ coordinator ç¼ºå¤±/æœªé…ç½®/ä¸å¯ç”¨æ—¶å¿…é¡»æ‹’ç»è¯·æ±‚ï¼ˆfail-closedï¼‰ï¼Œè‡³å°‘åŒ…å«ï¼š
  - `POST /api/workflows/chat-create/stream`
  - workflow chat ä¿®æ”¹å…¥å£ï¼ˆ`chat-stream`ï¼‰
  - conversation stream å…¥å£
- æ‹’ç»æ—¶ä¸å¾—äº§ç”Ÿå‰¯ä½œç”¨ï¼šä¸åˆ›å»º workflowã€ä¸åˆ›å»º runã€ä¸å†™å…¥ eventsï¼ˆé™¤éæ˜¯æ˜ç¡®çš„å®¡è®¡æ‹’ç»äº‹ä»¶ï¼‰ã€‚

### C. åªæ‰§è¡Œâ€œå·²éªŒè¯/å·²å…è®¸â€çš„ decision

- deny çš„ decision ä¸ä¼šè§¦å‘æ‰§è¡Œï¼›ç³»ç»Ÿä¼šäº§ç”Ÿå¯è¿½è¸ªçš„å®¡è®¡è®°å½•ï¼ˆåŒ…å« decision_idã€åŸå› ã€actorã€correlation/run_idï¼‰ã€‚
- allow çš„ decision æ‰ä¼šè¿›å…¥ bridge â†’ executorï¼Œå¹¶ä¸” decision çš„å­—æ®µæ ¡éªŒï¼ˆç¼ºå­—æ®µ/éæ³•å­—æ®µ/ç­¾åä¸ä¸€è‡´ï¼‰å¿…é¡» fail-closedã€‚

### D. å¹‚ç­‰æ€§ä¸é‡å…¥å®‰å…¨

- åŒä¸€ decisionï¼ˆæˆ–åŒä¸€å¹‚ç­‰é”®ï¼‰é‡å¤æŠ•é€’ä¸ä¼šäº§ç”Ÿé‡å¤ RunEventsã€é‡å¤ç»ˆæ€ã€é‡å¤å‰¯ä½œç”¨ã€‚
- bridge é‡å¯/äº‹ä»¶é‡æ”¾ä¸ä¼šå¯¼è‡´â€œäºŒæ¬¡æ‰§è¡Œâ€ï¼›æœ€å¤šäº§ç”Ÿä¸€æ¬¡å¯å®¡è®¡çš„â€œduplicate droppedâ€è®°å½•ã€‚

### E. å…¥å£å”¯ä¸€æ€§ä¸æ—è·¯é˜²æŠ¤

- é»˜è®¤æƒ…å†µä¸‹å†…éƒ¨åˆ›å»ºå…¥å£ä¸å¯è¾¾ï¼Œå¹¶æœ‰æµ‹è¯•é”å®šå…¶è¡Œä¸ºï¼ˆçŠ¶æ€ç  + å®¡è®¡è¦æ±‚ï¼‰ã€‚
- CI èƒ½é˜»æ­¢æ–°å¢æœªç»æ‰¹å‡†çš„ workflow åˆ›å»ºæ—è·¯ï¼ˆè„šæœ¬/è§„åˆ™åœ¨ PR é˜¶æ®µå¯è§ã€å¯å¤±è´¥ï¼‰ã€‚

### F. äº‹ä»¶è¯­ä¹‰åˆåŒä¸é”™è¯¯å¤„ç†

- è¿åäº‹ä»¶åˆåŒçš„è¾“å‡ºå¿…é¡»è¢« fail-closedï¼šäº§å‡º `workflow_error` å¹¶å½¢æˆç»ˆæ€è½åº“ï¼ˆä¸” replay å¯è§ï¼‰ã€‚
- åœ¨ bridge / executor å¼‚å¸¸æ—¶ï¼š
  - ä¸å¾—è¿”å›â€œå‡æˆåŠŸâ€ï¼›
  - å¿…é¡»ç•™ä¸‹å¯è¿½è¸ªé”™è¯¯äº‹ä»¶æˆ–å®¡è®¡è®°å½•ï¼›
  - ç³»ç»Ÿèƒ½è¢«æ˜ç¡®å›æ»šåˆ°å®‰å…¨æ¨¡å¼ï¼ˆå…³é—­æ¡¥æ¥ã€æ‹’ç»æ‰§è¡Œæˆ–å›é€€åˆ°æ˜ç¡®çš„ legacy è¯­ä¹‰ï¼‰ã€‚

### G. DDD / åˆ†å±‚è¾¹ç•Œï¼ˆä¸è¶Šç•Œï¼‰

- import-linter ä¸æ–°å¢çš„è¾¹ç•Œ/å…¥å£åˆåŒæ£€æŸ¥åœ¨ CI ä¸­é€šè¿‡ï¼›ä»»ä½•è¶Šç•Œæˆ–æ—è·¯æ–°å¢éƒ½ä¼šè¢«é˜»æ–­ã€‚

---

## ğŸ§ª æµ‹è¯•ä¸éªŒè¯ï¼ˆå»ºè®®å‘½ä»¤ï¼‰

åç«¯ï¼ˆæ ¸å¿ƒé“¾è·¯å›å½’ï¼‰ï¼š

- `pytest -q tests/integration/api/workflow_chat/test_chat_create_stream_api.py`
- `pytest -q tests/integration/api/workflow_chat/test_chat_stream_react_api.py`
- `pytest -q tests/integration/api/workflows/test_run_event_persistence.py`
- `pytest -q tests/integration/api/runs/test_run_events_replay_api.py`
- `lint-imports --config .import-linter.toml`

å‰ç«¯ï¼ˆRun ä¸€è‡´æ€§ä¸åè®®æ¶ˆè´¹ï¼‰ï¼š

- `cd web && npm test`

ä¸€é”®ï¼ˆä»“åº“è„šæœ¬ï¼‰ï¼š

- `powershell -ExecutionPolicy Bypass -File scripts/workflow_core_checks.ps1`

---

## âš ï¸ é£é™©ä¸æ³¨æ„äº‹é¡¹ï¼ˆçº¢é˜Ÿè§†è§’ï¼‰

- **æ¡¥æ¥æ¥çº¿çš„â€œå®‰å…¨é»˜è®¤â€**ï¼šbridge å¿…é¡»åªæ¶ˆè´¹ coordinator allow çš„ decisionï¼›ä»»ä½•â€œç¼ºå­—æ®µ/æ— æ³•éªŒè¯/æ¥æºä¸æ˜â€éƒ½åº”ç›´æ¥æ‹’ç»ï¼ˆé¿å…å¼•å…¥æ–°æ—è·¯ï¼‰ã€‚
- **å¹‚ç­‰ä¸äº‹ä»¶é‡æ”¾**ï¼šäº‹ä»¶é©±åŠ¨é“¾è·¯å¤©ç„¶ä¼šå‡ºç°é‡å¤æŠ•é€’/é‡æ”¾ï¼Œå¿…é¡»åœ¨å…¥å£å±‚åšç¡®å®šæ€§å»é‡ï¼Œå¦åˆ™ä¼šé€ æˆé‡å¤æ‰§è¡Œæˆ– RunEvents æ±¡æŸ“ã€‚
- **feature flag è¯­ä¹‰å†²çª**ï¼šå¦‚ `disable_run_persistence` çš„ 410 è¡Œä¸ºä¼šç ´åâ€œRun ä¸ºäº‹å®æºâ€çš„ç¡¬å‰æï¼Œéœ€è¦æ˜ç¡®å®ƒæ˜¯â€œä¸´æ—¶å›æ»šå¼€å…³â€è¿˜æ˜¯â€œé•¿æœŸæ”¯æŒæ¨¡å¼â€ã€‚
- **æµ‹è¯•ç¯å¢ƒè¯¯é…**ï¼šè¿‡å»çš„ fail-open ä¼šè®©æµ‹è¯•åœ¨æ—  coordinator æ—¶â€œå‡é€šè¿‡â€ï¼›ä¿®å¤åéœ€åŒæ­¥æ›´æ–°æµ‹è¯•è£…é…ä¸ fixturesã€‚

---

## ğŸ“ å‚è€ƒï¼ˆæ¥è‡ª Report.md çš„å…³é”®è¯æ®ç‚¹ï¼‰

- `src/domain/services/decision_execution_bridge.py:1`
- `src/domain/agents/workflow_agent.py:2361`
- `src/application/services/workflow_run_execution_entry.py:1`
- `src/interfaces/api/routes/workflows.py:427`
- `src/interfaces/api/routes/workflows.py:563`
- `src/application/services/conversation_turn_orchestrator.py:269`
- `.import-linter.toml:10`
