---
mode: plan
cwd: D:\\My_Project\\agent_data
task: 根据 Report.md 生成可落地技术执行计划（围绕协调者 Agent 为核心）
complexity: complex
planning_method: builtin
created_at: 2026-01-02T21:54:47.2391954+08:00
---

# Plan: 协调者为核心的工作流闭环落地

🎯 任务概述
本计划基于 Report.md 的审计结论，目标是把「协调者 Agent 作为守门人」落到可运行的端到端闭环：对话进入→决策生成→协调者验证/纠偏→工作流修改/执行→真实 Observation 回传→一致的 Run/事件/状态。
当前存在 P0 级阻断（ConversationAgent 工厂崩溃、Coordinator 未接线、工作流执行双内核、Run 前后端不一致、tool/node 三套体系未统一、Workflow LangGraph 为占位），需按阶段收敛。

📋 执行计划
1. Phase 0（止血：主链路可跑）
   - 目标：让 /api/conversation/stream 与 Coordinator 监督链路在同一 EventBus 上可运行。
   - 动作：修复 src/application/services/conversation_agent_factory.py 必要依赖注入（llm/session_context），并注入 coordinator；在 src/interfaces/api/main.py composition root 注册 vent_bus.add_middleware(coordinator.as_middleware())；补齐最小可观测日志。
   - 验证：本地启动后，触发对话 SSE，能看到 Decision 事件被 middleware 放行/拒绝；无崩溃。

2. Phase 1（收敛执行真源：Workflow 执行内核唯一化）
   - 目标：消除“engine 执行”和“WorkflowAgent 执行”两套并行语义，明确唯一权威执行路径。
   - 动作：选型并落地：
     - 方案 A（推荐）：WorkflowEngine 为权威，WorkflowAgent 只做薄适配/事件桥接；API 执行统一走 WorkflowExecutionFacade。
     - 方案 B：WorkflowAgent 变为唯一执行入口（需重构 API 与事件模型）。
   - 交付：形成一份 ADR（架构决策记录）+ 删除/冻结分叉调用点。
   - 验证：同一 workflow_id 的执行日志/状态只有一个来源，事件语义一致。

3. Phase 2（Run 一致性：用户点击 Run 与“执行成功”同真源）
   - 目标：修复前端 Run 语义与后端事实脱钩。
   - 动作（二选一，需确认产品口径）：
     - 方案 A：补齐 workflow runs：实现 POST /api/projects/{project_id}/workflows/{workflow_id}/runs，并让 /execute 接受并落库 un_id（含幂等/回放）。
     - 方案 B：移除 workflow-run 概念：前端不再创建/展示 run_id，执行仅以 workflow SSE 事件为准。
   - 验证：前端展示的 run_id 与后端查询到的 run 记录一致（A）/或前端不再误导（B）。

4. Phase 3（tool 与 node 统一：修改即校验可执行性）
   - 目标：建立单一 ToolRegistry/CapabilityRegistry，保证“修改工作流时工具可识别且可执行”。
   - 动作：
     - 统一映射：node_type ↔ executor ↔（可选）tool_id；明确 Tool 节点的 schema（例如 
ode.config.tool_id）。
     - 在两条修改链路（拖拽/对话）落库前加入强校验：executor 存在、tool_id 存在且可用、图无环、边引用正确。
     - 补齐缺失 executor（至少 tool/embedding/image/audio/structuredOutput 的策略：实现/禁用/降级）。
   - 验证：保存后的 workflow 都能通过“可执行性校验”，避免“保存成功但必然执行失败”。

5. Phase 4（ReAct 严格化：闭环 Thought→Action→Observation）
   - 目标：对话 Agent 的 ReAct 不再是“只 emit”，而是能产生真实 Observation，并被 Coordinator 监督。
   - 动作：
     - 统一 Action schema（Pydantic）与 Decision 发布规则；所有关键动作必须产生可审计 ID。
     - 工具调用：选择工具系统（DB Tool vs LangChain tools）并打通执行反馈，输出 tool_result。
     - 修复 /workflows/{id}/chat-stream-react 的事件字段映射错误，保证 SSE 语义可用。
   - 验证：在 SSE 中能看到 tool_call 与对应 tool_result；Coordinator 可拒绝危险决策并产生纠偏事件。

6. Phase 5（LangGraph 战略对齐：明确“用/不用”以及边界）
   - 目标：消除“宣称注入 LangGraph 但实际 NotImplemented”的架构漂移。
   - 动作（二选一，需确认）：
     - 方案 A：workflow 执行也使用 LangGraph：实现 src/infrastructure/lc_adapters/workflow/langgraph_workflow_executor_adapter.py 并在 WorkflowExecutionFacade 受控切换。
     - 方案 B：workflow 执行继续用 WorkflowEngine：删除/禁用 LangGraph workflow adapter 注入，避免误导。
   - 验证：不存在 NotImplemented 的运行时路径；执行行为与文档一致。

7. Phase 6（DDD 边界修复：依赖方向收敛）
   - 目标：接口层/应用层/领域层不越界，减少重构耦合爆炸半径。
   - 动作：
     - 将 Application→Infrastructure、Domain→Application/Infrastructure 的直接 import 替换为 Domain Ports + Infrastructure Adapters。
     - 以 .import-linter.toml 与 docs/architecture/DDD_BOUNDARY_REVIEW_CHECKLIST.md 为验收标准，逐个消除违规。
   - 验证：import-linter（或等价检查）通过；关键模块可独立测试。

8. Phase 7（测试与回归：用例级保障）
   - 目标：为核心链路建立可回归的自动化保护。
   - 动作：
     - 增加集成测试：chat-create 早期返回 workflow_id、chat-stream 修改校验、execute/stream 事件序列、Coordinator 拦截行为。
     - 前端 e2e/单测：Run 行为与后端契约一致、SSE 解析稳定。
   - 验证：CI 可复现；无依赖外部网络的测试可跑通（LLM 调用需 mock）。

9. Phase 8（灰度/回滚策略）
   - 目标：降低上线风险。
   - 动作：
     - 对新链路加 feature flag（例如 LangGraph workflow executor、Run 落库）。
     - 保留 legacy endpoint 的兼容期与日志观测（已存在 deprecation header）。
   - 验证：可一键回滚到旧路径；监控指标明确（错误率、P95、拒绝率）。

⚠️ 风险与注意事项
- 兼容性风险：收敛执行内核可能改变事件/日志字段，前端 SSE 解析需同步更新。
- 运行环境风险：LLM/Tool 外部依赖（API key、网络）在测试环境需要 mock/隔离。
- 架构风险：DDD 越界修复会牵涉较多模块移动，必须分批次、小步可回滚。

📎 参考
- Report.md:1
- src/interfaces/api/routes/workflows.py:405（chat-create）
- src/interfaces/api/routes/workflows.py:281（拖拽修改）
- src/interfaces/api/routes/chat_workflows.py:25（对话修改）
- src/interfaces/api/routes/workflows.py:332（执行）
- src/application/services/conversation_agent_factory.py:16（ConversationAgent 工厂现状）
- src/domain/agents/coordinator_agent.py:2152（as_middleware）
- src/domain/services/agent_orchestrator.py:133（正确的 middleware 注册示例）
- src/infrastructure/lc_adapters/workflow/langgraph_workflow_executor_adapter.py:33（NotImplemented 占位）
- src/interfaces/api/routes/runs.py:71（仅 GET runs）
- web/src/features/workflows/pages/WorkflowEditorPageWithMutex.tsx:884（前端尝试创建 run）