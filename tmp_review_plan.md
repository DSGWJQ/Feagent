# 详细排查计划 - 多视角审查

> 创建时间：2025-12-10
> 策略：使用多个代理提供不同视角和意见

---

## 初步发现（Claude分析）

### 1. 代码规模问题 ⚠️

| 文件 | 行数 | 评估 |
|------|------|------|
| coordinator_agent.py | 4619行 | 🔴 **严重超标**（建议<1000行） |
| workflow_agent.py | 2880行 | 🔴 **超标**（建议<1000行） |
| conversation_agent.py | 1972行 | 🟡 **偏大**（建议<1000行） |
| 服务模块总数 | 107个文件 | 🟡 **数量多**（可能存在冗余） |

### 2. 代码质量问题 ❌

**Ruff检查发现8个错误**：

```
1. E741: 模糊变量名 'l' (control_flow_ir.py:207)
2-5. F821: 未定义名称 (conversation_agent.py):
   - FormattedError (line 2157)
   - UserDecision (line 2191)
   - UserDecisionResult (line 2191)
   - ControlFlowIR (line 2293)
6-8. F821: 未定义名称 (conversation_agent.py):
   - EdgeDefinition (line 2358, 2359)
```

**分析**：
- 类型注解使用了未导入的类型（可能是循环导入问题）
- 变量命名不规范（单字母变量名）

### 3. 测试状态 ⏳

- 单元测试运行遇到问题（需要进一步调查）
- 测试数量未知（统计命令失败）
- 测试覆盖率未知

---

## 排查计划（分阶段执行）

### 阶段1：核心Agent深度审查 🔴 高优先级

**目标**：评估三个核心Agent的代码质量、架构合理性

#### 1.1 CoordinatorAgent审查（4619行）

**审查重点**：
- [ ] 代码复杂度分析（圈复杂度、嵌套层级）
- [ ] 职责单一性（是否违反SRP原则）
- [ ] 可拆分性评估（如何拆分成更小的模块）
- [ ] 依赖注入和测试友好性
- [ ] 错误处理和边界条件

**使用代理**：
- `code-reviewer`: 常规代码审查
- `king-of-bad-reviews`: 严格审查，找出所有问题

**预期输出**：
- 代码质量报告
- 重构建议（拆分方案）
- 高风险代码清单

#### 1.2 ConversationAgent审查（1972行）

**审查重点**：
- [ ] ReAct循环实现的可靠性
- [ ] 意图分类准确性
- [ ] 决策生成逻辑
- [ ] 控制流规划（条件、循环、映射）
- [ ] 类型注解错误修复（8个F821错误）

**使用代理**：
- `code-reviewer`: 逻辑正确性审查
- `debugger`: 错误定位和修复建议

**预期输出**：
- 类型注解修复方案
- 控制流实现质量评估
- 潜在bug清单

#### 1.3 WorkflowAgent审查（2880行）

**审查重点**：
- [ ] DAG拓扑排序正确性
- [ ] 节点执行可靠性
- [ ] 状态同步机制
- [ ] 反馈驱动更新API
- [ ] 并发和性能问题

**使用代理**：
- `code-reviewer`: 算法正确性审查
- `backend-architect`: 架构合理性评估

**预期输出**：
- DAG实现质量评估
- 性能优化建议
- 并发安全性分析

---

### 阶段2：服务模块冗余分析 🟡 中优先级

**目标**：识别107个服务模块中的冗余和职责重叠

#### 2.1 服务模块清单

**分类统计**：
- [ ] 按功能分类（上下文、压缩、规则、监控等）
- [ ] 识别相似功能的模块
- [ ] 检查模块间依赖关系
- [ ] 识别废弃或未使用的模块

**使用代理**：
- `backend-architect`: 架构层面分析
- Task(Explore): 全局搜索和依赖分析

**预期输出**：
- 服务模块依赖图
- 冗余模块清单
- 合并建议

#### 2.2 关键服务审查

**重点模块**：
- [ ] `expression_evaluator.py` - 安全性审查
- [ ] `power_compressor.py` - 压缩算法正确性
- [ ] `configurable_rule_engine.py` - 规则引擎可靠性
- [ ] `event_bus.py` - 事件可靠性（丢失、顺序）
- [ ] `intervention_system.py` - 干预逻辑正确性

**使用代理**：
- `code-reviewer`: 逻辑审查
- `king-of-bad-reviews`: 安全审查

---

### 阶段3：测试覆盖分析和补充 🟡 中优先级

**目标**：评估测试覆盖率，识别测试盲区

#### 3.1 测试覆盖率统计

**任务**：
- [ ] 运行pytest-cov统计覆盖率
- [ ] Domain层覆盖率（目标≥80%）
- [ ] Application层覆盖率（目标≥70%）
- [ ] 识别未测试的函数和分支

**命令**：
```bash
pytest --cov=src/domain --cov=src/application --cov-report=html --cov-report=term
```

#### 3.2 测试质量评估

**审查重点**：
- [ ] 是否测试了关键路径（happy path + error path）
- [ ] 是否测试了边界条件
- [ ] 是否测试了并发场景
- [ ] Mock和Stub使用是否合理

**使用代理**：
- `code-reviewer`: 测试代码审查
- `debugger`: 测试失败分析

#### 3.3 端到端测试补充

**缺失场景**：
- [ ] 七种节点类型完整流程测试
- [ ] 控制流（条件、循环、映射）端到端测试
- [ ] 集合操作（filter, map, reduce）测试
- [ ] 多Agent协作完整场景测试
- [ ] 错误恢复和重试机制测试

**使用代理**：
- Task(Explore): 识别缺失的测试场景
- `backend-architect`: 设计测试方案

---

### 阶段4：安全风险扫描 🔴 高优先级

**目标**：识别安全漏洞和风险

#### 4.1 表达式求值安全性

**审查重点**：
- [ ] `expression_evaluator.py` 是否防止代码注入
- [ ] 是否有沙箱隔离
- [ ] 是否限制危险函数（eval, exec）
- [ ] 是否验证输入

**使用代理**：
- `king-of-bad-reviews`: 安全审查
- `code-reviewer`: 漏洞扫描

#### 4.2 权限和认证

**审查重点**：
- [ ] API端点是否有权限控制
- [ ] 用户输入是否验证
- [ ] SQL注入风险
- [ ] XSS风险

#### 4.3 并发安全

**审查重点**：
- [ ] 共享状态访问是否有锁
- [ ] EventBus事件顺序保证
- [ ] 多Agent状态同步一致性

---

### 阶段5：架构一致性验证 🟡 中优先级

**目标**：验证是否符合DDD架构原则

#### 5.1 依赖方向检查

**规则**：
```
Interface → Application → Domain ← Infrastructure
```

**检查项**：
- [ ] Domain层是否导入了Framework（SQLAlchemy, FastAPI, LangChain）
- [ ] Application层是否直接依赖Infrastructure
- [ ] 循环依赖检查

**使用代理**：
- `backend-architect`: 架构评估
- Task(Explore): 依赖关系分析

#### 5.2 命名约定检查

**规则**：
- `get_xxx`: 必须存在，否则抛异常
- `find_xxx`: 允许返回None
- `XxxUseCase`: 应用层用例
- `XxxInput/Request/Response`: DTO

**检查项**：
- [ ] 命名是否一致
- [ ] 是否有违反约定的代码

---

### 阶段6：性能和可维护性 🟢 低优先级

**目标**：识别性能瓶颈和可维护性问题

#### 6.1 性能分析

- [ ] 识别热点函数（使用profiler）
- [ ] 检查N+1查询
- [ ] 检查不必要的循环和递归
- [ ] 内存泄漏风险

#### 6.2 可维护性

- [ ] 文档完整性
- [ ] 代码注释质量
- [ ] 重复代码检测（使用jscpd或类似工具）

---

## 执行顺序

### 第一轮：快速扫描（30分钟）

1. ✅ 运行Ruff检查所有代码
2. ⏳ 运行测试套件，记录失败
3. ⏳ 使用`code-reviewer`快速审查三个Agent

### 第二轮：深度审查（2小时）

1. ⏳ 使用`king-of-bad-reviews`严格审查CoordinatorAgent
2. ⏳ 使用`debugger`分析ConversationAgent的类型错误
3. ⏳ 使用`backend-architect`评估WorkflowAgent架构

### 第三轮：专项分析（1小时）

1. ⏳ 服务模块冗余分析
2. ⏳ 测试覆盖率统计
3. ⏳ 安全风险扫描

### 第四轮：报告和建议（30分钟）

1. ⏳ 整理所有审查结果
2. ⏳ 按严重程度排序问题
3. ⏳ 生成测试补充建议
4. ⏳ 制定修复优先级

---

## 代理分工

| 代理 | 职责 | 使用场景 |
|------|------|----------|
| `code-reviewer` | 常规代码审查 | 逻辑正确性、代码质量 |
| `king-of-bad-reviews` | 严格审查 | 找出所有潜在问题、安全漏洞 |
| `debugger` | 错误分析 | 修复建议、问题定位 |
| `backend-architect` | 架构评估 | 架构合理性、设计模式 |
| Task(Explore) | 全局分析 | 依赖关系、测试盲区 |

---

## 预期产出

### 1. 代码质量报告
- 严重问题清单（影响功能或安全）
- 中等问题清单（影响可维护性）
- 轻微问题清单（代码风格）

### 2. 测试补充建议
- 缺失的单元测试
- 缺失的集成测试
- 缺失的端到端测试

### 3. 重构建议
- CoordinatorAgent拆分方案
- 服务模块合并建议
- 架构优化建议

### 4. 优先级修复计划
- P0（立即修复）：安全漏洞、功能bug
- P1（本周修复）：代码质量、测试补充
- P2（下周修复）：重构、优化

---

**下一步**：开始执行第一轮快速扫描
