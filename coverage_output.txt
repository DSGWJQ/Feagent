============================= test session starts =============================
platform win32 -- Python 3.13.3, pytest-8.4.1, pluggy-1.6.0
rootdir: D:\My_Project\agent_data
configfile: pyproject.toml
plugins: anyio-4.10.0, langsmith-0.4.42, asyncio-1.3.0, cov-7.0.0, html-4.1.1, metadata-3.1.1, mock-3.15.1
asyncio: mode=Mode.AUTO, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 303 items

tests\unit\domain\agents\test_conversation_agent.py .............        [  4%]
tests\unit\domain\agents\test_conversation_agent_async_methods.py ...... [  6%]
..........                                                               [  9%]
tests\unit\domain\agents\test_conversation_agent_config_compat.py ...... [ 11%]
....                                                                     [ 12%]
tests\unit\domain\agents\test_conversation_agent_control_flow.py ....... [ 15%]
.....                                                                    [ 16%]
tests\unit\domain\agents\test_conversation_agent_coverage_boost.py ..... [ 18%]
......................                                                   [ 25%]
tests\unit\domain\agents\test_conversation_agent_decision_record.py .... [ 27%]
..                                                                       [ 27%]
tests\unit\domain\agents\test_conversation_agent_emitter_integration.py . [ 28%]
.............                                                            [ 32%]
tests\unit\domain\agents\test_conversation_agent_enhanced.py ........... [ 35%]
.                                                                        [ 36%]
tests\unit\domain\agents\test_conversation_agent_p0_fixes.py ........... [ 39%]
...                                                                      [ 40%]
tests\unit\domain\agents\test_conversation_agent_parent_integration.py . [ 41%]
...                                                                      [ 42%]
tests\unit\domain\agents\test_conversation_agent_planning.py ..........  [ 45%]
tests\unit\domain\agents\test_conversation_agent_progress_formatting.py . [ 45%]
......                                                                   [ 47%]
tests\unit\domain\agents\test_conversation_agent_react_core.py ......... [ 50%]
...................................                                      [ 62%]
tests\unit\domain\agents\test_conversation_agent_refactor_regression.py . [ 62%]
.....                                                                    [ 64%]
tests\unit\domain\agents\test_conversation_agent_save_request_full.py .. [ 65%]
..........F.F....                                                        [ 70%]
tests\unit\domain\agents\test_conversation_agent_seven_types.py ........ [ 73%]
.......ssss                                                              [ 76%]
tests\unit\domain\agents\test_conversation_agent_state.py .............. [ 81%]
.........                                                                [ 84%]
tests\unit\domain\agents\test_conversation_agent_state_machine.py ...... [ 86%]
............                                                             [ 90%]
tests\unit\domain\agents\test_conversation_agent_subagent_sync.py ...... [ 92%]
                                                                         [ 92%]
tests\unit\domain\agents\test_conversation_agent_token_staging.py ...... [ 94%]
                                                                         [ 94%]
tests\unit\domain\agents\test_conversation_agent_workflow.py ........... [ 98%]
......                                                                   [100%]

================================== FAILURES ===================================
_____________ TestRequestSaveMethod.test_request_save_basic_usage _____________

self = <MagicMock name='_create_tracked_task' id='3032861701664'>

    def assert_called_once(self):
        """assert that the mock was called only once.
        """
        if not self.call_count == 1:
            msg = ("Expected '%s' to have been called once. Called %s times.%s"
                   % (self._mock_name or 'mock',
                      self.call_count,
                      self._calls_repr()))
>           raise AssertionError(msg)
E           AssertionError: Expected '_create_tracked_task' to have been called once. Called 0 times.

C:\Python313\Lib\unittest\mock.py:958: AssertionError

During handling of the above exception, another exception occurred:

self = <test_conversation_agent_save_request_full.TestRequestSaveMethod object at 0x000002C2242679D0>
agent_with_event_bus = <src.domain.agents.conversation_agent.ConversationAgent object at 0x000002C22446EAD0>

    def test_request_save_basic_usage(self, agent_with_event_bus):
        """测试：request_save基本使用"""
        agent = agent_with_event_bus

        with patch.object(agent, "_create_tracked_task") as mock_tracked:
            with patch.object(agent.event_bus, "publish", new_callable=AsyncMock) as mock_publish:
                request_id = agent.request_save(
                    target_path="/test/file.txt",
                    content="test content",
                    reason="测试原因",
                )

                assert request_id is not None
                # 验证使用了_create_tracked_task
>               mock_tracked.assert_called_once()
E               AssertionError: Expected '_create_tracked_task' to have been called once. Called 0 times.

tests\unit\domain\agents\test_conversation_agent_save_request_full.py:311: AssertionError
___ TestRequestSaveMethod.test_request_save_creates_request_with_all_fields ___

self = <MagicMock name='_create_tracked_task' id='3032862685712'>

    def assert_called_once(self):
        """assert that the mock was called only once.
        """
        if not self.call_count == 1:
            msg = ("Expected '%s' to have been called once. Called %s times.%s"
                   % (self._mock_name or 'mock',
                      self.call_count,
                      self._calls_repr()))
>           raise AssertionError(msg)
E           AssertionError: Expected '_create_tracked_task' to have been called once. Called 0 times.

C:\Python313\Lib\unittest\mock.py:958: AssertionError

During handling of the above exception, another exception occurred:

self = <test_conversation_agent_save_request_full.TestRequestSaveMethod object at 0x000002C224175220>
agent_with_event_bus = <src.domain.agents.conversation_agent.ConversationAgent object at 0x000002C22446F610>

    def test_request_save_creates_request_with_all_fields(self, agent_with_event_bus):
        """测试：request_save创建完整的SaveRequest对象"""
        agent = agent_with_event_bus

        from src.domain.services.save_request_channel import SaveRequestPriority

        with patch.object(agent, "_create_tracked_task") as mock_tracked:
            with patch.object(agent.event_bus, "publish", new_callable=AsyncMock):
                request_id = agent.request_save(
                    target_path="/output/result.txt",
                    content="analysis result",
                    reason="保存分析结果",
                    priority=SaveRequestPriority.HIGH,
                    is_binary=False,
                )

                assert request_id is not None
>               mock_tracked.assert_called_once()
E               AssertionError: Expected '_create_tracked_task' to have been called once. Called 0 times.

tests\unit\domain\agents\test_conversation_agent_save_request_full.py:345: AssertionError
============================== warnings summary ===============================
C:\Users\23225\AppData\Roaming\Python\Python313\site-packages\pydantic\_internal\_config.py:323: 11 warnings
  C:\Users\23225\AppData\Roaming\Python\Python313\site-packages\pydantic\_internal\_config.py:323: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    warnings.warn(DEPRECATION_MESSAGE, DeprecationWarning)

C:\Users\23225\AppData\Roaming\Python\Python313\site-packages\pydantic\_internal\_generate_schema.py:298
C:\Users\23225\AppData\Roaming\Python\Python313\site-packages\pydantic\_internal\_generate_schema.py:298
  C:\Users\23225\AppData\Roaming\Python\Python313\site-packages\pydantic\_internal\_generate_schema.py:298: PydanticDeprecatedSince20: `json_encoders` is deprecated. See https://docs.pydantic.dev/2.11/concepts/serialization/#custom-serializers for alternatives. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    warnings.warn(

tests/unit/domain/agents/test_conversation_agent.py::TestConversationAgentReActLoop::test_react_loop_produces_thought_action_observation
  D:\My_Project\agent_data\src\domain\agents\conversation_agent_react_core.py:130: DeprecationWarning: There is no current event loop
    loop = asyncio.get_event_loop()

tests/unit/domain/agents/test_conversation_agent.py::TestConversationAgentReActLoop::test_react_loop_max_iterations_limit
tests/unit/domain/agents/test_conversation_agent.py::TestConversationAgentRealWorldScenario::test_complete_workflow_creation_scenario
tests/unit/domain/agents/test_conversation_agent_react_core.py::TestRunAsync::test_run_async_terminates_by_timeout
tests/unit/domain/agents/test_conversation_agent_react_core.py::TestRunAsync::test_run_async_terminates_by_max_iterations
tests/unit/domain/agents/test_conversation_agent_react_core.py::TestRunAsync::test_run_async_emits_tool_call_for_tool_call_action
tests/unit/domain/agents/test_conversation_agent_react_core.py::TestRunAsync::test_run_async_records_decision_for_create_node_action
tests/unit/domain/agents/test_conversation_agent_react_core.py::TestRunAsync::test_run_async_records_decision_for_execute_workflow_action
tests/unit/domain/agents/test_conversation_agent_react_core.py::TestRunAsync::test_run_async_flushes_staged_state_each_iteration
tests/unit/domain/agents/test_conversation_agent_react_core.py::TestRunAsync::test_run_async_records_decision_for_request_clarification
  D:\My_Project\agent_data\src\domain\agents\conversation_agent_react_core.py:378: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
    tokens = self.llm.get_token_usage()  # type: ignore[attr-defined]
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/unit/domain/agents/test_conversation_agent.py: 2 warnings
tests/unit/domain/agents/test_conversation_agent_react_core.py: 8 warnings
  D:\My_Project\agent_data\src\domain\agents\conversation_agent_react_core.py:390: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
    cost = self.llm.get_cost()  # type: ignore[attr-defined]
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/unit/domain/agents/test_conversation_agent.py::TestConversationAgentReActLoop::test_react_loop_max_iterations_limit
tests/unit/domain/agents/test_conversation_agent.py::TestConversationAgentReActLoop::test_react_loop_terminates_on_completion
  C:\Python313\Lib\asyncio\events.py:89: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
    self._context.run(self._callback, *self._args)
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/unit/domain/agents/test_conversation_agent.py::TestConversationAgentRealWorldScenario::test_complete_workflow_creation_scenario
  D:\My_Project\agent_data\tests\unit\domain\agents\test_conversation_agent.py:529: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
    result = await agent.run_async("帮我创建一个获取天气并发送通知的工作流")
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/unit/domain/agents/test_conversation_agent_react_core.py::TestRunAsync::test_run_async_completes_on_respond_action
  D:\My_Project\agent_data\tests\unit\domain\agents\test_conversation_agent_react_core.py:97: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
    result = await mock_agent.run_async("test input")
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/unit/domain/agents/test_conversation_agent_react_core.py::TestRunAsync::test_run_async_terminates_by_timeout
  D:\My_Project\agent_data\tests\unit\domain\agents\test_conversation_agent_react_core.py:141: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
    result = await mock_agent.run_async("test input")
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/unit/domain/agents/test_conversation_agent_react_core.py::TestRunAsync::test_run_async_terminates_by_token_limit
  D:\My_Project\agent_data\tests\unit\domain\agents\test_conversation_agent_react_core.py:158: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
    result = await mock_agent.run_async("test input")
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/unit/domain/agents/test_conversation_agent_react_core.py::TestRunAsync::test_run_async_terminates_by_max_iterations
  D:\My_Project\agent_data\tests\unit\domain\agents\test_conversation_agent_react_core.py:192: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
    result = await mock_agent.run_async("test input")
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/unit/domain/agents/test_conversation_agent_react_core.py::TestRunAsync::test_run_async_completes_on_should_continue_false
  D:\My_Project\agent_data\tests\unit\domain\agents\test_conversation_agent_react_core.py:208: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
    result = await mock_agent.run_async("test input")
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/unit/domain/agents/test_conversation_agent_react_core.py::TestRunAsync::test_run_async_emits_tool_call_for_tool_call_action
  D:\My_Project\agent_data\tests\unit\domain\agents\test_conversation_agent_react_core.py:231: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
    result = await mock_agent.run_async("test input")
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/unit/domain/agents/test_conversation_agent_react_core.py::TestRunAsync::test_run_async_records_decision_for_create_node_action
  D:\My_Project\agent_data\tests\unit\domain\agents\test_conversation_agent_react_core.py:250: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
    await mock_agent.run_async("test input")
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/unit/domain/agents/test_conversation_agent_react_core.py::TestRunAsync::test_run_async_records_decision_for_execute_workflow_action
  D:\My_Project\agent_data\tests\unit\domain\agents\test_conversation_agent_react_core.py:267: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
    await mock_agent.run_async("test input")
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/unit/domain/agents/test_conversation_agent_react_core.py::TestRunAsync::test_run_async_accumulates_token_usage
  D:\My_Project\agent_data\tests\unit\domain\agents\test_conversation_agent_react_core.py:283: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
    result = await mock_agent.run_async("test input")
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/unit/domain/agents/test_conversation_agent_react_core.py::TestRunAsync::test_run_async_emits_thinking_step
  D:\My_Project\agent_data\tests\unit\domain\agents\test_conversation_agent_react_core.py:310: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
    await mock_agent.run_async("test input")
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/unit/domain/agents/test_conversation_agent_react_core.py::TestRunAsync::test_run_async_emits_final_response_and_completes
  D:\My_Project\agent_data\tests\unit\domain\agents\test_conversation_agent_react_core.py:322: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
    await mock_agent.run_async("test input")
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/unit/domain/agents/test_conversation_agent_react_core.py::TestRunAsync::test_run_async_flushes_staged_state_each_iteration
  D:\My_Project\agent_data\tests\unit\domain\agents\test_conversation_agent_react_core.py:348: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
    await mock_agent.run_async("test input")
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/unit/domain/agents/test_conversation_agent_react_core.py::TestRunAsync::test_run_async_initializes_model_info_when_context_limit_zero
  D:\My_Project\agent_data\tests\unit\domain\agents\test_conversation_agent_react_core.py:364: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
    await mock_agent.run_async("test input")
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/unit/domain/agents/test_conversation_agent_react_core.py::TestRunAsync::test_run_async_skips_model_info_when_context_limit_nonzero
  D:\My_Project\agent_data\tests\unit\domain\agents\test_conversation_agent_react_core.py:378: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
    await mock_agent.run_async("test input")
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/unit/domain/agents/test_conversation_agent_react_core.py::TestRunAsync::test_run_async_logs_context_warning_when_approaching_limit
  D:\My_Project\agent_data\tests\unit\domain\agents\test_conversation_agent_react_core.py:464: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
    await mock_agent.run_async("test input")
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/unit/domain/agents/test_conversation_agent_react_core.py::TestRunAsync::test_run_async_records_decision_for_request_clarification
  D:\My_Project\agent_data\tests\unit\domain\agents\test_conversation_agent_react_core.py:481: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
    await mock_agent.run_async("test input")
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/unit/domain/agents/test_conversation_agent_react_core.py::TestRunAsync::test_run_async_should_continue_exception_emits_error_and_completes
tests/unit/domain/agents/test_conversation_agent_refactor_regression.py::test_backward_compatibility_basic_flow
tests/unit/domain/agents/test_conversation_agent_save_request_full.py::TestSaveRequestEdgeCases::test_send_save_request_with_very_long_path
tests/unit/domain/agents/test_conversation_agent_save_request_full.py::TestRequestSaveMethod::test_request_save_returns_request_id
  C:\Python313\Lib\unittest\mock.py:2193: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
    setattr(_type, entry, MagicProxy(entry, self))
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/unit/domain/agents/test_conversation_agent_react_core.py::TestExecuteStep::test_execute_step_with_running_loop_uses_fallback
tests/unit/domain/agents/test_conversation_agent_refactor_regression.py::test_type_annotations_valid
tests/unit/domain/agents/test_conversation_agent_save_request_full.py::TestSaveRequestFullLifecycle::test_send_save_request_without_running_loop_uses_asyncio_run
tests/unit/domain/agents/test_conversation_agent_save_request_full.py::TestSaveRequestFullLifecycle::test_send_save_request_with_binary_content
tests/unit/domain/agents/test_conversation_agent_save_request_full.py::TestSaveRequestFullLifecycle::test_send_save_request_with_empty_reason
tests/unit/domain/agents/test_conversation_agent_save_request_full.py::TestSaveRequestEdgeCases::test_send_save_request_with_large_content
tests/unit/domain/agents/test_conversation_agent_save_request_full.py::TestSaveRequestEdgeCases::test_send_save_request_with_special_characters_in_path
  C:\Python313\Lib\unittest\mock.py:2247: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
    def __init__(self, name, parent):
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/unit/domain/agents/test_conversation_agent_react_core.py::TestExecuteStep::test_execute_step_decide_action_exception_uses_fallback
  C:\Python313\Lib\unittest\mock.py:463: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
    def __init__(
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/unit/domain/agents/test_conversation_agent_save_request_full.py::TestSaveRequestFullLifecycle::test_send_save_request_creates_event_with_all_fields
  C:\Python313\Lib\unittest\mock.py:70: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
    def _is_instance_mock(obj):
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/unit/domain/agents/test_conversation_agent_save_request_full.py::TestSaveRequestFullLifecycle::test_send_save_request_with_custom_priority
tests/unit/domain/agents/test_conversation_agent_save_request_full.py::TestSaveRequestFullLifecycle::test_send_save_request_returns_request_id
  C:\Python313\Lib\unittest\mock.py:799: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
    def __setattr__(self, name, value):
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/unit/domain/agents/test_conversation_agent_save_request_full.py::TestRequestSaveMethod::test_request_save_basic_usage
  D:\My_Project\agent_data\tests\unit\domain\agents\test_conversation_agent_save_request_full.py:303: DeprecationWarning: request_save() is deprecated, use send_save_request() instead. request_save() will be removed in the next major version.
    request_id = agent.request_save(

tests/unit/domain/agents/test_conversation_agent_save_request_full.py::TestRequestSaveMethod::test_request_save_sets_default_priority
  D:\My_Project\agent_data\tests\unit\domain\agents\test_conversation_agent_save_request_full.py:319: DeprecationWarning: request_save() is deprecated, use send_save_request() instead. request_save() will be removed in the next major version.
    request_id = agent.request_save(

tests/unit/domain/agents/test_conversation_agent_save_request_full.py::TestRequestSaveMethod::test_request_save_creates_request_with_all_fields
  D:\My_Project\agent_data\tests\unit\domain\agents\test_conversation_agent_save_request_full.py:336: DeprecationWarning: request_save() is deprecated, use send_save_request() instead. request_save() will be removed in the next major version.
    request_id = agent.request_save(

tests/unit/domain/agents/test_conversation_agent_save_request_full.py::TestRequestSaveMethod::test_request_save_with_binary_content
  D:\My_Project\agent_data\tests\unit\domain\agents\test_conversation_agent_save_request_full.py:355: DeprecationWarning: request_save() is deprecated, use send_save_request() instead. request_save() will be removed in the next major version.
    request_id = agent.request_save(

tests/unit/domain/agents/test_conversation_agent_save_request_full.py::TestRequestSaveMethod::test_request_save_returns_request_id
  D:\My_Project\agent_data\tests\unit\domain\agents\test_conversation_agent_save_request_full.py:370: DeprecationWarning: request_save() is deprecated, use send_save_request() instead. request_save() will be removed in the next major version.
    request_id = agent.request_save(

tests/unit/domain/agents/test_conversation_agent_save_request_full.py::TestRequestSaveMethod::test_request_save_disabled_returns_none
  D:\My_Project\agent_data\tests\unit\domain\agents\test_conversation_agent_save_request_full.py:386: DeprecationWarning: request_save() is deprecated, use send_save_request() instead. request_save() will be removed in the next major version.
    request_id = agent.request_save(

tests/unit/domain/agents/test_conversation_agent_save_request_full.py::TestRequestSaveMethod::test_request_save_no_event_bus_returns_none
  D:\My_Project\agent_data\tests\unit\domain\agents\test_conversation_agent_save_request_full.py:403: DeprecationWarning: request_save() is deprecated, use send_save_request() instead. request_save() will be removed in the next major version.
    request_id = agent.request_save(

tests/unit/domain/agents/test_conversation_agent_state.py::TestSubagentListener::test_start_subagent_completion_listener_subscribes
tests/unit/domain/agents/test_conversation_agent_state.py::TestSubagentListener::test_stop_subagent_completion_listener_unsubscribes
tests/unit/domain/agents/test_conversation_agent_state.py::TestSubagentListener::test_start_listener_idempotent
  D:\My_Project\agent_data\src\domain\agents\conversation_agent_state.py:504: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
    self.event_bus.subscribe(SubAgentCompletedEvent, self._handle_subagent_completed_wrapper)
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/unit/domain/agents/test_conversation_agent_state.py::TestSubagentListener::test_stop_subagent_completion_listener_unsubscribes
  D:\My_Project\agent_data\src\domain\agents\conversation_agent_state.py:517: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
    self.event_bus.unsubscribe(SubAgentCompletedEvent, self._handle_subagent_completed_wrapper)
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=============================== tests coverage ================================
_______________ coverage: platform win32, python 3.13.3-final-0 _______________

Name                                                                        Stmts   Miss  Cover   Missing
---------------------------------------------------------------------------------------------------------
src\__init__.py                                                                 1      0   100%
src\application\__init__.py                                                     2      0   100%
src\application\services\__init__.py                                            2      0   100%
src\application\services\composite_memory_service.py                           69     47    32%   82-89, 106-128, 147-184, 201, 210-212, 225-237
src\application\services\memory_service_adapter.py                             54     54     0%   10-203
src\application\services\rag_service.py                                        98     62    37%   72-73, 84-124, 150-170, 194-235, 246-253, 264-284, 303-321, 342-359
src\application\services\workflow_action_parser.py                             61     61     0%   17-180
src\application\use_cases\__init__.py                                           5      0   100%
src\application\use_cases\classify_task.py                                     78     78     0%   20-303
src\application\use_cases\create_agent.py                                      36     20    44%   115-118, 185-260
src\application\use_cases\create_tool.py                                       25     25     0%   20-123
src\application\use_cases\enhanced_chat_workflow.py                            40     40     0%   10-144
src\application\use_cases\execute_concurrent_workflows.py                      44     26    41%   51-55, 70-108, 119, 133-137, 145-146
src\application\use_cases\execute_run.py                                       43     29    33%   100-101, 150-237
src\application\use_cases\execute_workflow.py                                  34     19    44%   77-78, 102-111, 142-175
src\application\use_cases\generate_workflow_from_form.py                       58     39    33%   61-62, 77-109, 124-159, 174-190
src\application\use_cases\github_auth.py                                       42     27    36%   80-82, 104-159
src\application\use_cases\import_workflow.py                                   20      4    80%   118, 136-142
src\application\use_cases\schedule_workflow.py                                 37     20    46%   49-51, 66-87, 96-106, 114, 128-132
src\application\use_cases\update_workflow_by_chat.py                           86     59    31%   92-93, 109-152, 184-279
src\application\use_cases\update_workflow_by_drag.py                           29     15    48%   73, 100-129
src\config.py                                                                  57      0   100%
src\domain\__init__.py                                                          0      0   100%
src\domain\agents\__init__.py                                                   4      0   100%
src\domain\agents\agent_channel.py                                            147    147     0%   30-511
src\domain\agents\container_events.py                                          39     39     0%   14-109
src\domain\agents\container_executor.py                                       122    122     0%   20-472
src\domain\agents\control_flow_ir.py                                           47      0   100%
src\domain\agents\conversation_agent.py                                       321     51    84%   435, 439, 447, 529-535, 742, 758, 774-778, 786, 907-916, 978, 1038, 1042-1045, 1049-1052, 1059, 1070, 1076-1080, 1086-1089, 1096-1099, 1123, 1201, 1216, 1218, 1220, 1225, 1227, 1229
src\domain\agents\conversation_agent_config.py                                108     34    69%   62, 64, 66, 95, 122, 151, 187-196, 223, 225, 299-334, 373
src\domain\agents\conversation_agent_control_flow.py                           39      1    97%   159
src\domain\agents\conversation_agent_enhanced.py                              126     22    83%   55, 80-88, 118-119, 121-122, 205, 238, 251-252, 274-277, 356-358, 370
src\domain\agents\conversation_agent_events.py                                 24      0   100%
src\domain\agents\conversation_agent_helpers.py                                68     24    65%   83-86, 89-90, 164-189, 196-200
src\domain\agents\conversation_agent_intent.py                                 69     23    67%   97-98, 127, 134, 143, 190-198, 219-258
src\domain\agents\conversation_agent_models.py                                 60      0   100%
src\domain\agents\conversation_agent_protocols.py                              46     46     0%   17-208
src\domain\agents\conversation_agent_react_core.py                            270     16    94%   208-211, 220-228, 393-394, 523, 648
src\domain\agents\conversation_agent_recovery.py                               98     72    27%   130-144, 153-167, 180-181, 204-205, 228, 236, 246-247, 254-255, 270-316, 338-359, 372-389, 401-413, 428-440
src\domain\agents\conversation_agent_state.py                                 167     10    94%   134, 471, 478, 485, 500, 510, 513, 522, 539, 544
src\domain\agents\conversation_agent_workflow.py                               88      4    95%   148-149, 247-248
src\domain\agents\conversation_engine.py                                      258    258     0%   33-790
src\domain\agents\coordinator_agent.py                                        818    528    35%   80-81, 178, 209, 220, 229-262, 271-290, 299-315, 333, 341, 350, 370-378, 403-434, 472-659, 697-935, 967, 989, 1015, 1044, 1072, 1086-1093, 1099-1106, 1121, 1129, 1137, 1145, 1156, 1167, 1175, 1196-1208, 1223-1234, 1242, 1253, 1277, 1303-1304, 1329, 1352, 1375, 1383, 1387, 1402, 1415, 1433, 1446, 1450, 1454, 1478-1488, 1508-1518, 1540-1550, 1566, 1570, 1574, 1606-1609, 1635-1638, 1651, 1662, 1666, 1677, 1684, 1692-1695, 1702, 1707, 1715-1722, 1726, 1748-1787, 1807, 1827, 1842, 1855, 1863-1868, 1877, 1891, 1907-1908, 1917, 1922, 1934, 1949, 1957, 1966, 1977, 1984, 1996, 2011, 2022, 2029, 2046-2050, 2067-2072, 2087-2091, 2106-2110, 2122-2123, 2139, 2150, 2159-2207, 2217-2220, 2228-2231, 2249, 2259, 2269-2274, 2283-2294, 2317-2339, 2351-2352, 2365, 2377-2378, 2386, 2419-2421, 2435-2436, 2443-2444, 2454, 2466, 2478-2481, 2488-2489, 2501, 2514, 2526-2527, 2534-2535, 2552, 2571, 2586, 2597, 2605, 2610, 2615, 2619, 2623, 2627, 2631, 2641, 2650, 2654, 2662, 2667, 2672, 2679, 2683, 2687, 2691, 2695, 2706, 2717, 2725, 2732, 2739, 2746, 2766, 2788, 2810, 2825, 2833, 2853, 2872, 2889, 2905, 2927, 2938-2940, 2944-2946, 2969, 2996, 3013, 3021, 3029, 3040, 3048, 3056, 3064, 3085, 3101, 3112, 3123, 3134, 3145, 3156, 3169, 3180, 3188, 3212-3226, 3237, 3261-3277, 3288-3297, 3308, 3330-3343, 3354, 3367-3389, 3407, 3426-3434, 3455-3464, 3488, 3502, 3517, 3536, 3546, 3550, 3554, 3558, 3566, 3577, 3587, 3591, 3601, 3610, 3614, 3618, 3622, 3626, 3630, 3639
src\domain\agents\coordinator_agent_config.py                                 124     52    58%   62-63, 97-98, 126-129, 155-158, 252-277, 308, 316, 380-385, 389-390, 394-395, 399-400, 404-405, 409-410, 414-415, 419-420, 424-425, 429-430, 441-451
src\domain\agents\decision_payload.py                                         216     22    90%   126, 166-168, 216, 268, 272, 282, 284, 340, 388-390, 405-411, 548-549
src\domain\agents\error_handling.py                                           302    132    56%   40-45, 49-55, 118-120, 131-151, 162-163, 201-203, 214, 274-287, 295-302, 310, 314, 318, 322-324, 328, 354-357, 368-369, 380-386, 417-419, 431-432, 491-504, 588-592, 607-630, 649-677, 711-714, 729-739, 750-760, 772-780, 844-845, 865-874, 896-904
src\domain\agents\execution_summary.py                                        188    188     0%   27-570
src\domain\agents\hierarchical_node_factory.py                                 64     64     0%   19-386
src\domain\agents\node_definition.py                                          671    520    23%   125, 137, 146, 149-150, 153-154, 157-158, 164, 172, 179-181, 183-185, 189-196, 200-202, 208-210, 232-239, 248, 264, 269, 284-288, 296-300, 304, 308, 312, 354-433, 439-476, 490-499, 513-543, 547, 551, 555-558, 562-565, 575-577, 587-591, 635-674, 712-727, 741-859, 874-891, 903-920, 929-1010, 1018-1019, 1032-1040, 1052-1082, 1095-1133, 1137-1150, 1156-1182, 1193-1212, 1243, 1275-1280, 1310-1314, 1343-1347, 1383-1391, 1446-1489, 1529-1605, 1655-1752, 1794-1863
src\domain\agents\react_prompts.py                                             50     50     0%   23-420
src\domain\agents\subtask_executor.py                                          96     96     0%   24-389
src\domain\agents\workflow_agent.py                                          1188   1004    15%   66, 76-79, 83, 88-92, 110-135, 204, 413-444, 452-455, 460, 465-470, 478, 486-488, 492-526, 530-566, 582-584, 595-716, 727-747, 757, 762, 773-811, 825-827, 850-902, 913, 921, 932-936, 944-969, 986-995, 1007-1014, 1027-1029, 1040-1098, 1118-1201, 1217-1264, 1282-1296, 1306-1348, 1366-1442, 1468-1568, 1590-1705, 1720-1784, 1800-1832, 1849-1879, 1907-1986, 2015-2055, 2095-2112, 2123-2189, 2199-2257, 2266-2271, 2280-2282, 2297-2322, 2333-2418, 2433-2443, 2454-2467, 2483-2489, 2501-2507, 2521-2530, 2548-2608, 2627-2664, 2680-2693, 2701-2708, 2719, 2733-2739, 2751-2765, 2773, 2788, 2799, 2808-2812, 2821, 2834, 2842-2853, 2866-2942, 2953-2998, 3013-3071, 3085-3100, 3114-3212, 3230-3272, 3287-3336, 3354-3376, 3426-3476, 3509-3522, 3570-3606
src\domain\agents\workflow_plan.py                                            137     67    51%   49, 58, 118, 120, 124-125, 138-159, 172-189, 203-213, 237, 265-290, 301-304, 313-316, 325-328, 345, 358-361
src\domain\agents\workflow_state_monitor.py                                   138    117    15%   58-64, 68-70, 80-115, 122-130, 142-147, 170-198, 208-246, 253-258, 272-299, 312-314, 322-323, 336-347, 368-378, 389-390
src\domain\entities\__init__.py                                                 7      0   100%
src\domain\entities\agent.py                                                   19      5    74%   80-88
src\domain\entities\chat_message.py                                            28     11    61%   80-90, 113, 142-147
src\domain\entities\edge.py                                                    18      7    61%   68-77
src\domain\entities\llm_provider.py                                            55     24    56%   81-90, 111, 129, 147, 168, 178-179, 183-184, 192-193, 201-203, 214-219
src\domain\entities\llm_usage.py                                               45     45     0%   16-192
src\domain\entities\node.py                                                    23      6    74%   75-80, 96, 106
src\domain\entities\run.py                                                     40     16    60%   111-115, 145-150, 172-177, 203-209
src\domain\entities\scheduled_workflow.py                                     155    119    23%   56-68, 82-86, 94-99, 103-107, 117-125, 133, 153-172, 184-203, 215-229, 247-288, 298-314, 339-342, 363-381
src\domain\entities\session_context.py                                        171     70    59%   69-74, 79, 140, 144, 148, 245-249, 265, 289, 331-336, 343, 351, 362, 370-371, 379, 392-395, 403, 414-417, 424-454, 467, 475, 482, 490, 501-512, 520-530, 544-548, 565-573
src\domain\entities\task.py                                                    71     36    49%   184-203, 236-240, 263-268, 290-298, 323-329, 344, 366-367
src\domain\entities\tool.py                                                    66     23    65%   138-144, 167-172, 185-187, 197-198, 206-210, 218-219, 228-230
src\domain\entities\user.py                                                    67     36    46%   96-105, 125-126, 141-145, 153-156, 163-166, 173-176, 183-186, 190, 197, 204, 207
src\domain\entities\workflow.py                                                92     60    35%   96-110, 131-132, 149-162, 175-181, 198-205, 215-216, 258-327
src\domain\exceptions.py                                                       11      6    45%   62-67
src\domain\knowledge_base\__init__.py                                           4      0   100%
src\domain\knowledge_base\entities\__init__.py                                  4      0   100%
src\domain\knowledge_base\entities\document.py                                 43     20    53%   61-72, 86-87, 91-95, 106-111, 119
src\domain\knowledge_base\entities\document_chunk.py                           31     15    52%   54-71, 90-93, 101
src\domain\knowledge_base\entities\knowledge_base.py                           30     12    60%   53-61, 79-83, 91-92, 100
src\domain\knowledge_base\ports\__init__.py                                     3      0   100%
src\domain\knowledge_base\ports\knowledge_repository.py                        44     13    70%   24, 29, 34, 39, 44, 49, 54, 59, 64, 69, 90, 95, 100
src\domain\knowledge_base\ports\retriever_service.py                           19      5    74%   30, 49, 70, 89, 108
src\domain\ports\__init__.py                                                    5      0   100%
src\domain\ports\agent_repository.py                                            9      0   100%
src\domain\ports\chat_message_repository.py                                     8      0   100%
src\domain\ports\llm_provider_repository.py                                    12     12     0%   16-130
src\domain\ports\memory_cache.py                                                7      7     0%   11-95
src\domain\ports\memory_provider.py                                             7      7     0%   11-91
src\domain\ports\node_executor.py                                              16      3    81%   38, 68, 79
src\domain\ports\run_repository.py                                              9      0   100%
src\domain\ports\task_repository.py                                            10      0   100%
src\domain\ports\tool_repository.py                                            11     11     0%   16-113
src\domain\ports\user_repository.py                                            13      0   100%
src\domain\ports\workflow_chat_llm.py                                           6      0   100%
src\domain\ports\workflow_repository.py                                         9      0   100%
src\domain\services\__init__.py                                                 5      0   100%
src\domain\services\ab_testing_system.py                                      390    390     0%   13-890
src\domain\services\advanced_executors.py                                     194    194     0%   23-539
src\domain\services\agent_orchestrator.py                                      82     82     0%   33-256
src\domain\services\agent_to_workflow_converter.py                             69     47    32%   113-175, 207-217, 242-274, 300-302, 320, 346
src\domain\services\ai_node_executors.py                                      129    129     0%   23-413
src\domain\services\bidirectional_sync.py                                     164    164     0%   25-563
src\domain\services\canvas_synchronizer.py                                    107    107     0%   21-403
src\domain\services\circuit_breaker.py                                         94     57    39%   100-106, 114-117, 123-124, 132-145, 149-157, 161-170, 174-178, 182, 194-198, 202-223
src\domain\services\code_repair.py                                            152    152     0%   20-410
src\domain\services\concurrent_execution_manager.py                           173    173     0%   11-403
src\domain\services\configurable_rule_engine.py                               302    302     0%   16-685
src\domain\services\container_execution_monitor.py                             98     98     0%   24-333
src\domain\services\context\__init__.py                                         3      0   100%
src\domain\services\context\models.py                                          15      4    73%   37-45
src\domain\services\context\service.py                                         87     70    20%   49-52, 71-76, 100-106, 120-135, 146-163, 171, 195-206, 219-253, 264-278, 298-309
src\domain\services\context_bridge.py                                         150    150     0%   28-535
src\domain\services\context_bridge_enhanced.py                                112    112     0%   22-362
src\domain\services\context_compressor.py                                     254    254     0%   24-753
src\domain\services\context_injection.py                                      126    126     0%   16-552
src\domain\services\context_injection_manager.py                               35     35     0%   24-238
src\domain\services\context_manager.py                                         68     35    49%   95, 108-111, 120, 132, 183-188, 197, 231-247, 266-286
src\domain\services\context_protocol.py                                       200    200     0%   12-738
src\domain\services\conversation_flow_emitter.py                              124     28    77%   117, 131-141, 189, 203-205, 222, 232, 258-263, 272-279, 325-336, 392-400, 409, 430-434, 458, 475-481
src\domain\services\coordinator_bootstrap.py                                  245    245     0%   33-1129
src\domain\services\coordinator_runbook.py                                    426    426     0%   14-1021
src\domain\services\decision_execution_bridge.py                               97     97     0%   22-305
src\domain\services\decision_validator.py                                     102    102     0%   22-339
src\domain\services\dynamic_alert_rule_manager.py                             137     92    33%   56-66, 82, 110-111, 131-142, 153-156, 164, 176-192, 203-207, 218-224, 235-241, 252-263, 275-282, 286-305, 309-322, 326-341, 352-354, 365, 369, 377-381
src\domain\services\dynamic_node_monitoring.py                                262    262     0%   12-724
src\domain\services\enhanced_rule_repository.py                               125    125     0%   22-406
src\domain\services\event_bus.py                                               70     23    67%   113, 154-163, 187-188, 213-214, 235-247, 270-272
src\domain\services\execution_engine.py                                        59     48    19%   50, 78-80, 103-167, 194-214
src\domain\services\execution_monitor.py                                      200    200     0%   33-604
src\domain\services\execution_result.py                                        90     35    61%   33-38, 81-86, 91, 95, 104, 122, 138-139, 147, 182-187, 199-201, 245-277
src\domain\services\execution_summary_manager.py                               48     48     0%   27-163
src\domain\services\experiment_orchestrator.py                                 94     94     0%   12-534
src\domain\services\expression_evaluator.py                                   141    118    16%   127-129, 179-187, 222-273, 296-314, 351-395, 427-443, 455-461, 482-567, 591-617, 635-641, 652-656
src\domain\services\extension_api.py                                          199    199     0%   27-576
src\domain\services\generic_node.py                                           173    173     0%   26-562
src\domain\services\goal_decomposer.py                                        128    128     0%   26-378
src\domain\services\intervention\__init__.py                                    8      8     0%   14-31
src\domain\services\intervention\coordinator.py                                56     56     0%   6-198
src\domain\services\intervention\events.py                                     31     31     0%   11-64
src\domain\services\intervention\logger.py                                     28     28     0%   6-115
src\domain\services\intervention\models.py                                     78     78     0%   15-224
src\domain\services\intervention\task_terminator.py                            27     27     0%   6-105
src\domain\services\intervention\workflow_modifier.py                          72     72     0%   6-196
src\domain\services\intervention_strategy.py                                   67     67     0%   18-289
src\domain\services\intervention_system.py                                      3      3     0%   48-70
src\domain\services\knowledge_audit_log.py                                     93     93     0%   24-379
src\domain\services\knowledge_coordinator_inspector.py                         91     91     0%   26-324
src\domain\services\knowledge_coordinator_integration.py                       66     66     0%   23-281
src\domain\services\knowledge_deviation_alert.py                               90     90     0%   19-308
src\domain\services\knowledge_maintenance.py                                  278    278     0%   77-1041
src\domain\services\knowledge_manager.py                                       77     77     0%   32-247
src\domain\services\knowledge_note.py                                          86     86     0%   23-258
src\domain\services\knowledge_note_lifecycle.py                                58     58     0%   22-254
src\domain\services\knowledge_reference.py                                     90     90     0%   19-314
src\domain\services\knowledge_retrieval_orchestrator.py                       134    134     0%   7-523
src\domain\services\knowledge_retriever_port.py                                64     64     0%   14-294
src\domain\services\knowledge_vault_retriever.py                               77     77     0%   26-280
src\domain\services\log_analysis.py                                           365    365     0%   32-1001
src\domain\services\logging_metrics.py                                        469    469     0%   51-1160
src\domain\services\management_modules.py                                     508    508     0%   36-1226
src\domain\services\memory_compression_handler.py                             108    108     0%   14-309
src\domain\services\message_log_listener.py                                    44     30    32%   32, 40, 77-80, 91-100, 108-120, 131, 154-156, 166-172
src\domain\services\monitoring.py                                             227    227     0%   37-633
src\domain\services\monitoring_knowledge_bridge.py                            162    162     0%   29-558
src\domain\services\node_code_generator.py                                    302    302     0%   21-1152
src\domain\services\node_hierarchy_service.py                                 199    144    28%   99-101, 109, 120, 124, 144-156, 167-184, 209-222, 242-253, 267-288, 298-313, 323-325, 333-340, 348-350, 358-365, 373-378, 386-393, 401-408, 421-424, 435-438, 446, 457-461, 472, 496-509, 522-529, 540-552, 567-583
src\domain\services\node_registry.py                                          234    148    37%   198-206, 219-227, 237-244, 256-279, 284-289, 297-302, 306, 310, 320-322, 332-337, 345-348, 356-361, 369-373, 381, 407-435, 658-662, 666-667, 676-678, 685-692, 703, 714, 722, 735, 749-795, 808-813, 825-845, 867, 886-896
src\domain\services\node_schema.py                                            245    245     0%   21-1016
src\domain\services\node_template_manager.py                                   62     62     0%   15-268
src\domain\services\node_version_manager.py                                    83     83     0%   17-313
src\domain\services\node_yaml_validator.py                                    263    263     0%   22-747
src\domain\services\null_save_request_orchestrator.py                          41     41     0%   25-258
src\domain\services\parent_node_schema.py                                     333    333     0%   21-773
src\domain\services\performance_optimizer.py                                  241    241     0%   26-589
src\domain\services\power_compressor.py                                       209    209     0%   22-646
src\domain\services\power_compressor_facade.py                                 54     54     0%   26-201
src\domain\services\prompt_stability_monitor.py                               378    378     0%   11-984
src\domain\services\prompt_template_system.py                                 154    154     0%   19-586
src\domain\services\prompt_version_facade.py                                   92     92     0%   15-401
src\domain\services\prompt_version_manager.py                                 237    237     0%   12-728
src\domain\services\reflection_context_manager.py                              91     77    15%   52-60, 76-93, 101-113, 123-149, 160-164, 189-193, 210-225, 232, 249-271, 285-292, 305-308
src\domain\services\reliable_emitter.py                                       213    213     0%   36-654
src\domain\services\resource_lifecycle.py                                     312    312     0%   36-935
src\domain\services\result_memory_integration.py                              175    175     0%   13-743
src\domain\services\rule_engine.py                                            142    142     0%   29-446
src\domain\services\rule_engine_facade.py                                     207    162    22%   69, 73, 137-162, 184-185, 196-198, 213-222, 246-379, 395-410, 422-423, 442-447, 465-472, 486-491, 503-508, 516-521, 542, 562, 586, 608, 628, 645-648, 656-659, 670-673, 685-689, 695-696, 700-701, 715-729
src\domain\services\rule_generator.py                                         183    183     0%   23-664
src\domain\services\safety_guard\__init__.py                                    5      0   100%
src\domain\services\safety_guard\core.py                                      139    120    14%   69-82, 101-108, 123-128, 150-225, 249-298, 320-354
src\domain\services\safety_guard\dag_rule_builder.py                           65     56    14%   34-71, 100-151
src\domain\services\safety_guard\payload_rule_builder.py                       92     84     9%   50-83, 102-156, 173-217, 234-262
src\domain\services\safety_guard\rules.py                                      13      0   100%
src\domain\services\sandbox_executor.py                                       302    302     0%   21-875
src\domain\services\save_request_audit.py                                     287    160    44%   91, 120, 165, 180, 186, 198, 218, 229, 233, 237-247, 262, 266, 270, 274-280, 299, 303, 307, 311-325, 345-348, 352, 356, 360-389, 393-394, 423-427, 431, 435, 439-455, 475, 480, 484, 495-499, 510-549, 576-622, 633-650, 654-667, 671-675, 691, 700-720, 732-751, 757, 761, 765, 769
src\domain\services\save_request_channel.py                                   175     86    51%   87-93, 156, 159, 172, 180-184, 209-219, 254, 308, 321-347, 359-370, 390-395, 403-404, 412-413, 427-439, 447-453, 461-464, 475-476, 487-488, 497-499, 507-510, 521-529
src\domain\services\save_request_orchestrator.py                              161    161     0%   27-603
src\domain\services\save_request_receipt.py                                   204    204     0%   16-801
src\domain\services\scenario_prompt_system.py                                 269    269     0%   16-963
src\domain\services\schema_inference.py                                       131    131     0%   19-366
src\domain\services\self_describing_node.py                                   360    360     0%   20-852
src\domain\services\self_describing_node_validator.py                         230    230     0%   13-653
src\domain\services\short_term_buffer.py                                       39     39     0%   21-162
src\domain\services\stream_message.py                                          81     13    84%   108, 134, 149, 190, 204-212, 225-226
src\domain\services\stream_message_formatter.py                                92     92     0%   29-335
src\domain\services\structured_dialogue_summary.py                             87     87     0%   25-290
src\domain\services\sub_agent_scheduler.py                                    117    117     0%   20-426
src\domain\services\subagent_context_bridge.py                                150    150     0%   11-593
src\domain\services\subagent_orchestrator.py                                   93     93     0%   16-354
src\domain\services\summary_strategy.py                                       244    244     0%   20-850
src\domain\services\supervision\__init__.py                                     9      9     0%   16-39
src\domain\services\supervision\conversation.py                                66     66     0%   3-280
src\domain\services\supervision\coordinator.py                                 27     27     0%   6-123
src\domain\services\supervision\efficiency.py                                  51     51     0%   3-201
src\domain\services\supervision\events.py                                      36     36     0%   11-98
src\domain\services\supervision\models.py                                      26     26     0%   11-55
src\domain\services\supervision\protocols.py                                  130    130     0%   30-473
src\domain\services\supervision\strategy_repo.py                               30     30     0%   3-111
src\domain\services\supervision_facade.py                                      75     75     0%   28-391
src\domain\services\supervision_module.py                                     169    169     0%   17-613
src\domain\services\supervision_modules.py                                      5      5     0%   35-65
src\domain\services\supervision_strategy.py                                   369    369     0%   29-1164
src\domain\services\task_executor.py                                           79     59    25%   50, 54-57, 61-62, 65, 89-90, 115-161, 177-200, 220-239
src\domain\services\token_guardrail.py                                        104    104     0%   14-346
src\domain\services\tool_concurrency_controller.py                            216    216     0%   16-601
src\domain\services\tool_config_loader.py                                     154    154     0%   15-509
src\domain\services\tool_engine.py                                            392    392     0%   15-1103
src\domain\services\tool_executor.py                                          128    128     0%   17-574
src\domain\services\tool_knowledge_store.py                                   210    210     0%   16-627
src\domain\services\tool_parameter_validator.py                               111    111     0%   14-329
src\domain\services\unified_definition.py                                     265    265     0%   15-778
src\domain\services\unified_log_collector.py                                   66     66     0%   27-239
src\domain\services\unified_log_integration.py                                 62     62     0%   18-328
src\domain\services\validators.py                                             123    123     0%   17-404
src\domain\services\workflow_action_validator.py                               35     35     0%   13-148
src\domain\services\workflow_chat_react_service.py                             45     45     0%   15-172
src\domain\services\workflow_chat_service.py                                   66     51    23%   47, 63-85, 97-121, 179, 194-270
src\domain\services\workflow_chat_service_enhanced.py                         233    181    22%   52-53, 64-70, 74, 78-79, 91-95, 110-119, 132-164, 175-178, 192-207, 228, 265-278, 287, 291, 304-391, 412-451, 464-578, 590-608, 624-709
src\domain\services\workflow_chat_service_with_rag.py                         119    119     0%   6-413
src\domain\services\workflow_dependency_graph.py                              229    229     0%   17-580
src\domain\services\workflow_executor.py                                       88     73    17%   39-42, 52, 68-133, 150-176, 189-197, 213-259
src\domain\services\workflow_failure_orchestrator.py                          168    115    32%   168-193, 206-207, 220-222, 235, 265-315, 337-417, 437-464, 483-503, 523-549, 565-584
src\domain\services\workflow_scheduler.py                                      90     65    28%   25-28, 32-37, 41-50, 54-58, 62-65, 78, 82-108, 112, 116, 120, 124-127, 131-136, 140-145, 149-152, 165-168
src\domain\value_objects\__init__.py                                            6      0   100%
src\domain\value_objects\document_source.py                                    10      1    90%   21
src\domain\value_objects\document_status.py                                    10      1    90%   21
src\domain\value_objects\execution_context.py                                  52     28    46%   71-72, 81, 97-100, 109, 121, 132, 140-141, 149, 158, 170, 178, 186, 190-191, 199-202, 213-214, 226, 233, 237
src\domain\value_objects\knowledge_base_type.py                                 9      1    89%   20
src\domain\value_objects\node_type.py                                          26      0   100%
src\domain\value_objects\position.py                                            7      1    86%   45
src\domain\value_objects\task_event.py                                         15      6    60%   92-101, 115
src\domain\value_objects\task_type.py                                           8      8     0%   24-67
src\domain\value_objects\tool_category.py                                       8      0   100%
src\domain\value_objects\tool_status.py                                         6      0   100%
src\domain\value_objects\user_role.py                                          15      5    67%   39-43, 48, 52, 56
src\domain\value_objects\workflow_action.py                                    39     39     0%   15-140
src\domain\value_objects\workflow_status.py                                     5      0   100%
src\infrastructure\__init__.py                                                  0      0   100%
src\infrastructure\auth\__init__.py                                             0      0   100%
src\infrastructure\auth\github_oauth_service.py                                25     16    36%   47-49, 72-89, 117-129, 156-168
src\infrastructure\auth\jwt_service.py                                         24     16    33%   58-76, 99-114
src\infrastructure\database\__init__.py                                         4      0   100%
src\infrastructure\database\base.py                                            12      4    67%   75-79
src\infrastructure\database\engine.py                                          18      4    78%   130-134
src\infrastructure\database\models.py                                         182     13    93%   119, 189, 270, 403, 494, 548, 596, 710, 770, 849, 910-912
src\infrastructure\database\repositories\__init__.py                            5      0   100%
src\infrastructure\database\repositories\agent_repository.py                   49     34    31%   59, 82, 108, 145-162, 190-196, 216-222, 247-251, 278-279, 307-314
src\infrastructure\database\repositories\chat_message_repository.py            54     37    31%   34, 49-58, 71-81, 97-140, 154, 168-174, 185-190, 210-213
src\infrastructure\database\repositories\llm_provider_repository.py            56     37    34%   41, 55, 77, 99-100, 114-120, 134-140, 151-157, 168-174, 182-185, 193-200, 211-212, 223-227
src\infrastructure\database\repositories\run_repository.py                     50     35    30%   59, 83, 111, 149-167, 195-201, 221-227, 255-263, 290-291, 314-321
src\infrastructure\database\repositories\scheduled_workflow_repository.py      47     32    32%   31, 45-47, 70, 93-114, 128-137, 148-154, 162-163, 171-177, 188-198
src\infrastructure\database\repositories\task_repository.py                    79     61    23%   70, 95-109, 152-182, 205-218, 231-238, 248-255, 268-276, 293-301, 314-316, 330-332
src\infrastructure\database\repositories\tool_repository.py                    62     42    32%   43, 58-73, 104-119, 151-152, 166-172, 183-189, 197-200, 211-218, 226-233, 244-245, 256-260
src\infrastructure\database\repositories\user_repository.py                    61     41    33%   54, 77, 109, 133-143, 162-172, 183-184, 198-201, 212-213, 224-225, 236, 247, 259-260, 268, 279-284
src\infrastructure\database\repositories\workflow_repository.py                52     31    40%   68, 93-116, 148-185, 201-202, 221-233, 249-261, 274-277, 292-293, 306-310
src\infrastructure\executors\__init__.py                                       31      0   100%
src\infrastructure\executors\base_executor.py                                  12      5    58%   24, 35-39
src\infrastructure\executors\database_executor.py                              44     35    20%   41-85, 98-108
src\infrastructure\executors\file_executor.py                                  77     58    25%   47-81, 94-103, 122-127, 146-155, 171-179, 195-211
src\infrastructure\executors\http_executor.py                                  45     35    22%   32-82
src\infrastructure\executors\javascript_executor.py                            35     27    23%   28-57, 69-99
src\infrastructure\executors\llm_executor.py                                   83     71    14%   37-105, 118-157, 163-181, 188
src\infrastructure\executors\loop_executor.py                                 100     88    12%   67-79, 93-141, 154-183, 196-237, 250-261
src\infrastructure\executors\notification_executor.py                          94     77    18%   59-73, 87-122, 136-181, 195-228
src\infrastructure\executors\prompt_executor.py                                11      6    45%   20-28
src\infrastructure\executors\python_executor.py                                26     18    31%   82-115
src\infrastructure\executors\transform_executor.py                            180    157    13%   44-64, 73-91, 100-140, 149-154, 164-183, 193-227, 237-279, 289-318, 331-342
src\infrastructure\knowledge_base\__init__.py                                   2      0   100%
src\infrastructure\knowledge_base\chroma_retriever_service.py                 187    187     0%   6-386
src\infrastructure\knowledge_base\rag_config_manager.py                       117     93    21%   21-49, 54-67, 72, 83, 92-104, 109-145, 150-226, 231-256, 261
src\infrastructure\knowledge_base\sqlite_knowledge_repository.py               86     59    31%   31, 35-38, 43-56, 74-94, 98-115, 119-126, 142-165, 169-189, 193-200, 218, 222-225, 231, 235, 245, 249, 254-262
src\infrastructure\knowledge_base\sqlite_knowledge_repository_old.py          129    129     0%   8-428
src\infrastructure\llm\__init__.py                                              2      0   100%
src\infrastructure\llm\langchain_workflow_chat_llm.py                          24     11    54%   26-35, 39, 47-49, 56-58
src\infrastructure\memory\__init__.py                                           2      0   100%
src\infrastructure\memory\database_memory_store.py                             26     14    46%   51, 63-69, 85-90, 106, 115-116
src\infrastructure\memory\in_memory_cache.py                                   53     37    30%   73-80, 100-123, 140-150, 162-163, 176-186, 200-203
src\infrastructure\memory\tfidf_compressor.py                                  62     54    13%   58-98, 114-116, 133-164, 181-192
src\infrastructure\websocket\__init__.py                                        2      0   100%
src\infrastructure\websocket\canvas_sync.py                                   270    198    27%   51-58, 62, 78-80, 84, 92-95, 99, 112-131, 149, 166-230, 254-256, 264, 269, 289-309, 317-327, 338, 349, 364-379, 391-400, 408-414, 436-447, 451-457, 461, 469, 489, 503, 519-562, 584-602, 613-625, 641-650, 665-676, 695-707, 722-730, 743-750, 767-776, 789-796, 815-825, 840-848, 863-880, 905-907
src\interfaces\__init__.py                                                      0      0   100%
src\interfaces\api\__init__.py                                                  0      0   100%
src\interfaces\api\dependencies\__init__.py                                     1      0   100%
src\interfaces\api\dependencies\auth.py                                        16      4    75%   32, 45, 57, 77
src\interfaces\api\dependencies\current_user.py                                48     40    17%   56-85, 119-145
src\interfaces\api\dependencies\memory.py                                      18      9    50%   37, 57-70
src\interfaces\api\dependencies\rag.py                                         75     54    28%   27-111, 116-121, 129, 134, 153, 161, 170, 178, 186
src\interfaces\api\dependencies\scheduler.py                                   13      6    54%   13, 19, 24-29, 36
src\interfaces\api\dto\__init__.py                                              6      0   100%
src\interfaces\api\dto\agent_dto.py                                            57     23    60%   54, 141-158, 175-189, 271-275
src\interfaces\api\dto\auth_dto.py                                             24      1    96%   37
src\interfaces\api\dto\chat_dto.py                                             16     16     0%   3-37
src\interfaces\api\dto\coordinator_dto.py                                      73      0   100%
src\interfaces\api\dto\knowledge_dto.py                                        53      0   100%
src\interfaces\api\dto\llm_provider_dto.py                                     34      0   100%
src\interfaces\api\dto\run_dto.py                                              16      1    94%   103
src\interfaces\api\dto\tool_dto.py                                             69      0   100%
src\interfaces\api\dto\workflow_dto.py                                         81      9    89%   62, 76-86, 124, 137-143, 183
src\interfaces\api\dto\workflow_features_dto.py                                39      3    92%   28, 57, 83
src\interfaces\api\main.py                                                     73     27    63%   43, 47-55, 63-65, 71-89, 113, 125-126, 156-158
src\interfaces\api\routes\__init__.py                                           0      0   100%
src\interfaces\api\routes\agent_websocket.py                                   92     92     0%   32-295
src\interfaces\api\routes\agents.py                                            45     28    38%   65, 87, 111, 178-230, 271-287, 338-348
src\interfaces\api\routes\auth.py                                              15      8    47%   68-85
src\interfaces\api\routes\chat_workflows.py                                    35     21    40%   38-115
src\interfaces\api\routes\chat_workflows_complete.py                           90     90     0%   6-296
src\interfaces\api\routes\concurrent_workflows.py                              33     21    36%   28, 44-62, 77-81, 95-99
src\interfaces\api\routes\conversation_stream.py                               64     34    47%   86-155, 170-179, 197-200, 207-208
src\interfaces\api\routes\coordinator_status.py                               140    108    23%   49-52, 65-70, 83-87, 96, 108-111, 127-149, 165-174, 216-329, 358-370, 399-421, 451-538
src\interfaces\api\routes\health.py                                            29     16    45%   16, 25-35, 41-43, 49-51, 61-68
src\interfaces\api\routes\knowledge.py                                         92     72    22%   56-108, 144-189, 216-245, 270-304, 332-347
src\interfaces\api\routes\llm_providers.py                                    111     86    23%   46, 60-66, 74, 106-127, 144-156, 165-172, 188-216, 226-239, 250-267, 278-295
src\interfaces\api\routes\memory_metrics.py                                    24      4    83%   60-62, 85-87
src\interfaces\api\routes\runs.py                                              35     20    43%   22, 28, 39-52, 63-69
src\interfaces\api\routes\scheduled_workflows.py                               99     69    30%   36-39, 57-70, 85-89, 105-111, 126-132, 148-159, 175-182, 198-205, 220-238, 253-292
src\interfaces\api\routes\tools.py                                            142    115    19%   46, 51-65, 116-177, 196-208, 217-224, 235-285, 295-308, 324-348, 359-376
src\interfaces\api\routes\websocket.py                                        107     87    19%   52-54, 94-129, 148-174, 184-201, 211-223, 233-243, 253-272, 282-297, 307-317, 328-337, 342-351
src\interfaces\api\routes\workflows.py                                        248    179    28%   73, 81, 86-95, 106-120, 137-154, 167-181, 195-218, 237-244, 255-278, 305-327, 341-368, 387-410, 437-540, 566, 571-619, 633-648, 665-700
src\interfaces\api\routes\workflows_rag.py                                     17      5    71%   21, 28, 35, 42-43
src\interfaces\api\services\__init__.py                                         2      0   100%
src\interfaces\api\services\sse_emitter_handler.py                            147    116    21%   72-78, 86-93, 104-121, 132-136, 144-158, 165-166, 174-230, 237-243, 259-268, 282-283, 301-317, 328-333, 341-345, 353-359, 364, 374-376
src\interfaces\api\services\workflow_executor_adapter.py                       31     17    45%   25-28, 32-37, 41, 45-57
src\lc\__init__.py                                                              5      0   100%
src\lc\agents\__init__.py                                                       2      0   100%
src\lc\agents\langgraph_task_executor.py                                       72     57    21%   62-82, 100-156, 176, 193-204, 236-265
src\lc\agents\task_executor.py                                                 54     46    15%   70-120, 153-188, 223-259
src\lc\agents\task_executor_adapter.py                                         26     20    23%   58-69, 100-135, 171-172
src\lc\chains\__init__.py                                                       2      0   100%
src\lc\chains\plan_generator.py                                                11      5    55%   88-118
src\lc\llm_client.py                                                           14      8    43%   80-99, 133, 162, 190
src\lc\model_metadata.py                                                       49     26    47%   48, 50, 185, 217-226, 258-287, 300-301, 314-315, 328-329
src\lc\prompts\__init__.py                                                      2      0   100%
src\lc\prompts\plan_generation.py                                               5      1    80%   88
src\lc\prompts\task_classification.py                                          13     13     0%   6-170
src\lc\prompts\workflow_chat_system_prompt.py                                  34     34     0%   14-213
src\lc\token_counter.py                                                        80     80     0%   20-275
src\lc\tools\__init__.py                                                        7      1    86%   58
src\lc\tools\database_tool.py                                                  61     51    16%   65-76, 86-92, 135-207, 221
src\lc\tools\file_tool.py                                                      36     31    14%   53-122, 141
src\lc\tools\http_tool.py                                                      52     42    19%   13-21, 25-34, 46-80, 86
src\lc\tools\python_tool.py                                                    60     50    17%   69-84, 126-226, 241
src\lc\workflow\__init__.py                                                     0      0   100%
src\lc\workflow\langgraph_workflow_executor.py                                 91     91     0%   31-281
src\lc\workflow\react_orchestrator.py                                         211    211     0%   26-599
---------------------------------------------------------------------------------------------------------
TOTAL                                                                       35023  28714    18%
Coverage HTML written to dir htmlcov
=========================== short test summary info ===========================
FAILED tests/unit/domain/agents/test_conversation_agent_save_request_full.py::TestRequestSaveMethod::test_request_save_basic_usage
FAILED tests/unit/domain/agents/test_conversation_agent_save_request_full.py::TestRequestSaveMethod::test_request_save_creates_request_with_all_fields
=========== 2 failed, 297 passed, 4 skipped, 78 warnings in 14.64s ============
