# 工作流平台 PRD（V2）

## 1. 产品愿景
- **目标**：提供一个统一且可插拔的工作流枢纽，让零代码用户通过表单/对话即可创建 AI 工作流，同时允许开发者借助 Coze 集成、自定义工具与完备的观测能力进行扩展。
- **北极星指标**：实现“创建 → 调整 → 执行 → 观察”在数分钟内闭环，日志透明、版本可追溯。

## 2. 成功指标
- ⏱️ **首次跑通耗时**：新用户 10 分钟内可跑通一个工作流。
- ✅ **首次执行成功率**：≥ 80%（无报错完成）。
- 🧭 **可观测覆盖率**：100% 的执行产出节点级结构化日志与 LLM 轨迹。
- 🔌 **可扩展性**：新增节点/工具类型无需改动领域层核心逻辑即可接入。

## 3. 用户画像
| 角色 | 需求 | 痛点 |
|------|------|------|
| **入门运营/业务** | 用自然语言描述诉求并得到引导方案 | 学习成本高、不会写代码 |
| **开发者** | 在 Coze 基础上二次开发、上传工具、调试日志 | 需要详细错误与版本控制 |
| **运维/学习者** | 监控执行、审计历史、快速回滚 | 需要强追踪能力与权限控制 |

## 4. 核心用户旅程
1. **对话创建新工作流**：选择模板 → 对话收集触发器/数据/动作 → 预览差异 → 确认 → 执行。
2. **Coze 导入**：粘贴 JSON/ID → AI 规范化 → Schema 校验 → 进入编辑器 → 可选推回 Coze。
3. **执行与监控**：Coze 适配器或本地执行 → SSE 推送 → 结构化日志 + 友好报错。
4. **版本与回滚**：任何修改（对话/拖拽/导入）都会生成快照 → 可对比、恢复、打标签。

## 5. 功能需求
### 5.1 必须实现
1. **Coze 集成**
   - 导入 Coze 工作流 JSON，映射到内部 Schema，记录校验异常。
   - 通过 Coze API 适配器执行，并记录输入输出。
2. **对话式编辑**
   - 引导用户描述触发器/数据/动作，生成 DSL 操作（add_node、update_edge 等）。
   - 实时展示差异，确认后写入工作流 JSON。
3. **拖拽画布**
   - 与对话共享唯一数据源。
   - 支持节点/连线编辑、冲突检测、版本快照。
4. **模板与引导**
   - 只需填写触发/数据/通知即可生成首个工作流与快照。
5. **自定义工具**
   - 支持上传或通过 GitHub URL 注册工具，记录沙箱信息，可在对话/画布中调用。
6. **可观测性**
   - 执行日志包含节点 id/类型、输入输出、错误、耗时。
   - LLM 轨迹（prompt/result/tool）需脱敏保存。
7. **版本管理**
   - 每次变更自动生成快照，提供 diff 视图与回滚操作，具备审计记录。
8. **调度与实时推送**
   - 中央调度器 + 可插拔执行器。
   - SSE 推送执行进度与错误，多格式输入需落日志。
9. **配置校验**
   - Schema + 经验规则提供可读的错误提示，执行前兜底。

### 5.2 可选功能（MVP 之后）
- 工作流修改后推回 Coze，实现双向同步。
- 工作区级别的细粒度权限（Viewer/Editor/Publisher）。
- 执行完成通知中心（邮件/Webhook）。
- AI 对话辅助提示：“如何更好描述需求”。
- 工具市场与使用分析。
- 多分支可视化调试器。

## 6. 非功能需求
- **可靠性**：对话/LLM 出错时要优雅降级并给出可执行的提示。
- **性能**：导入/预览/对比 < 3 秒；实时日志延迟 < 1 秒。
- **安全**：密钥按工作区隔离；所有操作有审计日志。
- **可维护性**：LangChain 适配器/执行器/校验器模块化，领域层保持与框架无关。

## 7. 依赖与集成
- Coze Workflow API（导入 + 执行）
- LangChain + OpenAI 兼容提供商
- APScheduler（调度）、SQLAlchemy（持久化）
- React + XYFlow（前端画布 + SSE 日志视图）

## 8. 里程碑
1. **MVP**：Coze 导入 + 对话编辑 + 画布预览 + 执行日志。
2. **Growth**：版本历史 UI、自定义工具上传、GitHub 导入。
3. **Scale**：调度/SSE 加强、高级对话冲突处理。
4. **Enterprise**：权限体系、推送到 Coze、工具市场。

## 9. 风险与应对
| 风险 | 影响 | 缓解策略 |
|------|------|----------|
| Coze API 变动 | 导入/执行失败 | 通过适配器隔离 + Schema 校验 |
| LLM 转换偏差 | 生成错误流程 | 校验流水线 + 人工 Diff 确认 |
| 对话与画布冲突 | 数据丢失/混乱 | 操作队列 + 锁 + 快照回滚 |
| 工具上传安全风险 | 潜在攻击 | 沙箱策略 + 审批流程 |

## 10. 待确认问题
- 是否需要限制工作区级的 LLM 用量或日志保留额度？
- 高成本操作（转写、外部 API）如何计费或限流？
- 回滚权限是否只开放给特定角色？
