# 项目开发规范

> **技术实现标准参考文档**
>
> 📋 **给AI的提示**：
> - 本文档专注技术实现细节
> - 遇到行为纪律问题 → 查阅 `.augment/rules/rule_name.md`
> - 遇到业务背景疑问 → 查阅 `docs/需求分析.md`

## 🏗️ 四层架构规范

### 强制开发顺序
```
需求分析 → Domain实体 → Ports接口 → Infrastructure → Application → Interface
```

### 各层职责与路径

| 层级 | 路径 | 核心职责 | 约束条件 |
|------|------|----------|----------|
| **Domain** | `src/domain/` | 业务逻辑核心，定义实体和端口 | ❌ 禁止导入任何框架 |
| **Application** | `src/application/` | 业务编排，事务边界管理 | ❌ 禁止直接依赖Infrastructure |
| **Infrastructure** | `src/infrastructure/` | 实现端口，提供基础设施 | ❌ 禁止被Domain导入 |
| **Interface** | `src/interfaces/` | API入口，请求响应处理 | ❌ 禁止包含业务逻辑 |

### 数据流转机制
```
Request(DTO) → Input → Entity → ORM → Entity → Response(DTO)
```

## 💻 技术栈标准

### 后端技术栈
- **Python**: 3.11+
- **Web框架**: FastAPI + Pydantic v2
- **ORM**: SQLAlchemy 2.0
- **数据库**: PostgreSQL(生产) / SQLite(开发)
- **迁移工具**: Alembic
- **HTTP客户端**: httpx
- **日志**: structlog JSON格式
- **测试**: pytest
- **代码质量**: Ruff/Black, Pyright

### 前端技术栈
- **框架**: React + TypeScript
- **构建工具**: Vite
- **UI库**: Ant Design
- **状态管理**: TanStack Query
- **实时通信**: SSE(EventSource)优先
- **工作流可视化**: React Flow

## 📝 编码规范

### 命名规范
- **UseCase类**: 以`UseCase`结尾，如`CreateAgentUseCase`
- **输入参数**: 以`Input`结尾，如`CreateAgentInput`
- **Repository**: 接口在Domain层，实现在Infrastructure层
- **API路由**: RESTful规范，复数资源名

### 命名约定（本土化）
- `get_xxx(...)`：必须返回非空结果，若不存在应抛出`NotFoundError`或业务异常
- `find_xxx(...)`：允许返回`None`表示未找到
- `check_xxx_exist(...)`：执行存在性检查，未满足条件抛出业务异常
- `exists_xxx(...)`：返回`bool`表示存在性结果
- DTO/实体命名：`XxxRequest`、`XxxResponse`、`XxxDTO`、`XxxAggregate`、`XxxEntity`

### 对象转换（Assembler规范）
- 使用专用`Assembler`类或方法进行对象转换，禁止在控制器或实体中混写转换逻辑
- 转换规则：
  - Interface → Application：`RequestObject → Input/DTO`
  - Application → Domain：`DTO → Entity/Aggregate`
  - Domain → Interface：`Entity/Aggregate → Response/DTO`
  - Domain → Infrastructure：`Entity → ORM Model`
  - Infrastructure → Domain：`ORM Model → Entity`

### 目录结构
```
src/
├── domain/
│   ├── entities/          # 实体定义
│   ├── value_objects/     # 值对象
│   ├── services/          # 领域服务
│   └── ports/            # 端口接口
├── application/
│   └── use_cases/        # 用例实现
├── infrastructure/
│   ├── database/         # ORM模型和Repository实现
│   └── external/         # 外部服务适配器
└── interfaces/
    ├── api/              # API路由
    ├── dto/              # 数据传输对象
    └── main.py           # 应用入口
```

## 🔄 开发流程规范

### 新增功能标准流程

#### 1. Domain层开发
```python
# src/domain/entities/agent.py
@dataclass
class Agent:
    id: str
    start: str
    goal: str

    @staticmethod
    def create(start: str, goal: str) -> "Agent":
        if not goal:
            raise DomainError("goal不能为空")
        return Agent(id=generate_id(), start=start, goal=goal)
```

#### 2. 端口定义
```python
# src/domain/ports/agent_repository.py
from typing import Protocol

class AgentRepository(Protocol):
    def save(self, agent: Agent) -> None: ...
    def find_by_id(self, agent_id: str) -> Agent | None: ...
```

#### 3. Infrastructure实现
```python
# src/infrastructure/database/repositories/agent_repository.py
class SQLAlchemyAgentRepository(AgentRepository):
    def __init__(self, session: Session):
        self.session = session

    def save(self, agent: Agent) -> None:
        model = AgentModel(id=agent.id, start=agent.start, goal=agent.goal)
        self.session.add(model)
        self.session.commit()
```

#### 4. Application层编排
```python
# src/application/use_cases/create_agent_use_case.py
class CreateAgentUseCase:
    def __init__(self, agent_repository: AgentRepository):
        self.agent_repository = agent_repository

    def execute(self, input_data: CreateAgentInput) -> Agent:
        agent = Agent.create(start=input_data.start, goal=input_data.goal)
        self.agent_repository.save(agent)
        return agent
```

#### 5. Interface层实现
```python
# src/interfaces/api/routes/agents.py
@router.post("/", response_model=AgentResponse)
async def create_agent(request: CreateAgentRequest):
    use_case = CreateAgentUseCase(agent_repository=container.agent_repository)
    agent = use_case.execute(CreateAgentInput(**request.dict()))
    return AgentResponse.from_entity(agent)
```

## 🧪 测试规范

### 覆盖率要求
- **Domain层**: ≥80%（核心业务逻辑）
- **Application层**: ≥70%（用例编排）
- **Infrastructure层**: ≥60%（适配器）
- **API层核心路径**: 100%（创建、查询、执行）

### 必写测试场景
- SSE事件序列与终止信号测试
- 执行器状态机转换测试
- 幂等性测试（重复触发）
- Domain实体不变式测试

### TDD执行标准
```bash
# 标准流程
1. 编写测试用例（Red）
2. 实现最小功能（Green）
3. 重构优化（Refactor）
4. 验证覆盖率达标
```

## ✅ 校验规范

### 三层校验机制
- **API层（Interface）**：基础数据格式校验，使用 Pydantic 字段约束
- **Application层**：业务规则校验（存在性、权限、幂等等），组织事务边界
- **Domain层**：领域不变式与状态机校验，仅使用纯Python逻辑

示例：
```python
# API层（Pydantic约束）
class CreateAgentRequest(BaseModel):
    start: str = Field(..., min_length=1, max_length=500)
    goal: str = Field(..., min_length=1, max_length=500)
    name: str | None = Field(None, max_length=100)

# Application层（业务校验）
agent = agent_repository.find_by_id(agent_id)
if agent is None:
    raise NotFoundError("Agent 不存在")

# Domain层（不变式）
@staticmethod
def create(start: str, goal: str) -> "Agent":
    if not goal:
        raise DomainError("goal不能为空")
    return Agent(...)
```

## 🗄️ 数据库操作规范

### 查询操作：严格 vs 宽松
- **严格查询（get）**：必须存在，否则抛出异常
- **宽松查询（find）**：允许返回`None`

Python示例：
```python
# 严格查询
def get_agent(session: Session, agent_id: str) -> AgentModel:
    obj = session.get(AgentModel, agent_id)
    if obj is None:
        raise NotFoundError("Agent 不存在")
    return obj

# 宽松查询
def find_agent(session: Session, agent_id: str) -> AgentModel | None:
    return session.get(AgentModel, agent_id)
```

### 更新操作规范
- 更新操作必须携带操作上下文（如`user_id`）
- 优先采用直接更新语句，避免“先查后更新”的竞争条件
- 更新失败应抛出明确业务异常

## 🔐 安全规范
- 所有密钥与机密仅通过环境变量或密钥管理注入，禁止明文存储到代码或数据库
- 所有用户输入必须进行白名单/长度/范围/枚举/正则校验
- HTTP/SQL/脚本执行需最小权限与隔离（域名白名单、Schema限定、沙箱资源限额）

## 🔁 事务规范
- 事务仅在 **Application层** 管理（开启/提交/回滚），Domain层禁止感知事务
- 同一用例内事务边界清晰，避免嵌套事务

## 🧾 日志规范
- 使用结构化 JSON 日志，字段包含`trace_id`贯穿全链路
- 日志消息文本使用中文，更易于内部协作理解
- 严禁打印明文密钥，必要时使用`***`脱敏

## 🌿 Git分支与提交流程
- 分支类型：`master`（稳定）/ `develop`（开发）/ 功能分支（`YYYY-MM-DD-feat/xxx`）
- 开发从`master`派生功能分支，完成后提交 PR 到 `master` 与 `develop`
- PR要求：通过所有CI检查、代码审查通过、覆盖率达标

## 📚 文档管理
- SQL脚本统一放置于`docs/sql`
- 设计文档统一放置于`docs/design`
- API文档通过 FastAPI OpenAPI 自动生成；类与方法需保留清晰 docstring 以便文档生成与维护

## 📝 修订记录

| 版本 | 日期 | 修改内容 | 负责人 |
|------|------|----------|--------|
| 1.0  | 2025-11-21 | 初始版本（本土化制定） | AI助手 |
| 1.1  | 2025-11-21 | 补充命名约定、校验与安全规范 | AI助手 |

## ⚠️ 常见错误与纠正

### ❌ 错误1：Domain层导入框架
```python
# 错误示例
from sqlalchemy import Column, String  # ❌ Domain层禁止导入框架

@dataclass
class Agent:
    # 应该使用纯Python类型
    pass
```

### ❌ 错误2：跳过TDD流程
```
❌ 先写实现 → 后补测试 → 提交代码
✅ 先写测试 → 实现功能 → 重构 → 验证覆盖
```

### ❌ 错误3：Application层直接依赖实现
```python
# 错误示例
from src.infrastructure.database.repositories import SQLAlchemyAgentRepository  # ❌

class CreateAgentUseCase:
    def __init__(self):
        self.repo = SQLAlchemyAgentRepository()  # ❌ 应该依赖接口

# 正确做法
class CreateAgentUseCase:
    def __init__(self, agent_repository: AgentRepository):  # ✅ 依赖接口
        self.agent_repository = agent_repository
```

## 📋 质量门禁

### CI/CD检查流程
```bash
1. 代码格式检查 (Ruff/Black)
2. 类型检查 (Pyright)
3. 单元测试 (pytest)
4. 覆盖率验证 (coverage≥阈值)
5. 集成测试 (API测试)
```

### 合并要求
- 所有CI检查必须通过
- 代码审查批准
- 测试覆盖率达标
- 无重复代码和过度复杂实现
