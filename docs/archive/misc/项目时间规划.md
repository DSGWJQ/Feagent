# Agent 中台系统 - 项目时间规划（第一版）

## 📋 规划说明

### 规划原则
- **初次项目自主评估**：基于学习型项目定位，预估总周期 **2-3 周**（10-15 个工作日）
- **TDD 驱动开发**：测试先行，每个功能先写测试再实现
- **渐进式交付**：P0 → P1 → P2，优先保证核心闭环可用
- **精确到小时**：每个任务细化到小时级别，便于追踪与调整
- **留有缓冲**：每个里程碑预留 10-20% 缓冲时间应对风险

### 时间分配策略
- **P0（MVP 核心闭环）**：60% 时间（6-9 天）
- **P1（稳定性/可用性）**：30% 时间（3-4.5 天）
- **P2（增强功能）**：10% 时间（1-1.5 天）或延后到下一迭代

### 工作时间假设
- 每天有效开发时间：**6 小时**（扣除会议、休息、沟通等）
- 每周工作日：5 天
- 总有效工时：**60-90 小时**（10-15 天 × 6 小时）

---

## 🎯 里程碑划分（P0/P1/P2）

### 里程碑 0：项目初始化与环境搭建（1 天，6 小时）
**目标**：完成开发环境、CI/CD、基础骨架搭建

| 任务 | 预估时间 | 优先级 | 验收标准 |
|------|---------|--------|---------|
| 后端项目初始化（uv、目录结构、配置） | 2h | P0 | 项目可运行，目录符合 DDD 分层 |
| 前端项目初始化（Vite、React、Ant Design Pro） | 2h | P0 | 前端可启动，路由配置完成 |
| 数据库设计与 Alembic 迁移脚本 | 1.5h | P0 | 核心表（agents/runs/messages）创建成功 |
| CI/CD 配置（pre-commit、GitHub Actions） | 0.5h | P0 | ruff/pyright/pytest 自动执行 |

**里程碑验收**：
- ✅ 后端 `uvicorn` 启动成功，访问 `/docs` 可见 Swagger
- ✅ 前端 `npm run dev` 启动成功，显示基础布局
- ✅ 数据库迁移成功，表结构符合设计
- ✅ Git commit 触发 pre-commit 检查通过

---

### 里程碑 1：P0 核心闭环 - Domain 层（2 天，12 小时）
**目标**：完成核心领域模型与业务逻辑（TDD 驱动）

| 任务 | 预估时间 | 优先级 | 验收标准 |
|------|---------|--------|---------|
| **Agent 聚合根**（TDD） | 3h | P0 | 测试覆盖率 ≥ 80% |
| - 编写测试：创建 Agent（start+goal）、状态流转 | 1h | P0 | 测试用例完整 |
| - 实现 Agent 实体、值对象（Start/Goal） | 1.5h | P0 | 测试通过 |
| - 重构与优化 | 0.5h | P0 | 代码整洁 |
| **Run 聚合根**（TDD） | 3h | P0 | 测试覆盖率 ≥ 80% |
| - 编写测试：Run 状态机（PENDING→RUNNING→SUCCEEDED/FAILED） | 1h | P0 | 状态流转测试完整 |
| - 实现 Run 实体、状态枚举 | 1.5h | P0 | 测试通过 |
| - 重构与优化 | 0.5h | P0 | 代码整洁 |
| **Task 实体与 TaskEvent**（TDD） | 2h | P0 | 测试覆盖率 ≥ 80% |
| - 编写测试：Task 创建、事件记录 | 0.5h | P0 | 测试用例完整 |
| - 实现 Task 实体、TaskEvent 值对象 | 1h | P0 | 测试通过 |
| - 重构与优化 | 0.5h | P0 | 代码整洁 |
| **领域服务与 Ports 定义** | 2h | P0 | 接口定义清晰 |
| - AgentRepository Port（Protocol） | 0.5h | P0 | 接口方法完整 |
| - RunRepository Port（Protocol） | 0.5h | P0 | 接口方法完整 |
| - LLMService Port（Protocol） | 0.5h | P0 | 接口方法完整 |
| - ToolExecutor Port（Protocol） | 0.5h | P0 | 接口方法完整 |
| **领域异常与错误码** | 1h | P0 | 异常体系完整 |
| **Domain 层单元测试补充** | 1h | P0 | 覆盖率 ≥ 80% |

**里程碑验收**：
- ✅ Domain 层测试覆盖率 ≥ 80%
- ✅ Agent 可创建（start+goal 必填）
- ✅ Run 状态机流转正确
- ✅ 所有 Ports 定义完整
- ✅ pytest 全部通过

---

### 里程碑 2：P0 核心闭环 - Infrastructure 层（2 天，12 小时）
**目标**：实现适配器（Repository、LLM、工具执行器）

| 任务 | 预估时间 | 优先级 | 验收标准 |
|------|---------|--------|---------|
| **SQLAlchemy ORM 模型** | 2h | P0 | ORM 模型与 Domain 实体对应 |
| - AgentModel、RunModel、TaskModel | 1.5h | P0 | 表结构正确 |
| - Alembic 迁移脚本 | 0.5h | P0 | 迁移成功 |
| **Repository 适配器实现**（TDD） | 4h | P0 | 测试覆盖率 ≥ 60% |
| - 编写测试：AgentRepository（CRUD + 幂等） | 1h | P0 | 测试用例完整 |
| - 实现 SQLAlchemyAgentRepository | 1.5h | P0 | 测试通过 |
| - 编写测试：RunRepository（CRUD + 状态查询） | 0.5h | P0 | 测试用例完整 |
| - 实现 SQLAlchemyRunRepository | 1h | P0 | 测试通过 |
| **LLM 客户端适配器**（TDD） | 3h | P0 | 测试覆盖率 ≥ 60% |
| - 编写测试：LLMService（调用、重试、超时） | 1h | P0 | 测试用例完整 |
| - 实现 OpenAILLMService（httpx + tenacity） | 1.5h | P0 | 测试通过 |
| - 配置管理（Pydantic Settings） | 0.5h | P0 | 配置加载正确 |
| **工具执行器适配器**（TDD） | 3h | P0 | 测试覆盖率 ≥ 60% |
| - 编写测试：HTTP 工具、SQL 工具、脚本工具 | 1h | P0 | 测试用例完整 |
| - 实现 HTTPToolExecutor | 1h | P0 | 测试通过 |
| - 实现 SQLToolExecutor（白名单） | 0.5h | P0 | 测试通过 |
| - 实现 ScriptToolExecutor（沙箱） | 0.5h | P0 | 测试通过 |

**里程碑验收**：
- ✅ Infrastructure 层测试覆盖率 ≥ 60%
- ✅ Repository 可正确持久化 Domain 实体
- ✅ LLM 客户端可调用（Mock 或真实 API）
- ✅ 工具执行器可执行（HTTP/SQL/脚本）
- ✅ pytest 全部通过

---

### 里程碑 3：P0 核心闭环 - Application 层（2 天，12 小时）
**目标**：实现用例编排、事务边界、幂等性

| 任务 | 预估时间 | 优先级 | 验收标准 |
|------|---------|--------|---------|
| **CreateAgentUseCase**（TDD） | 3h | P0 | 测试覆盖率 ≥ 70% |
| - 编写测试：创建 Agent（start+goal）、幂等性 | 1h | P0 | 测试用例完整 |
| - 实现用例（校验、创建、持久化） | 1.5h | P0 | 测试通过 |
| - 重构与优化 | 0.5h | P0 | 代码整洁 |
| **UpdateAgentConfigUseCase**（TDD） | 2h | P0 | 测试覆盖率 ≥ 70% |
| - 编写测试：更新配置、权限校验 | 0.5h | P0 | 测试用例完整 |
| - 实现用例 | 1h | P0 | 测试通过 |
| - 重构与优化 | 0.5h | P0 | 代码整洁 |
| **TriggerRunUseCase**（TDD） | 4h | P0 | 测试覆盖率 ≥ 70% |
| - 编写测试：触发运行、幂等键、状态流转 | 1.5h | P0 | 测试用例完整 |
| - 实现用例（创建 Run、调用执行器） | 2h | P0 | 测试通过 |
| - 重构与优化 | 0.5h | P0 | 代码整洁 |
| **GetRunStatusUseCase**（TDD） | 1h | P0 | 测试覆盖率 ≥ 70% |
| - 编写测试：查询运行状态 | 0.5h | P0 | 测试用例完整 |
| - 实现用例 | 0.5h | P0 | 测试通过 |
| **Unit of Work（事务边界）** | 2h | P0 | 事务正确提交/回滚 |
| - 实现 UoW 上下文管理器 | 1.5h | P0 | 事务测试通过 |
| - 集成到用例中 | 0.5h | P0 | 用例测试通过 |

**里程碑验收**：
- ✅ Application 层测试覆盖率 ≥ 70%
- ✅ 创建 Agent 用例可执行
- ✅ 触发运行用例可执行
- ✅ 幂等性测试通过（相同 run_id 不重复执行）
- ✅ 事务边界正确（失败回滚）
- ✅ pytest 全部通过

---

### 里程碑 4：P0 核心闭环 - API 层与 SSE（2 天，12 小时）
**目标**：实现 REST API 与 SSE 流式输出

| 任务 | 预估时间 | 优先级 | 验收标准 |
|------|---------|--------|---------|
| **FastAPI 路由与 DTO**（TDD） | 3h | P0 | API 测试覆盖率 100% |
| - POST /agents（创建 Agent） | 1h | P0 | E2E 测试通过 |
| - PATCH /agents/{id}（更新配置） | 0.5h | P0 | E2E 测试通过 |
| - POST /agents/{id}/runs（触发运行） | 1h | P0 | E2E 测试通过 |
| - GET /agents/{id}/runs/{run_id}（查询状态） | 0.5h | P0 | E2E 测试通过 |
| **SSE 流式输出**（TDD） | 4h | P0 | SSE 测试覆盖率 100% |
| - 编写测试：SSE 事件序列、终止信号 | 1.5h | P0 | 测试用例完整 |
| - 实现 GET /agents/{id}/runs/{run_id}/stream | 2h | P0 | 测试通过 |
| - 事件格式（task_started/log/done/error） | 0.5h | P0 | 事件格式正确 |
| **统一异常处理与错误码** | 2h | P0 | 错误响应统一 |
| - 异常映射中间件 | 1h | P0 | DomainError→4xx，InfraError→5xx |
| - 错误码定义（2000/4001/4004/5000） | 0.5h | P0 | 错误码完整 |
| - trace_id 注入 | 0.5h | P0 | 所有响应包含 trace_id |
| **Assembler（DTO ⇄ Domain）** | 1.5h | P0 | 转换正确 |
| - AgentAssembler | 0.5h | P0 | to_domain/to_dto 测试通过 |
| - RunAssembler | 0.5h | P0 | to_domain/to_dto 测试通过 |
| - 集成到路由中 | 0.5h | P0 | API 测试通过 |
| **健康检查端点** | 0.5h | P0 | /healthz、/readiness 可访问 |
| **API 文档与 Swagger** | 1h | P0 | Swagger 文档完整 |

**里程碑验收**：
- ✅ API 核心路径测试覆盖率 100%
- ✅ POST /agents 可创建 Agent
- ✅ POST /agents/{id}/runs 可触发运行
- ✅ GET /agents/{id}/runs/{run_id}/stream 可推送 SSE 事件
- ✅ SSE 事件序列正确（task_started → log → done）
- ✅ 错误响应统一（包含 code/message/trace_id）
- ✅ pytest + FastAPI TestClient 全部通过

---

### 里程碑 5：P0 核心闭环 - 前端基础页面（2 天，12 小时）
**目标**：实现 Agent 创建、列表、运行详情页面

| 任务 | 预估时间 | 优先级 | 验收标准 |
|------|---------|--------|---------|
| **共享基础设施** | 2h | P0 | 基础设施可用 |
| - HTTP 客户端封装（axios + 拦截器） | 1h | P0 | 请求/响应拦截正确 |
| - TanStack Query Provider 配置 | 0.5h | P0 | Query 可用 |
| - 路由配置（React Router） | 0.5h | P0 | 路由跳转正确 |
| **AgentList 页面**（ProTable） | 2.5h | P0 | 列表展示正确 |
| - useAgents Hook（TanStack Query） | 0.5h | P0 | 数据加载正确 |
| - AgentList 组件（ProTable） | 1.5h | P0 | 列表、搜索、分页正确 |
| - 跳转到创建/详情页 | 0.5h | P0 | 路由跳转正确 |
| **AgentCreate 页面**（ProForm） | 3h | P0 | 创建成功 |
| - useCreateAgent Hook（Mutation） | 0.5h | P0 | 创建请求正确 |
| - AgentCreate 组件（ProForm） | 2h | P0 | 表单校验、提交正确 |
| - StartGoalInput 组件 | 0.5h | P0 | start+goal 输入正确 |
| **RunDetail 页面**（SSE 实时日志） | 4h | P0 | 实时日志展示 |
| - useSSE Hook 封装 | 1.5h | P0 | SSE 连接、事件解析正确 |
| - LogViewer 组件 | 1.5h | P0 | 日志实时展示 |
| - RunStatus 组件 | 0.5h | P0 | 状态标签正确 |
| - TaskTimeline 组件（ProSteps） | 0.5h | P0 | 时间线展示正确 |
| **BasicLayout 布局**（ProLayout） | 1.5h | P0 | 布局正确 |
| - 侧边栏菜单 | 0.5h | P0 | 菜单导航正确 |
| - 顶部导航栏 | 0.5h | P0 | 头部展示正确 |
| - 内容区域 | 0.5h | P0 | 内容渲染正确 |

**里程碑验收**：
- ✅ Agent 列表页可展示 Agent
- ✅ Agent 创建页可创建 Agent（start+goal）
- ✅ Run 详情页可实时展示日志（SSE）
- ✅ 布局正确，导航可用
- ✅ 前后端联调成功

---

### 里程碑 6：P0 核心闭环 - 集成测试与验收（1 天，6 小时）
**目标**：端到端测试、性能测试、文档完善

| 任务 | 预估时间 | 优先级 | 验收标准 |
|------|---------|--------|---------|
| **E2E 测试（完整流程）** | 3h | P0 | E2E 测试通过 |
| - 创建 Agent → 触发运行 → SSE 推送 → 运行完成 | 2h | P0 | 完整流程测试通过 |
| - 幂等性测试（重复触发） | 0.5h | P0 | 幂等性验证通过 |
| - 错误场景测试（无效输入、超时） | 0.5h | P0 | 错误处理正确 |
| **性能测试（基准）** | 1h | P0 | 性能指标达标 |
| - API 响应时间（P95 < 500ms） | 0.5h | P0 | 性能达标 |
| - SSE 推送延迟（< 100ms） | 0.5h | P0 | 延迟达标 |
| **日志与可观测性验证** | 1h | P0 | 日志完整 |
| - trace_id 贯穿全链路 | 0.5h | P0 | trace_id 正确 |
| - 结构化日志格式（JSON） | 0.5h | P0 | 日志格式正确 |
| **文档完善** | 1h | P0 | 文档完整 |
| - API 文档（Swagger） | 0.5h | P0 | API 文档完整 |
| - README（快速启动） | 0.5h | P0 | README 完整 |

**里程碑验收**：
- ✅ E2E 测试全部通过
- ✅ 性能指标达标（P95 < 500ms）
- ✅ 日志完整（trace_id 贯穿）
- ✅ 文档完整（API 文档、README）
- ✅ **P0 核心闭环交付**

---

## 📊 P0 总结（9 天，54 小时）

| 里程碑 | 预估时间 | 累计时间 | 关键交付物 |
|--------|---------|---------|-----------|
| M0：项目初始化 | 1 天（6h） | 6h | 环境搭建、CI/CD |
| M1：Domain 层 | 2 天（12h） | 18h | 领域模型、单元测试 |
| M2：Infrastructure 层 | 2 天（12h） | 30h | 适配器、集成测试 |
| M3：Application 层 | 2 天（12h） | 42h | 用例编排、事务边界 |
| M4：API 层与 SSE | 2 天（12h） | 54h | REST API、SSE 流 |
| M5：前端基础页面 | 2 天（12h） | 66h | Agent 创建、列表、详情 |
| M6：集成测试与验收 | 1 天（6h） | 72h | E2E 测试、文档 |

**P0 总计**：**12 天（72 小时）**

---

## 🚀 P1 稳定性增强（3 天，18 小时）

### 里程碑 7：P1 稳定性基线（2 天，12 小时）

| 任务 | 预估时间 | 优先级 | 验收标准 |
|------|---------|--------|---------|
| **超时与重试（tenacity）** | 2h | P1 | 重试策略生效 |
| **限流（令牌桶/漏桶）** | 2h | P1 | 限流生效 |
| **统一错误码完善** | 1h | P1 | 错误码完整 |
| **Clarifier（1-3 问澄清）** | 3h | P1 | 澄清逻辑生效 |
| **验收标准生成** | 2h | P1 | 验收标准生成 |
| **人在回路（计划确认）** | 2h | P1 | 计划确认流程 |

### 里程碑 8：P1 配置界面与钩子（1 天，6 小时）

| 任务 | 预估时间 | 优先级 | 验收标准 |
|------|---------|--------|---------|
| **AgentEdit 页面（配置调整）** | 3h | P1 | 配置可调整 |
| **钩子机制（对话开始/回复/完成）** | 2h | P1 | 钩子可扩展 |
| **账户余额检查** | 1h | P1 | 余额不足拦截 |

**P1 总计**：**3 天（18 小时）**

---

## 🌟 P2 增强功能（可选，1 天，6 小时）

| 任务 | 预估时间 | 优先级 | 验收标准 |
|------|---------|--------|---------|
| **Model HA（客户端级回退）** | 3h | P2 | 回退策略生效 |
| **计费与配额** | 2h | P2 | 计费逻辑正确 |
| **MCP Gateway（调研）** | 1h | P2 | 技术方案输出 |

**P2 总计**：**1 天（6 小时）**

---

## 📅 总体时间规划（2-3 周）

### 方案 A：紧凑型（2 周，10 天）
- **P0 核心闭环**：9 天（54h）
- **P1 稳定性**：1 天（6h）
- **总计**：10 天（60h）
- **风险**：时间紧张，缓冲不足

### 方案 B：稳健型（3 周，15 天）✅ **推荐**
- **P0 核心闭环**：12 天（72h，含缓冲）
- **P1 稳定性**：3 天（18h）
- **总计**：15 天（90h）
- **优势**：留有缓冲，质量有保障

### 方案 C：完整型（4 周，20 天）
- **P0 核心闭环**：12 天（72h）
- **P1 稳定性**：3 天（18h）
- **P2 增强功能**：1 天（6h）
- **文档与优化**：4 天（24h）
- **总计**：20 天（120h）
- **优势**：功能完整，文档齐全

---

## 📈 进度管理建议

### 1. 使用白板工具（推荐工具）
- **物理白板**：便利贴 + 看板（TODO/DOING/DONE）
- **数字工具**：
  - Trello（看板）
  - Notion（任务列表 + 进度追踪）
  - GitHub Projects（与代码仓库集成）
  - Linear（敏捷开发）

### 2. 每日追踪（精确到小时）
```
每日站会（15 分钟）：
- 昨天完成：[任务名称]（实际耗时 Xh）
- 今天计划：[任务名称]（预估耗时 Xh）
- 遇到阻碍：[问题描述]（需要帮助/自行解决）
```

### 3. 每周回顾（调整计划）
```
每周回顾（30 分钟）：
- 本周完成：[里程碑/任务]（实际耗时 vs 预估耗时）
- 偏差分析：[原因分析]（技术难度/需求变更/其他）
- 下周计划：[调整后的任务列表]
- 风险识别：[潜在风险]（技术/时间/资源）
```

### 4. 风险缓冲策略
- **技术风险**：预留 20% 缓冲时间（如 LLM 调用不稳定）
- **需求变更**：冻结 P0 需求，P1/P2 可调整
- **学习曲线**：首次使用的技术（如 LangChain）预留学习时间

---

## ✅ 验收标准（P0 核心闭环）

### 功能验收
- ✅ 用户可通过前端创建 Agent（输入 start+goal）
- ✅ 用户可触发 Agent 运行
- ✅ 用户可实时查看运行日志（SSE）
- ✅ 运行完成后可查看结果（成功/失败）
- ✅ 幂等性保证（相同 run_id 不重复执行）

### 质量验收
- ✅ 测试覆盖率：Domain ≥ 80%，Application ≥ 70%，API 核心路径 100%
- ✅ CI/CD 通过：ruff/pyright/pytest 全部通过
- ✅ 性能达标：API P95 < 500ms，SSE 延迟 < 100ms
- ✅ 日志完整：trace_id 贯穿全链路，结构化 JSON 格式
- ✅ 文档完整：API 文档（Swagger）、README（快速启动）

### 技术验收
- ✅ 架构符合 DDD-lite + 六边形
- ✅ 依赖方向正确：API/Infra → Application → Domain
- ✅ TDD 流程执行：测试先行，覆盖率达标
- ✅ 错误处理统一：DomainError→4xx，InfraError→5xx
- ✅ 配置管理规范：机密通过环境变量注入

---

## 📝 附录：时间评估经验积累

### 记录模板（每个任务完成后填写）
```markdown
## 任务：[任务名称]
- **预估时间**：Xh
- **实际时间**：Xh
- **偏差**：+/- Xh
- **偏差原因**：
  - [ ] 技术难度超预期
  - [ ] 需求理解偏差
  - [ ] 依赖阻塞
  - [ ] 测试用例编写耗时
  - [ ] 其他：[具体说明]
- **经验教训**：[下次如何改进]
```

### 经验积累建议
1. **首次项目**：预估时间 × 1.5（留足缓冲）
2. **第二次项目**：根据实际偏差调整预估
3. **第三次项目**：预估准确度应达到 ±20%

---

## 🎯 下一步行动

1. **选择方案**：推荐**方案 B（稳健型，15 天）**
2. **创建看板**：使用 Trello/Notion/GitHub Projects
3. **启动 M0**：项目初始化与环境搭建（1 天）
4. **每日追踪**：记录实际耗时，调整后续计划
5. **每周回顾**：分析偏差，积累经验

---

**祝项目顺利！🚀**
