# 开发过程指导（给AI助手）

> **AI开发助手工作流程规范**
> 本文档专为AI助手设计，描述从需求到上线的完整开发流程

---

## 📋 文档查阅优先级

### 第一优先级：行为规范
遇到开发节奏、纪律问题时，查阅：
```
.augment/rules/rule_name.md
```
**核心原则**：
- 一次最多操作2个文件
- 每完成一步等待用户确认
- TDD强制执行

### 第二优先级：技术规范
遇到技术实现疑问时，按顺序查阅：
```
1. docs/开发规范/00-总体开发规范.md   # 架构、分层、TDD
2. docs/开发规范/01-后端开发规范.md   # Python/FastAPI详细规范
3. docs/开发规范/02-前端开发规范.md   # React/TypeScript详细规范
```

### 第三优先级：业务需求
遇到业务逻辑疑问时，查阅：
```
docs/需求分析.md                    # 纯业务需求，无技术细节
```

### 第四优先级：技术方案
需要了解架构决策时，查阅：
```
docs/技术方案/01-总体架构与技术栈.md
docs/技术方案/03-Agent分阶段实施计划.md  # V1-V4演进路线
docs/技术方案/04-Coze集成方案.md
```

---

## 🚀 完整开发流程

### 阶段1：需求理解与澄清

#### 步骤1.1：接收需求
用户提出需求时，首先：
1. **确认理解**："我将帮您实现[具体功能]，请确认是否正确？"
2. **识别类型**：
   - 新增功能 → 走完整TDD流程
   - Bug修复 → 先写失败测试，再修复
   - 重构 → 确保测试覆盖后再重构
   - 文档更新 → 直接修改

#### 步骤1.2：查阅规范
- 查阅 `docs/需求分析.md` 理解业务背景
- 查阅 `.augment/rules/rule_name.md` 确认开发纪律
- 查阅 `docs/开发规范/00-总体开发规范.md` 确认技术约束

#### 步骤1.3：澄清疑问
如有以下情况，必须询问用户：
- 需求描述不明确（如"优化性能"但未说明目标）
- 涉及多种实现方案（如"存储数据"但未指定数据库/文件/缓存）
- 影响现有功能（如重构可能破坏兼容性）

**询问模板**：
```
❓ 确认问题：
1. [具体问题1]
2. [具体问题2]

请选择或补充说明。
```

---

### 阶段2：设计与规划

#### 步骤2.1：确定层级（四层架构）
**强制开发顺序**：Domain → Ports → Infrastructure → Application → Interface

| 层级 | 何时修改 | 示例 |
|------|---------|------|
| **Domain** | 新增业务实体/值对象/领域规则 | 新增Workflow实体 |
| **Ports** | 新增外部依赖接口 | 新增WorkflowRepository |
| **Infrastructure** | 实现Port/集成外部服务 | SQLAlchemyWorkflowRepository |
| **Application** | 新增用例/业务编排 | CreateWorkflowUseCase |
| **Interface** | 新增API端点/前端页面 | POST /workflows |

#### 步骤2.2：制定任务计划
使用 **TodoWrite** 工具创建任务列表：
```
示例：新增Workflow功能
1. [pending] 编写Domain层Workflow实体测试
2. [pending] 实现Workflow实体
3. [pending] 定义WorkflowRepository端口
4. [pending] 实现SQLAlchemyWorkflowRepository
5. [pending] 编写CreateWorkflowUseCase测试
6. [pending] 实现CreateWorkflowUseCase
7. [pending] 实现API路由
8. [pending] 验证端到端流程
```

#### 步骤2.3：说明计划
向用户说明：
```
📋 开发计划：
我将分[N]步实现此功能：
1. [第一步简述]
2. [第二步简述]
...

预计涉及文件：
- src/domain/entities/xxx.py
- src/application/use_cases/xxx_use_case.py
- ...

是否开始？
```

---

### 阶段3：TDD开发循环

#### 核心循环：Red → Green → Refactor

```
┌─────────────────────────────────────┐
│  1. 编写失败的测试（Red）              │
│     ↓                                │
│  2. 实现最小代码使测试通过（Green）      │
│     ↓                                │
│  3. 重构优化（Refactor）               │
│     ↓                                │
│  4. 运行所有测试确保不破坏现有功能       │
│     ↓                                │
│  5. 提交代码，等待用户确认              │
└─────────────────────────────────────┘
```

#### 步骤3.1：编写测试（Red）

**Domain层测试示例**：
```python
# tests/unit/domain/entities/test_workflow.py
import pytest
from src.domain.entities.workflow import Workflow
from src.domain.exceptions import DomainError

def test_create_workflow_with_valid_name_should_succeed():
    """测试：使用有效名称创建Workflow应该成功"""
    workflow = Workflow.create(name="测试工作流", description="描述")

    assert workflow.id is not None
    assert workflow.name == "测试工作流"
    assert workflow.description == "描述"

def test_create_workflow_without_name_should_raise_error():
    """测试：创建Workflow时缺少name应该抛出DomainError"""
    with pytest.raises(DomainError, match="name不能为空"):
        Workflow.create(name="", description="描述")
```

**先运行测试，确认失败**：
```bash
pytest tests/unit/domain/entities/test_workflow.py -v
# 预期：FAILED（因为Workflow.create未实现）
```

#### 步骤3.2：实现功能（Green）

```python
# src/domain/entities/workflow.py
from dataclasses import dataclass
from datetime import datetime
from src.domain.exceptions import DomainError
from src.domain.value_objects import generate_id

@dataclass
class Workflow:
    id: str
    name: str
    description: str | None
    created_at: datetime

    @staticmethod
    def create(name: str, description: str | None = None) -> "Workflow":
        """创建Workflow"""
        if not name or not name.strip():
            raise DomainError("name不能为空")

        return Workflow(
            id=generate_id(),
            name=name.strip(),
            description=description,
            created_at=datetime.now()
        )
```

**再次运行测试，确认通过**：
```bash
pytest tests/unit/domain/entities/test_workflow.py -v
# 预期：PASSED
```

#### 步骤3.3：重构（Refactor）

检查代码是否可以优化：
- 是否有重复代码？
- 命名是否清晰？
- 是否符合开发规范？

**重构后再次运行测试**：
```bash
pytest tests/unit/domain/entities/test_workflow.py -v
# 确保重构没有破坏功能
```

#### 步骤3.4：更新TODO状态

```python
# 使用TodoWrite工具
todos = [
    {"content": "编写Domain层Workflow实体测试", "status": "completed", "activeForm": "..."},
    {"content": "实现Workflow实体", "status": "completed", "activeForm": "..."},
    {"content": "定义WorkflowRepository端口", "status": "in_progress", "activeForm": "..."},
    ...
]
```

#### 步骤3.5：等待用户确认

```
✅ 已完成：
- Workflow实体创建功能
- 测试通过（2/2）

📁 修改的文件：
- src/domain/entities/workflow.py
- tests/unit/domain/entities/test_workflow.py

是否继续下一步（定义WorkflowRepository端口）？
```

---

### 阶段4：逐层实现

#### 层级1：Domain层（纯业务逻辑）
- ✅ 已完成Workflow实体
- ❌ **禁止**导入SQLAlchemy、FastAPI、LangChain

#### 层级2：Ports层（接口定义）
```python
# src/domain/ports/workflow_repository.py
from typing import Protocol
from src.domain.entities.workflow import Workflow

class WorkflowRepository(Protocol):
    """Workflow仓储接口"""

    def save(self, workflow: Workflow) -> None:
        """保存Workflow"""
        ...

    def find_by_id(self, workflow_id: str) -> Workflow | None:
        """根据ID查找Workflow"""
        ...
```

#### 层级3：Infrastructure层（实现）
```python
# src/infrastructure/database/repositories/workflow_repository.py
from sqlalchemy.orm import Session
from src.domain.entities.workflow import Workflow
from src.domain.ports.workflow_repository import WorkflowRepository
from src.infrastructure.database.models.workflow import WorkflowModel

class SQLAlchemyWorkflowRepository(WorkflowRepository):
    def __init__(self, session: Session):
        self.session = session

    def save(self, workflow: Workflow) -> None:
        model = WorkflowModel(
            id=workflow.id,
            name=workflow.name,
            description=workflow.description,
            created_at=workflow.created_at
        )
        self.session.add(model)
        self.session.commit()

    def find_by_id(self, workflow_id: str) -> Workflow | None:
        model = self.session.get(WorkflowModel, workflow_id)
        if model is None:
            return None

        return Workflow(
            id=model.id,
            name=model.name,
            description=model.description,
            created_at=model.created_at
        )
```

#### 层级4：Application层（用例编排）
```python
# src/application/use_cases/create_workflow_use_case.py
from dataclasses import dataclass
from src.domain.entities.workflow import Workflow
from src.domain.ports.workflow_repository import WorkflowRepository

@dataclass
class CreateWorkflowInput:
    name: str
    description: str | None = None

class CreateWorkflowUseCase:
    def __init__(self, workflow_repository: WorkflowRepository):
        self.workflow_repository = workflow_repository

    def execute(self, input_data: CreateWorkflowInput) -> Workflow:
        # 1. 创建Domain实体
        workflow = Workflow.create(
            name=input_data.name,
            description=input_data.description
        )

        # 2. 持久化
        self.workflow_repository.save(workflow)

        return workflow
```

#### 层级5：Interface层（API）
```python
# src/interfaces/api/routes/workflows.py
from fastapi import APIRouter, Depends
from src.application.use_cases.create_workflow_use_case import (
    CreateWorkflowUseCase,
    CreateWorkflowInput
)
from src.interfaces.api.dto.workflow_dto import (
    CreateWorkflowRequest,
    WorkflowResponse
)
from src.interfaces.api.dependencies import get_workflow_repository

router = APIRouter()

@router.post("/", response_model=WorkflowResponse)
async def create_workflow(
    request: CreateWorkflowRequest,
    workflow_repo = Depends(get_workflow_repository)
):
    """创建Workflow"""
    use_case = CreateWorkflowUseCase(workflow_repository=workflow_repo)

    workflow = use_case.execute(CreateWorkflowInput(
        name=request.name,
        description=request.description
    ))

    return WorkflowResponse.from_entity(workflow)
```

---

### 阶段5：测试验证

#### 步骤5.1：单元测试（Domain + Application）
```bash
pytest tests/unit/ -v --cov=src/domain --cov=src/application
```

**覆盖率要求**：
- Domain层 ≥ 80%
- Application层 ≥ 70%

#### 步骤5.2：集成测试（Infrastructure）
```bash
pytest tests/integration/ -v
```

#### 步骤5.3：E2E测试（API）
```bash
pytest tests/e2e/ -v
```

#### 步骤5.4：报告测试结果
```
✅ 测试结果：
- 单元测试：15 passed
- 集成测试：8 passed
- E2E测试：5 passed
- 覆盖率：Domain 85%, Application 72%

所有测试通过！
```

---

### 阶段6：代码提交（如用户要求）

#### 步骤6.1：运行代码质量检查
```bash
# 格式化
ruff format .

# 类型检查
pyright src/

# Linting
ruff check .
```

#### 步骤6.2：准备提交信息
```
feat(workflow): 新增Workflow创建功能

- 新增Workflow实体（Domain层）
- 新增WorkflowRepository接口与实现
- 新增CreateWorkflowUseCase
- 新增POST /workflows API端点
- 测试覆盖率：Domain 85%, Application 72%
```

#### 步骤6.3：询问用户
```
代码已完成并通过所有测试。

是否创建Git提交？
[ ] 是的，请提交
[ ] 不，我想先检查代码
[ ] 稍后手动提交
```

---

## ⚠️ 常见错误与纠正

### 错误1：跳过测试直接实现
❌ **错误做法**：
```
1. 实现Workflow.create()
2. 补充测试
```

✅ **正确做法**：
```
1. 编写test_create_workflow()（失败）
2. 实现Workflow.create()（通过）
3. 重构
```

### 错误2：一次修改过多文件
❌ **错误做法**：
```
一次性创建：
- workflow.py
- workflow_repository.py
- workflow_repository_impl.py
- create_workflow_use_case.py
- workflows.py (API)
```

✅ **正确做法**：
```
第一步：workflow.py + test_workflow.py（等待确认）
第二步：workflow_repository.py（等待确认）
第三步：workflow_repository_impl.py + test（等待确认）
...
```

### 错误3：Domain层导入框架
❌ **错误做法**：
```python
# src/domain/entities/workflow.py
from sqlalchemy import Column, String  # ❌
```

✅ **正确做法**：
```python
# src/domain/entities/workflow.py
from dataclasses import dataclass  # ✅ 纯Python
```

---

## 📚 快速查询表

### 何时查阅哪个文档？

| 问题类型 | 查阅文档 |
|---------|---------|
| "一次能改几个文件？" | `.augment/rules/rule_name.md` |
| "如何命名UseCase？" | `docs/开发规范/00-总体开发规范.md` |
| "Python类型检查用什么工具？" | `docs/开发规范/01-后端开发规范.md` |
| "前端路由如何配置？" | `docs/开发规范/02-前端开发规范.md` |
| "Workflow是什么业务含义？" | `docs/需求分析.md` |
| "V2 Agent支持哪些功能？" | `docs/技术方案/03-Agent分阶段实施计划.md` |

---

## 🎯 总结：开发检查清单

每次开始新任务前，确认：

- [ ] 已查阅 `.augment/rules/rule_name.md`（行为规范）
- [ ] 已查阅相关开发规范文档
- [ ] 已创建TODO任务列表（TodoWrite工具）
- [ ] 已确认开发顺序（Domain → Ports → Infrastructure → Application → Interface）
- [ ] 已准备好编写失败测试（TDD Red阶段）

每次完成一个步骤后，确认：

- [ ] 已运行测试并通过
- [ ] 已更新TODO状态（completed）
- [ ] 已向用户报告进度
- [ ] 已等待用户确认再继续

---

> **文档更新**：
> 本文档应随项目演进持续更新。如发现流程不适用或缺失场景，及时补充。
