# 项目定位
- 新定位：企业内部中台系统（对外宣传企业级高可用/稳定；内部以渐进式实现，优先保证核心流程可用）

## 背景
- 学习型项目，控制复杂度，逐步演进

## 目标与原则
- 核心功能：用户输入“起点 + 目的”，一句话创建 Agent；创建后可调整 Agent 行为与参数
- 模式：以结果为导向，不限制过程
- 架构：模块化、可测试、易扩展，避免过度设计

# 技术栈建议（聚焦 Agent 中台）
## 后端
- Web/API：FastAPI + Pydantic v2（REST + SSE；可选 WebSocket）
- 领域与应用：DDD‑lite 分层；Ports & Adapters；Domain 不依赖框架
- 存储：PostgreSQL（生产）或 SQLite（开发）+ SQLAlchemy 2.0（Alembic 迁移）
- 执行与编排：LangChain（LCEL/Runnable/Agents），可选 LangGraph；轻量调度（asyncio + APScheduler）
- 稳定性：tenacity 重试、超时、幂等等价键、限流（简化实现）、健康检查
- 日志：structlog JSON + trace_id；统一错误码
- HTTP 客户端：httpx/aiohttp

## 前端
- 技术栈：Vite + React + TypeScript；Ant Design
- 数据：TanStack Query 管理远程状态；封装 useSSE/useAgent hooks
- 页面：Agent 列表与创建向导（start+goal）、Agent 配置编辑、运行历史与实时日志

## 开发工具
- 依赖：uv
- 质量：Ruff/Black、Pyright、pytest
- Git/CI：规范化提交、pre-commit、CI（lint + type + test）

* 注释
Java → Python 组件映射（常见替代）
Spring Boot → FastAPI
Maven/Gradle → uv/Poetry
Hibernate/JPA → SQLAlchemy/SQLModel
Quartz/Spring Scheduler → 内置执行器/APScheduler（可选 Prefect）
Feign/RestTemplate → httpx/requests（异步用 httpx/aiohttp）
MapStruct/DTO → Pydantic（数据模型与校验）
日志/链路 → structlog/loguru + OpenTelemetry


# 开发规范
- 架构：DDD-lite + 六边形（Ports & Adapters）+ 单体；对外宣传企业级能力，内部采取渐进式实现路线
- 开发模式：**TDD（测试驱动开发）+ DDD（领域驱动设计）**
  - TDD 流程：先编写测试用例 → 实现功能 → 通过测试验证需求覆盖
  - DDD + TDD 互补：DDD 定义"设计什么"（领域模型），TDD 定义"如何开发"（测试先行）
  - 实践：Domain 层纯逻辑易测试；Application 层通过 Ports 易 Mock；测试即业务用例文档
- 后端规范（摘要）：
  - Python 3.11+；uv；Ruff/Black；Pyright；pytest；pre-commit
  - 分层：interfaces/api → application → domain；infrastructure 作为适配器
  - API：FastAPI（Pydantic v2）；REST + SSE；统一错误码与异常映射
  - 数据：PostgreSQL/SQLite（事务/元数据、事件日志）；SQLAlchemy 2.0 + Alembic；事务仅在 App 层
  - 编排与执行：内置轻量执行器（asyncio + 队列/APScheduler），可替换 Prefect（可选）
  - 日志/配置/稳定性：structlog JSON；Pydantic Settings；重试/超时/幂等/限流/健康检查
- 前端规范（摘要）：
  - Vite + React + TypeScript；UI：Ant Design（或 Tailwind + Headless UI）
  - 数据：TanStack Query（REST）；EventSource（SSE）/WebSocket（流式消息）
  - 目录：src/pages、src/features、src/shared；组件 PascalCase，hooks 用 useXxx 命名
- 核心功能约束：
  - 用户必须提供“起点 start + 目的 goal”
  - 一句话创建 Agent，创建后可调整配置
  - 以结果为导向，不限制过程

详细规范见 docs/develop_document.md。


# 方案评估与设计决策

## 是否需要“通过对话构造工作流”？
- 非必要作为默认交互。默认采用：自动生成计划 + 少量澄清问答（仅在模型不确定时触发）。
- 何时使用对话式构造：
  - 目标复杂、信息不足或失败重试多次后；
  - 用户希望介入并指定关键步骤/约束；
  - 需要收集额外权限/凭证/验收标准。
- 理由：对话式构造流程会显著增加时延、成本与不确定性；在学习项目早期，性价比不高。
- 产出形态：优先线性计划（3–7 步），必要时微型 DAG；执行前可选“计划确认”。

## 当前模型智能是否足够？
- 可胜任的能力：
  - 从自然语言中结构化提取 start/goal/config（严格 JSON 模式）；
  - 生成轻量计划（步骤=工具+参数模板+期望输出/验收）；
  - 调用有限工具集（HTTP、SQL、脚本），并跟踪状态与日志；
  - 基于验收标准判断成功/失败并给出改进建议。
- 必要护栏：
  - 严格 JSON 输出 + schema 校验；工具白名单与参数校验；
  - 超时、重试（tenacity 指数退避）、幂等等价键（agent_id/run_id/step_no）；
  - 预算与早停（最大步数/时间/费用）；
  - 错误分层与统一错误码；SSE 实时事件流与结构化日志（trace_id）。
- 主要风险与缓解：
  - 幻觉/参数偏差 → 断言/验收标准/强 schema；
  - 长文本截断 → 分段、摘要、短上下文提示；
  - 外部依赖不稳定 → 重试+退避、幂等、回退策略。

## 开源（OS）Agent 实现方法对比
- ReAct + Tools
  - 优点：简单直观、实现快；
  - 缺点：稳定性一般、易走偏、难以回放与测试；
  - 适用：MVP 验证/少量工具。
- Plan-and-Execute（计划-执行-反思/重规划）
  - 优点：可控性更好，失败可重规划；
  - 缺点：时延与成本较高；
  - 适用：目标清晰但步骤不固定的单任务。
- 图/状态机编排（LangGraph/CrewAI 等）
  - 优点：流程显式、可测试、可观测、易并行；
  - 缺点：上手略重，建模成本更高；
  - 适用：需要条件/并行/回溯/循环的复杂任务。
- 多 Agent 协作（AutoGen/CrewAI 等）
  - 优点：复杂问题可分工与协作；
  - 缺点：协调复杂、成本高、难稳定；
  - 不建议作为起步方案。
- 本项目方案（LangChain：start+goal → 线性计划 → 执行 → 可调整配置）
  - 优势：生态成熟、实现快、易测、与小团队资源匹配、可逐步升级到 LangGraph；
  - 劣势：高级能力（复杂并行/回溯/多 Agent）需后续演进（考虑 LangGraph）。

## 改进建议与升级路径
- 澄清器（Clarifier）：当模型不确定时，最多 1–3 个关键问题补齐约束/验收标准。
- 验收标准（Acceptance Criteria）：为 goal 生成可验证标准，用断言/规则自动判定成败。
- 线性计划 + 小步重试：先线性，失败再重规划；限制重试上限 N。
- 人在回路（可选）：执行前展示计划供用户“确认/调整/禁用工具/设置预算”。
- 工具收敛：先支持 3–5 个稳定工具（HTTP、SQL、脚本）；参数白名单 + schema 校验。
- 安全网：幂等键、超时/重试/限流、健康检查、结构化日志 + trace_id、统一错误码。
- 升级路径：线性 → 条件/并行 → 简易图（LangGraph 思路） → 可视化编排器。

> 本项目遵循上述决策：默认自动计划 + 最小澄清；以线性执行器起步，必要时升级为图编排。

# 基本流程（重构：流程图 + 树形，逻辑保持不变）

说明：依据原有规则（数字=顺序，缩进=层级，* = 并行）对 123–213 行进行结构化重写；仅优化表达，不删除任何逻辑。



## 树形结构（重构版）
1. 发送消息[P0]
2. 上下文准备（并行）[P0]
   2.1 获取工具配置[P0]
   2.2 模型选择[P0] → 模型HA网关[P2]
   2.3 构建历史消息（顺序）[P0]
       2.3.1 获取活跃消息[P0]
       2.3.2 上下文策略[P0]
             - 若到达上限 → 二选一：
                 a) Token 滑动窗口[P0]
                 b) 摘要算法[P1]
   2.4 构建当前消息[P0]
   2.5 Clarifier（1–3 问，可选）[P1]
   2.6 生成验收标准（结果导向）[P1]
   2.7 生成计划（线性）[P0]
       2.7.1 小步重试（失败再重规划）[P1]
   2.8 人在回路（可选：计划确认/参数微调）[P1]

3. 选择传输方式[P0]
   - SSE[P0] / WebSocket[P1] （二选一）
4. 选择信息处理器[P0]
   - 基类处理器 → 5[P0]
   - Agent 处理器 → 5[P0]
   - RAG 处理器（流水线）→
       1) 用户消息 HyDE → 2) 向量化 → 3) 关键词/向量检索 → 4) RRF → 5) rerank → 6) 大模型过滤 → 跳至 10[P2]
5. 对话开始钩子[P1]
6. 判断账户余额是否足够[P1]
   - 否：结束[P1]
   - 是：进入 7[P1]
7. 用户处理钩子[P1]
8. 构建记忆[P1]
9. 判断是否携带工具[P1]
   - 否：跳至 10
   - 是：工具设置
       9.1 获取工具列表[P1] → 内置工具[P0] → SSE 工具
           - 全局工具：获取 SSE → MCP 网关[P2] → 设置工具预先参数[P1]
           - 非全局工具：获取 SSE → MCP 网关[P2] → 设置工具预先参数[P1]
10. 判断是否流式[P0]
    - 是（异步）：保存用户消息 → 处理异常（异常处理钩子）→ 处理对话完成（11/12/14）→ 处理工具消息（回复工具调用 → 工具调用钩子）
    - 否（同步）：保存用户消息 → 发消息给大模型 → 等待回复 → 11
11. 大模型回复钩子
12. 保存消息
13. 回复结束消息
14. 结果上报 → 模型HA网关
15. 计费
16. 对话完成钩子
17. 所有钩子均采集日志（装饰器增强，trace_id 贯穿）[P1]
    - 结构化日志+trace_id[P0]

# 功能优先级（基于“一句话创建工作流”）
* P0（MVP 核心闭环，默认即最佳实践）
  * 一句话创建工作流：输入 start+goal → 自动创建 Agent/Run（无需手动配置）
  * 线性计划生成（自动）与默认模板；失败返回基础错误，不阻塞执行
  * 上下文准备基础：工具配置加载、模型选择（单提供商）、历史构建、上下文裁剪（滑动窗口）
  * 流式主路径：SSE 默认（非流式和 WebSocket 均可延后）
  * 执行与持久化：保存用户消息 → 调用模型 → 保存回复 → 结束消息
  * 工具最小集：内置工具（HTTP、SQL、脚本）+ 参数 Schema 校验（白名单）
  * 结构化日志 + trace_id 贯穿；幂等等价键（run_id/step_no）
  * 基础异常捕获（不中断主流程；错误事件写入 SSE）
* P1（重要：稳定性/可用性/体验）
  * Clarifier（1–3 问，必要时触发）、验收标准生成（结果导向判定）、人在回路（计划确认/参数微调）
  * 非流式（同步）与 WebSocket 支持
  * 账户余额检查；用户处理钩子、对话开始/回复/完成钩子（空实现可落地为 P0）
  * 工具参数预配置；工具消息处理链（工具调用/回调钩子）
  * 稳定性基线：超时/重试、限流、健康检查；统一错误码
  * 结果上报与指标（执行数/成功率/时延/错误）
  * Model HA（客户端级回退/熔断/简单路由）
  * Memory 构建；配置界面（默认模板 + 少量可调整项）
* P2（增强：亮点/演进）
  * Model HA Gateway（服务化：SLO、A/B、缓存、多租户策略）
  * MCP Gateway；SSE 工具（全局/非全局）经 MCP 标准接入
  * RAG 全流水线（HyDE→向量→关键词/向量检索→RRF→rerank→LLM 过滤）
  * 计费/配额/多租户；高级编排（条件/并行、DAG、可视化编排器）
  * 高级策略：预算/早停、成本优化、多模型动态选择与学习路由

# 数据库分析

* 用户（User）
  * users：平台使用者信息
    * 基础信息：id(用户唯一标识),username(用户名，唯一),email(邮箱，唯一),password_hash(加密存储的密码)
    * 账户相关：balance(账户余额),quota(配额限制),role(用户角色)
    * 状态相关：status(账户状态，启用/禁用),is_verified(邮箱是否验证)
    * 时间相关：created_at(创建时间),updated_at(更新时间),last_login_at(最后登录时间),deleted_at(逻辑删除时间)

* Agent（智能体）
  * agents：AI智能体核心配置
    * 基础信息：id(Agent唯一标识),user_id(所属用户id，关联users),name(Agent名称),description(Agent描述)
    * 任务定义：start(任务起点描述),goal(任务目的描述)
    * 模型配置：provider_id(关联providers),model_id(关联models),model_config(模型参数配置JSON)
    * 上下文策略：context_strategy(上下文策略类型),context_config(上下文策略配置JSON),max_context_tokens(最大上下文token数)
    * 执行配置：max_steps(最大执行步数),max_time(最大执行时间秒),max_cost(最大执行成本),retry_config(重试配置JSON)
    * 状态相关：status(Agent状态，启用/禁用/归档),version(版本号)
    * 时间相关：created_at,updated_at,deleted_at

* 工具（Tool）
  * tools：Agent可调用的功能单元
    * 基础信息：id(工具唯一标识),user_id(所属用户id，null表示平台内置),name(工具名称),description(工具描述)
    * 功能定义：category(工具分类，HTTP/SQL/Script等),input_schema(输入参数JSON Schema),output_schema(输出参数JSON Schema)
    * 执行配置：executor_type(执行器类型，code/api/mcp),executor_config(执行器配置JSON),code(执行代码，可选),api_endpoint(API端点，可选)
    * 安全配置：is_global(是否全局工具),whitelist_params(参数白名单JSON),timeout(超时时间秒),rate_limit(速率限制)
    * 状态相关：is_official(是否官方工具),status(工具状态，启用/禁用),version(版本号)
    * 时间相关：created_at,updated_at,deleted_at

* 工作流（Workflow）
  * workflows：Agent执行计划与逻辑流程
    * 基础信息：id(工作流唯一标识),agent_id(关联agents),name(工作流名称),description(工作流描述)
    * 流程定义：workflow_type(工作流类型，linear/dag/graph),workflow_data(工作流结构化数据JSON)
    * 步骤配置：steps(执行步骤列表JSON),step_dependencies(步骤依赖关系JSON)
    * 验收标准：acceptance_criteria(验收标准列表JSON),validation_rules(验证规则JSON)
    * 版本管理：version(版本号),parent_workflow_id(父工作流id，用于版本追溯),is_active(是否当前活跃版本)
    * 状态相关：status(工作流状态，draft/active/archived)
    * 时间相关：created_at,updated_at,deleted_at

* 运行历史（RunHistory）
  * run_histories：Agent执行记录
    * 基础信息：id(运行唯一标识),run_id(运行业务id，用于幂等),agent_id(关联agents),workflow_id(关联workflows),user_id(触发用户id)
    * 执行信息：trace_id(链路追踪id),input_data(输入数据JSON),output_data(输出数据JSON),context_snapshot(执行时上下文快照JSON)
    * 状态追踪：status(执行状态，pending/running/success/failed/timeout),current_step(当前执行步骤),total_steps(总步骤数),error_code(错误码),error_message(错误信息)
    * 性能指标：start_time(开始时间),end_time(结束时间),duration_ms(执行时长毫秒),token_used(消耗token数),cost(执行成本)
    * 日志相关：execution_log(执行日志JSON数组),step_logs(步骤日志JSON数组),tool_calls(工具调用记录JSON数组)
    * 时间相关：created_at,updated_at

* 消息（Message）
  * messages：Agent与用户对话历史
    * 基础信息：id(消息唯一标识),session_id(所属会话id),agent_id(关联agents，可选),user_id(关联users),run_id(关联run_histories，可选)
    * 消息内容：role(消息角色，user/assistant/system/tool),message_type(消息类型，text/tool_call/tool_result),content(消息主要内容),metadata(消息元数据JSON)
    * 文件相关：file_urls(关联文件url列表JSON),attachments(附件信息JSON)
    * 大模型相关：provider(服务供应商),model(所使用模型),token_count(token数量),cost(消息成本)
    * 上下文相关：parent_message_id(父消息id，用于构建对话树),is_active(是否在活跃上下文中)
    * 时间相关：created_at(创建时间),updated_at(更新时间),deleted_at(逻辑删除时间)

* 会话（Session）
  * sessions：对话会话管理
    * 基础信息：id(会话唯一标识),user_id(关联users),agent_id(关联agents，可选),title(会话标题)
    * 上下文管理：context_id(关联context),message_count(消息数量),active_message_ids(活跃消息id列表JSON)
    * 统计信息：total_tokens(总token消耗),total_cost(总成本),last_message_at(最后消息时间)
    * 状态相关：status(会话状态，active/archived/deleted)
    * 时间相关：created_at,updated_at,deleted_at

* 上下文策略
  * context：上下文表，大模型对话可用消息
    * 基础信息：id，session_id，
    * 上下文策略相关：active_id(活跃消息id列表，用于控制对话上下文范围)，summary(历史消息摘要)
    * 时间相关：created_at,updated_at,deleted_at

* 大模型服务商
  * providers：服务商信息
    * 基础信息：id(服务商id标识),user_id(用户id非必填)
    * 服务相关：protocol(协议类型),name(服务商姓名),description(补充描述),config(敏感配置)
    * 状态相关：is_official(是否官方),status(服务商状态，控制启动关闭)
    * 时间相关：created_at,updated_at,deleted_at
  * models：大模型信息
    * 基础信息：id,user_id,provider_id(关联providers)
    * 模型相关：model_id(服务商提供的唯一id),name(大模型名字),model_endpoint(模型调用端点),description
    * 状态相关：is_official,type(大模型功能分类),status
    * 时间相关：created_at,updated_at,deleted_at
